# EDP管理后台权限管理系统设计文档

## 一、系统概述

本权限管理系统采用**基于角色的访问控制（RBAC）**设计，实现了从数据库到前端的完整权限管理方案。

## 二、角色权限分配表

### 2.1 角色定义

系统定义了5个角色，权限从高到低依次为：

| 角色代码 | 角色名称 | 说明 |
|---------|---------|------|
| ADMIN | 超级管理员 | 拥有系统所有权限，负责系统管理和配置 |
| STAFF | 教务人员 | 负责日常运营，包括课程、学员、报名等管理 |
| TEACHER | 教师 | 负责自己的课程和学员管理 |
| ADVISOR | 课程顾问 | 负责学员咨询和服务 |
| STUDENT | 学员 | 普通学员，只有基本查看权限 |

### 2.2 权限分配详表

#### ✅ 超级管理员（ADMIN）
**拥有所有权限**

- 首页概览 ✓
- 资讯管理 ✓（查看、创建、编辑、删除、发布）
- 校友生活 ✓（协会、活动的全部管理权限）
- 课程管理 ✓（课程、章节的全部管理权限）
- 用户管理 ✓（用户、顾问的全部管理权限）
- 企业管理 ✓（企业、学分、员工的全部管理权限）
- 报名管理 ✓（报名、申请、退课、赠送、签到、评价）
- 课件管理 ✓（查看、上传、删除）
- 数据统计 ✓（查看、导出）
- 系统设置 ✓（查看、修改、角色权限管理）
- 个人中心 ✓

#### ✅ 教务人员（STAFF）
**负责日常运营和管理**

- 首页概览 ✓
- 资讯管理 ✓（查看、创建、编辑、删除、发布）
- 校友生活 ✓（协会、活动的全部管理权限）
- 课程管理 ✓（查看、创建、编辑、发布课程，管理章节）
- 用户管理 ✓（查看、编辑用户，查看顾问，分配顾问）
- 企业管理 ✓（查看、编辑企业）
- 报名管理 ✓（全部权限）
- 课件管理 ✓（查看、上传、删除）
- 数据统计 ✓（查看）
- 个人中心 ✓

#### ✅ 教师（TEACHER）
**管理自己的课程和学员**

- 首页概览 ✓
- 课程管理 ✓（查看课程、查看章节）
- 用户管理 ✓（查看用户）
- 报名管理 ✓（查看报名、签到管理、评价管理）
- 课件管理 ✓（查看、上传）
- 数据统计 ✓（查看）
- 个人中心 ✓

#### ✅ 课程顾问（ADVISOR）
**负责学员咨询和服务**

- 首页概览 ✓
- 资讯管理 ✓（查看）
- 课程管理 ✓（查看）
- 用户管理 ✓（查看、编辑用户）
- 报名管理 ✓（查看报名）
- 数据统计 ✓（查看）
- 个人中心 ✓

#### ✅ 学员（STUDENT）
**基本查看权限**

- 首页概览 ✓
- 资讯管理 ✓（查看）
- 课程管理 ✓（查看）
- 个人中心 ✓

## 三、技术实现

### 3.1 数据库设计

#### Permission表（权限表）
```prisma
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique  // 权限代码，如：course:view
  name        String   // 权限名称
  description String?  // 权限描述
  module      String   // 所属模块
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  rolePermissions RolePermission[]
}
```

#### RolePermission表（角色权限关联表）
```prisma
model RolePermission {
  id           String     @id @default(uuid())
  role         UserRole   // 角色枚举
  permissionId String     // 权限ID
  createdAt    DateTime   @default(now())
  
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([role, permissionId])
}
```

### 3.2 后端实现

#### 权限服务（PermissionsService）
- `getRolePermissions(role)`: 获取指定角色的所有权限
- `getAllPermissions()`: 获取所有权限（按模块分组）
- `getAllRolePermissions()`: 获取所有角色及其权限

#### 认证服务（AuthService）
- `getProfile(userId)`: 获取用户信息时自动附带权限列表

### 3.3 前端实现

#### 权限配置（permissions.ts）
- `menuConfig`: 菜单配置（包含权限代码）
- `filterMenusByPermissions()`: 根据权限过滤菜单
- `hasPermission()`: 检查是否有指定权限
- `hasAnyPermission()`: 检查是否有任意一个权限
- `hasAllPermissions()`: 检查是否拥有所有权限

#### 权限指令（v-permission）
```vue
<!-- 单个权限 -->
<el-button v-permission="'user:create'">创建用户</el-button>

<!-- 多个权限（任意一个） -->
<el-button v-permission="['user:create', 'user:edit']">操作</el-button>
```

#### 布局组件（AdminLayout）
- 自动根据用户权限过滤和显示菜单
- 超级管理员显示所有菜单

## 四、权限代码规范

权限代码采用 `模块:操作` 的命名方式：

- `dashboard:view` - 查看首页
- `news:view` - 查看资讯
- `news:create` - 创建资讯
- `news:edit` - 编辑资讯
- `news:delete` - 删除资讯
- `users:view` - 查看用户
- `users:create` - 创建用户
- `courses:view` - 查看课程
- `enrollments:requests` - 报名申请审核
等

## 五、使用说明

### 5.1 初始化权限数据

```bash
# 进入后端目录
cd backend

# 运行权限种子数据
npx ts-node prisma/seeds/permissions.seed.ts

# 或运行完整种子数据（包含权限）
npx prisma db seed
```

### 5.2 页面按钮权限控制

在需要权限控制的按钮上使用 `v-permission` 指令：

```vue
<template>
  <div>
    <!-- 创建按钮 - 需要创建权限 -->
    <el-button v-permission="'news:create'" type="primary" @click="handleCreate">
      创建资讯
    </el-button>
    
    <!-- 编辑按钮 - 需要编辑权限 -->
    <el-button v-permission="'news:edit'" @click="handleEdit">
      编辑
    </el-button>
    
    <!-- 删除按钮 - 需要删除权限 -->
    <el-button v-permission="'news:delete'" type="danger" @click="handleDelete">
      删除
    </el-button>
  </div>
</template>
```

### 5.3 代码中检查权限

```typescript
import { useAuthStore } from '@/stores/auth'
import { hasPermission } from '@/config/permissions'

const authStore = useAuthStore()
const permissions = authStore.permissions

// 检查单个权限
if (hasPermission('news:create', permissions)) {
  // 有创建权限
}

// 检查多个权限（任意一个）
if (hasAnyPermission(['news:create', 'news:edit'], permissions)) {
  // 有创建或编辑权限
}
```

## 六、扩展说明

### 6.1 添加新权限

1. 在 `backend/prisma/seeds/permissions.seed.ts` 中添加权限定义
2. 在 `rolePermissions` 中为相应角色分配权限
3. 运行种子数据更新：`npx ts-node prisma/seeds/permissions.seed.ts`

### 6.2 修改角色权限

直接修改 `backend/prisma/seeds/permissions.seed.ts` 中的 `rolePermissions` 配置，然后重新运行种子数据。

### 6.3 前端菜单配置

修改 `admin-frontend/src/config/permissions.ts` 中的 `menuConfig`，为菜单项添加 `permission` 字段。

## 七、注意事项

1. **超级管理员特殊处理**：ADMIN 角色自动拥有所有权限，无需在数据库中配置
2. **个人中心无权限限制**：所有用户都可以访问个人中心
3. **权限检查顺序**：前端 → 后端，前端隐藏按钮，后端验证请求
4. **权限粒度**：建议按模块+操作设计，不宜过细
5. **数据权限**：当前实现的是功能权限，数据权限（如只能查看自己的数据）需要在业务逻辑中实现

## 八、测试账号

可以创建不同角色的测试账号来验证权限系统：

```typescript
// 管理员账号
{
  phone: '13800000001',
  password: '123456',
  role: 'ADMIN'
}

// 教务人员账号
{
  phone: '13800000002',
  password: '123456',
  role: 'STAFF'
}

// 教师账号
{
  phone: '13800000003',
  password: '123456',
  role: 'TEACHER'
}

// 课程顾问账号
{
  phone: '13800000004',
  password: '123456',
  role: 'ADVISOR'
}
```

## 九、常见问题

**Q: 为什么我修改了权限配置，前端菜单没有变化？**  
A: 需要重新登录，因为权限信息是在登录时获取并缓存的。

**Q: 如何为某个特定用户添加额外权限？**  
A: 当前系统基于角色权限，不支持单独为用户分配权限。如需此功能，需要扩展数据库设计添加用户权限表。

**Q: 后端API如何进行权限验证？**  
A: 可以创建权限守卫（PermissionGuard）或使用装饰器来验证权限，具体实现可参考现有的 RolesGuard。












