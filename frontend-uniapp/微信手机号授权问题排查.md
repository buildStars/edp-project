# 微信手机号授权问题排查与解决

## 📋 当前问题

**症状**：
- ✅ 微信登录成功
- ❌ 点击"获取手机号"按钮
- ❌ 没有任何弹窗显示
- ❌ 直接返回"用户拒绝授权"

**日志显示**：
```
servicewechat.com:1 获取手机号回调: {type: "getphonenumber", ...}
servicewechat.com:1 用户拒绝授权手机号
```

---

## 🔍 问题原因分析

### 原因1：小程序未开通"手机号快速验证"权限 ⭐⭐⭐⭐⭐

**最常见原因！**

微信小程序获取手机号功能需要**单独申请权限**。

#### 解决方法：

1. **登录微信小程序后台**
   - 网址：https://mp.weixin.qq.com
   - 使用管理员微信扫码登录

2. **进入功能管理**
   - 左侧菜单 → **开发** → **开发管理** → **接口设置**

3. **开通"手机号快速验证"**
   - 找到 **"手机号快速验证"**（或 "getPhoneNumber"）
   - 点击 **"开通"** 或 **"申请"**
   - 填写使用场景说明
   - 等待审核（通常1-3个工作日）

4. **查看当前AppID信息**
   - AppID: `wxa1db08fc86709ee2`
   - 在 **设置** → **开发设置** 查看

#### 权限类别

微信小程序有两种获取手机号的方式：

| 方式 | 权限名称 | 说明 |
|-----|---------|------|
| **方式1** | 手机号快速验证 | 新版接口，需要开通权限 |
| **方式2** | 手机号实时验证组件 | 付费组件，按次收费 |

**我们使用的是方式1（免费），需要开通权限。**

---

### 原因2：使用测试号或个人主体小程序

某些小程序类型可能无法使用手机号快速验证：

- ❌ **个人主体**小程序（部分功能受限）
- ❌ **未认证**的小程序
- ✅ **企业/组织主体**且**已认证**的小程序

#### 解决方法：

1. 查看小程序主体类型
   - 微信小程序后台 → **设置** → **主体信息**
   
2. 如果是个人主体
   - 需要升级为**企业主体**
   - 或使用**手动输入手机号**的方式

---

### 原因3：微信版本或基础库版本过低

#### 要求：
- **微信版本**: 7.0.9+
- **基础库版本**: 2.21.2+

#### 解决方法：

1. **检查基础库版本**
   - 微信开发者工具 → 详情 → 本地设置
   - 调试基础库版本选择 **2.21.2** 或更高

2. **设置最低版本要求**
   - 微信小程序后台 → **版本管理**
   - 设置最低基础库版本为 **2.21.2**

---

### 原因4：按钮配置问题

#### 检查按钮配置：

```vue
<!-- ✅ 正确配置 -->
<button 
  open-type="getPhoneNumber" 
  @getphonenumber="getPhoneNumber"
  class="bind-btn"
>
  微信授权获取手机号
</button>
```

**注意事项**：
- ✅ `open-type="getPhoneNumber"` (注意大小写)
- ✅ `@getphonenumber` (全小写，uni-app会自动转换)
- ✅ 必须是 `<button>` 标签，不能是 `<view>` 等其他组件
- ✅ 必须是用户主动点击触发

---

## 🔧 临时解决方案：手动输入手机号

在权限审核期间，可以使用手动输入方式：

### 1. 修改绑定手机页面

```vue
<template>
  <view class="page">
    <view class="container">
      <!-- 方式1: 微信授权（需要权限） -->
      <view class="section">
        <view class="section-title">方式一：微信快速授权</view>
        <button 
          open-type="getPhoneNumber" 
          @getphonenumber="getPhoneNumber"
          class="bind-btn"
        >
          <text class="btn-icon">📱</text>
          <text>微信授权获取手机号</text>
        </button>
        <view class="tips" v-if="!hasPhoneAuth">
          <text style="color: #FF9800;">⚠️ 当前小程序暂未开通此功能</text>
        </view>
      </view>
      
      <!-- 分隔线 -->
      <view class="divider">
        <text>或</text>
      </view>
      
      <!-- 方式2: 手动输入 + 验证码 -->
      <view class="section">
        <view class="section-title">方式二：手动输入</view>
        <view class="form-item">
          <input 
            v-model="phone" 
            type="number" 
            maxlength="11"
            placeholder="请输入手机号" 
            class="input"
          />
        </view>
        <view class="form-item code-item">
          <input 
            v-model="code" 
            type="number" 
            maxlength="6"
            placeholder="请输入验证码" 
            class="input"
          />
          <button 
            class="code-btn" 
            :disabled="codeCountdown > 0"
            @click="sendCode"
          >
            {{ codeCountdown > 0 ? `${codeCountdown}秒后重试` : '发送验证码' }}
          </button>
        </view>
        <button class="submit-btn" @click="bindPhoneManually">
          确认绑定
        </button>
      </view>
      
      <view class="skip" @click="handleSkip">
        <text>暂不绑定</text>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref } from 'vue'
import { useUserStore } from '@/store/user'
import { bindPhone, sendSmsCode, bindPhoneWithCode } from '@/api/user'

const userStore = useUserStore()

// 手机号授权是否可用（可以先设置为false，等权限开通后改为true）
const hasPhoneAuth = ref(false)

// 手动输入方式的数据
const phone = ref('')
const code = ref('')
const codeCountdown = ref(0)

// 微信授权获取手机号
const getPhoneNumber = async (e) => {
  console.log('获取手机号回调:', e)
  
  if (e.detail.errMsg === 'getPhoneNumber:ok') {
    try {
      uni.showLoading({ title: '绑定中...' })
      
      await bindPhone({
        code: e.detail.code
      })
      
      uni.showToast({
        title: '绑定成功',
        icon: 'success'
      })
      
      await userStore.fetchUserInfo()
      
      setTimeout(() => {
        uni.switchTab({
          url: '/pages/index/index'
        })
      }, 1500)
    } catch (error) {
      console.error('绑定失败：', error)
      uni.showToast({
        title: error.msg || '绑定失败，请使用手动输入方式',
        icon: 'none'
      })
    } finally {
      uni.hideLoading()
    }
  } else {
    console.log('用户拒绝授权或授权失败')
    uni.showToast({
      title: '请使用手动输入方式绑定',
      icon: 'none'
    })
  }
}

// 发送验证码
const sendCode = async () => {
  if (!phone.value || !/^1[3-9]\d{9}$/.test(phone.value)) {
    uni.showToast({
      title: '请输入正确的手机号',
      icon: 'none'
    })
    return
  }
  
  try {
    await sendSmsCode({ phone: phone.value })
    
    uni.showToast({
      title: '验证码已发送',
      icon: 'success'
    })
    
    // 开始倒计时
    codeCountdown.value = 60
    const timer = setInterval(() => {
      codeCountdown.value--
      if (codeCountdown.value <= 0) {
        clearInterval(timer)
      }
    }, 1000)
  } catch (error) {
    uni.showToast({
      title: error.msg || '发送失败',
      icon: 'none'
    })
  }
}

// 手动绑定手机号
const bindPhoneManually = async () => {
  if (!phone.value || !/^1[3-9]\d{9}$/.test(phone.value)) {
    uni.showToast({
      title: '请输入正确的手机号',
      icon: 'none'
    })
    return
  }
  
  if (!code.value || code.value.length !== 6) {
    uni.showToast({
      title: '请输入6位验证码',
      icon: 'none'
    })
    return
  }
  
  try {
    uni.showLoading({ title: '绑定中...' })
    
    await bindPhoneWithCode({
      phone: phone.value,
      code: code.value
    })
    
    uni.showToast({
      title: '绑定成功',
      icon: 'success'
    })
    
    await userStore.fetchUserInfo()
    
    setTimeout(() => {
      uni.switchTab({
        url: '/pages/index/index'
      })
    }, 1500)
  } catch (error) {
    uni.showToast({
      title: error.msg || '绑定失败',
      icon: 'none'
    })
  } finally {
    uni.hideLoading()
  }
}

// 跳过绑定
const handleSkip = () => {
  uni.showModal({
    title: '提示',
    content: '跳过绑定后将无法报名课程，确定要跳过吗？',
    success: (res) => {
      if (res.confirm) {
        uni.switchTab({
          url: '/pages/index/index'
        })
      }
    }
  })
}
</script>

<style lang="scss" scoped>
// ... 样式代码 ...
</style>
```

---

## 📝 后端需要添加的接口

### 1. 发送短信验证码

```typescript
// backend/src/modules/auth/auth.controller.ts

@Post('send-sms')
@Public()
@HttpCode(200)
@ApiOperation({ summary: '发送短信验证码' })
async sendSmsCode(@Body() body: { phone: string }) {
  return this.authService.sendSmsCode(body.phone);
}
```

### 2. 验证码绑定手机号

```typescript
@Post('bind-phone-with-code')
@UseGuards(JwtAuthGuard)
@HttpCode(200)
@ApiOperation({ summary: '通过验证码绑定手机号' })
async bindPhoneWithCode(
  @CurrentUser('id') userId: string,
  @Body() body: { phone: string; code: string }
) {
  return this.authService.bindPhoneWithCode(userId, body.phone, body.code);
}
```

---

## ✅ 推荐方案

### 短期方案（立即可用）
1. ✅ 使用**手动输入 + 短信验证码**方式
2. ✅ 不依赖微信权限，立即可用

### 长期方案（推荐）
1. ✅ 申请开通**"手机号快速验证"**权限
2. ✅ 等权限审核通过后，切换回微信授权方式
3. ✅ 两种方式同时保留，提供选择

---

## 🔍 验证权限是否开通

### 方法1：微信小程序后台查看
- 登录 https://mp.weixin.qq.com
- **开发** → **开发管理** → **接口设置**
- 查看 **"手机号快速验证"** 状态

### 方法2：真机测试
- 点击按钮后：
  - ✅ **有弹窗** = 权限已开通
  - ❌ **无弹窗直接返回拒绝** = 权限未开通

---

## 📞 联系方式

如需帮助申请权限或遇到其他问题，可以：

1. **微信公众平台客服**
   - 小程序后台右下角 → 客服支持

2. **微信开放社区**
   - https://developers.weixin.qq.com/community/

3. **检查小程序主体信息**
   - 确认是企业主体且已认证

---

## 📋 问题检查清单

- [ ] 小程序已认证（企业/组织主体）
- [ ] 已开通"手机号快速验证"权限
- [ ] 基础库版本 ≥ 2.21.2
- [ ] button 配置正确（open-type="getPhoneNumber"）
- [ ] 已在真机上测试（开发者工具可能无效）
- [ ] 域名已配置白名单（request合法域名）

---

**AppID**: `wxa1db08fc86709ee2`  
**创建时间**: 2025-11-11  
**更新时间**: 2025-11-11

