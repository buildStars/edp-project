import{r as e,z as a,o as t,c as l,w as s,m as r,i as n,d as u,e as i,h as o,j as c,F as d,k as v,f,C as g,D as _,N as m,q as S,aa as p,T as y,v as E,t as h,l as R}from"./index-CCW0MaS3.js";import{a as C,g as k,m as D,c as I}from"./notification.D-9-SvT9.js";import{I as T}from"./icon.Br2I0aeN.js";import{E as w}from"./empty-view.CjXDJwW7.js";import{_ as b}from"./_plugin-vue_export-helper.BCo6x5W8.js";/* empty css                                                                   */const A=b({__name:"messages",setup(b){const A=[{label:"全部",value:"all"},{label:"未读",value:"unread"},{label:"已读",value:"read"}],M=e("all"),N=e([]),U=e(1),$=e(20),x=e(0),O=e(!1),j=e(!1),L=e(0),Y=a((()=>N.value.length<x.value)),z=async()=>{if(!O.value){O.value=!0;try{const e={page:U.value,pageSize:$.value};"unread"===M.value?e.isRead=!1:"read"===M.value&&(e.isRead=!0);const a=await C(e);1===U.value?N.value=a.items||[]:N.value=[...N.value,...a.items||[]],x.value=a.total||0}catch(e){console.error("获取消息列表失败：",e),r({title:e.msg||"获取失败",icon:"none"})}finally{O.value=!1,j.value=!1}}},F=async()=>{try{const e=await k();L.value=e.count||0}catch(e){console.error("获取未读数量失败：",e)}},H=()=>{j.value=!0,U.value=1,N.value=[],z(),F()},P=()=>{j.value=!1},V=()=>{Y.value&&!O.value&&(U.value++,z())},K=async()=>{try{g({title:"处理中..."}),await D({isRead:!0}),L.value=0,"unread"===M.value?(N.value=[],x.value=0):N.value.forEach((e=>{e.isRead=!0,e.readAt=(new Date).toISOString()})),F(),r({title:"已全部标记为已读",icon:"success"})}catch(e){console.error("标记失败：",e),r({title:e.msg||"操作失败",icon:"none"})}finally{_()}},W=async()=>{m({title:"确认清空",content:"确定要清空所有已读消息吗？",success:async e=>{if(e.confirm)try{g({title:"清空中..."}),await I(),U.value=1,N.value=[],z(),r({title:"清空成功",icon:"success"})}catch(a){console.error("清空失败：",a),r({title:a.msg||"清空失败",icon:"none"})}finally{_()}}})},X=e=>{if(!e)return"";const a=new Date(e),t=new Date,l=t-a;if(l<6e4)return"刚刚";if(l<36e5)return`${Math.floor(l/6e4)}分钟前`;if(a.toDateString()===t.toDateString()){return`今天 ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}const s=new Date(t);if(s.setDate(s.getDate()-1),a.toDateString()===s.toDateString()){return`昨天 ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}if(a.getFullYear()===t.getFullYear()){return`${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`}return`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`},q=e=>({NEWS_UPDATE:"#1890ff",ACTIVITY_REMIND:"#52c41a",COURSE_CHECKIN:"#722ed1",ENROLLMENT_AUDIT:"#faad14",COURSE_EVALUATE:"#eb2f96",CREDIT_EXPIRE:"#f5222d",SYSTEM:"#666"}[e]||"#666");return t((()=>{z(),F()})),(e,a)=>{const t=n,r=S,g=p,_=y;return u(),l(t,{class:"page"},{default:s((()=>[i(t,{class:"filter-bar"},{default:s((()=>[(u(),o(d,null,c(A,(e=>i(t,{key:e.value,class:E(["filter-item",{active:M.value===e.value}]),onClick:a=>(e=>{M.value!==e&&(M.value=e,U.value=1,N.value=[],z())})(e.value)},{default:s((()=>[v(h(e.label)+" ",1),"unread"===e.value&&L.value>0?(u(),l(t,{key:0,class:"badge"},{default:s((()=>[v(h(L.value>99?"99+":L.value),1)])),_:1})):f("",!0)])),_:2},1032,["class","onClick"]))),64))])),_:1}),i(g,{"scroll-y":"",class:"message-list",onScrolltolower:V,"refresher-enabled":"","refresher-triggered":j.value,onRefresherpulling:H,onRefresherrefresh:H,onRefresherrestore:P},{default:s((()=>[N.value.length>0?(u(),l(t,{key:0},{default:s((()=>[(u(!0),o(d,null,c(N.value,(e=>(u(),l(t,{key:e.id,class:E(["message-item",{unread:!e.isRead}]),onClick:a=>(async e=>{if(!e.isRead)try{if(await D({ids:[e.id],isRead:!0}),e.isRead=!0,e.readAt=(new Date).toISOString(),L.value=Math.max(0,L.value-1),"unread"===M.value){const a=N.value.findIndex((a=>a.id===e.id));a>-1&&(N.value.splice(a,1),x.value=Math.max(0,x.value-1))}}catch(a){console.error("标记已读失败：",a)}if(e.data){if(e.data.link)return void R({url:e.data.link});if(e.data.url)return void R({url:e.data.url});if("COURSE_CHECKIN"===e.type&&e.data.courseId){const a=`/pages/course/detail?id=${e.data.courseId}&action=checkin`;return void R({url:a})}}m({title:e.title,content:e.content,showCancel:!1,confirmText:"知道了"})})(e)},{default:s((()=>[i(t,{class:"message-icon"},{default:s((()=>{return[i(T,{name:(a=e.type,{NEWS_UPDATE:"message",ACTIVITY_REMIND:"time",COURSE_CHECKIN:"course",ENROLLMENT_AUDIT:"check",COURSE_EVALUATE:"star",CREDIT_EXPIRE:"time",SYSTEM:"message"}[a]||"message"),size:48,color:q(e.type)},null,8,["name","color"])];var a})),_:2},1024),i(t,{class:"message-content"},{default:s((()=>[i(t,{class:"message-header"},{default:s((()=>[i(r,{class:"message-title"},{default:s((()=>[v(h(e.title),1)])),_:2},1024),i(r,{class:"message-time"},{default:s((()=>[v(h(X(e.createdAt)),1)])),_:2},1024)])),_:2},1024),i(t,{class:"message-body"},{default:s((()=>[v(h(e.content),1)])),_:2},1024),e.isRead?f("",!0):(u(),l(t,{key:0,class:"unread-dot"}))])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})):(u(),l(w,{key:1,text:"unread"===M.value?"暂无未读消息":"暂无消息"},null,8,["text"])),Y.value&&N.value.length>0?(u(),l(t,{key:2,class:"load-more"},{default:s((()=>[i(r,null,{default:s((()=>[v("加载中...")])),_:1})])),_:1})):!Y.value&&N.value.length>0?(u(),l(t,{key:3,class:"load-more"},{default:s((()=>[i(r,null,{default:s((()=>[v("没有更多了")])),_:1})])),_:1})):f("",!0)])),_:1},8,["refresher-triggered"]),N.value.length>0?(u(),l(t,{key:0,class:"action-bar"},{default:s((()=>[i(_,{class:"action-btn",onClick:K},{default:s((()=>[i(T,{name:"check",size:32,color:"#666"}),i(r,null,{default:s((()=>[v("全部已读")])),_:1})])),_:1}),"unread"!==M.value?(u(),l(_,{key:0,class:"action-btn",onClick:W},{default:s((()=>[i(T,{name:"delete",size:32,color:"#666"}),i(r,null,{default:s((()=>[v("清空已读")])),_:1})])),_:1})):f("",!0)])),_:1})):f("",!0)])),_:1})}}},[["__scopeId","data-v-bdf39733"]]);export{A as default};
