# å­¦åˆ†ç³»ç»Ÿç®€åŒ–æ–¹æ¡ˆ

## ğŸ¯ éœ€æ±‚è¯´æ˜

### åŸå§‹éœ€æ±‚
- **åªæœ‰ä¸€ç§å­¦åˆ†**ï¼šä¸åˆ†ä¼ä¸šå­¦åˆ†å’Œä¸ªäººå­¦åˆ†ï¼Œç»Ÿä¸€ä¸ºä¸€ä¸ªå­¦åˆ†ä½™é¢
- **å­¦åˆ†å±æ€§åŒºåˆ†**ï¼š
  - **å¯è½¬èµ å­¦åˆ†**ï¼šç®¡ç†å‘˜å……å€¼ã€è¯¾ç¨‹å¥–åŠ±è·å¾—çš„å­¦åˆ†ï¼Œå¯ä»¥èµ é€ç»™å…¶ä»–ç”¨æˆ·
  - **é”å®šå­¦åˆ†**ï¼šä¼ä¸šç®¡ç†å‘˜åˆ†é…ç»™ä¼ä¸šç”¨æˆ·çš„å­¦åˆ†ï¼Œä¸å¯è½¬èµ ï¼Œåªèƒ½ç”¨äºè´­ä¹°è¯¾ç¨‹

### æ ¸å¿ƒé€»è¾‘
1. **å­¦åˆ†ä½™é¢ç»Ÿä¸€**ï¼š`balance` = å¯è½¬èµ å­¦åˆ† + é”å®šå­¦åˆ†
2. **æ¶ˆè´¹ä¼˜å…ˆçº§**ï¼šæŠ¥åè¯¾ç¨‹æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼ˆä¼ä¸šåˆ†é…çš„ï¼‰ï¼Œä¸è¶³æ—¶ä½¿ç”¨å¯è½¬èµ å­¦åˆ†
3. **è½¬èµ é™åˆ¶**ï¼šåªèƒ½è½¬èµ å¯è½¬èµ å­¦åˆ†ï¼Œé”å®šå­¦åˆ†ä¸å¯è½¬èµ 

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### Credit è¡¨ç»“æ„ï¼ˆæ–°è®¾è®¡ï¼‰

```prisma
model Credit {
  id                  String   @id @default(uuid())
  userId              String   @unique
  balance             Int      @default(0)  // å½“å‰å­¦åˆ†ä½™é¢ï¼ˆç»Ÿä¸€ä½™é¢ï¼‰
  total               Int      @default(0)  // ç´¯è®¡è·å¾—å­¦åˆ†ï¼ˆç»Ÿä¸€æ€»æ•°ï¼‰
  used                Int      @default(0)  // ç´¯è®¡æ¶ˆè€—å­¦åˆ†ï¼ˆç»Ÿä¸€æ¶ˆè€—ï¼‰
  
  // å­¦åˆ†æ¥æºç»Ÿè®¡ï¼ˆç”¨äºåˆ¤æ–­å¯è½¬èµ é¢åº¦ï¼‰
  transferableBalance Int      @default(0)  // å¯è½¬èµ å­¦åˆ†ä½™é¢ï¼ˆä¸ªäººå­¦åˆ†ï¼‰
  lockedBalance       Int      @default(0)  // é”å®šå­¦åˆ†ä½™é¢ï¼ˆä¼ä¸šå­¦åˆ†ï¼Œä¸å¯è½¬èµ ï¼‰
  
  // å…³ç³»ï¼šbalance = transferableBalance + lockedBalance
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id])
  records             CreditRecord[]
}
```

### CreditRecordType æšä¸¾ï¼ˆæ–°å¢ï¼‰

```prisma
enum CreditRecordType {
  EARN             // è·å¾—å­¦åˆ†ï¼ˆè¯¾ç¨‹å®Œæˆå¥–åŠ±ï¼‰- å¯è½¬èµ 
  CONSUME          // æ¶ˆè€—å­¦åˆ†ï¼ˆæŠ¥åè¯¾ç¨‹ï¼‰
  REFUND           // é€€å›å­¦åˆ†ï¼ˆé€€è¯¾ï¼‰
  ADMIN_ADD        // ç®¡ç†å‘˜å¢åŠ  - å¯è½¬èµ 
  ADMIN_DEDUCT     // ç®¡ç†å‘˜æ‰£é™¤
  CORPORATE_ALLOCATE  // ä¼ä¸šåˆ†é… - é”å®šå­¦åˆ†
  TRANSFER_OUT     // è½¬å‡ºå­¦åˆ†ï¼ˆèµ é€ç»™ä»–äººï¼‰
  TRANSFER_IN      // è½¬å…¥å­¦åˆ†ï¼ˆæ¥æ”¶ä»–äººèµ é€ï¼‰
}
```

### CreditSource æšä¸¾ï¼ˆä¿æŒä¸å˜ï¼‰

```prisma
enum CreditSource {
  PERSONAL    // ä¸ªäººå­¦åˆ†ï¼ˆå¯è½¬èµ ï¼‰
  CORPORATE   // ä¼ä¸šå­¦åˆ†ï¼ˆé”å®šï¼‰
}
```

## ğŸ”„ è¿ç§»ç­–ç•¥

### SQL è¿ç§»è„šæœ¬

```sql
-- 1. æ·»åŠ æ–°å­—æ®µ
ALTER TABLE `credits` 
ADD COLUMN `transferableBalance` INT NOT NULL DEFAULT 0 COMMENT 'å¯è½¬èµ å­¦åˆ†ä½™é¢',
ADD COLUMN `lockedBalance` INT NOT NULL DEFAULT 0 COMMENT 'é”å®šå­¦åˆ†ä½™é¢';

-- 2. è¿ç§»ç°æœ‰æ•°æ®
-- å°†åŸæ¥çš„ balance è®¾ä¸ºå¯è½¬èµ å­¦åˆ†
-- å°†åŸæ¥çš„ corporateBalance è®¾ä¸ºé”å®šå­¦åˆ†
UPDATE `credits` 
SET 
  `balance` = `balance` + COALESCE(`corporateBalance`, 0),
  `transferableBalance` = `balance`,
  `lockedBalance` = COALESCE(`corporateBalance`, 0),
  `total` = `total` + COALESCE(`corporateTotal`, 0)
WHERE TRUE;

-- 3. éªŒè¯æ•°æ®ï¼ˆå¯é€‰ï¼‰
SELECT 
  userId,
  balance,
  transferableBalance,
  lockedBalance,
  (transferableBalance + lockedBalance) as calculated_balance
FROM `credits`
WHERE balance != (transferableBalance + lockedBalance);

-- 4. åˆ é™¤æ—§å­—æ®µï¼ˆå»ºè®®å…ˆå¤‡ä»½ï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´åå†åˆ é™¤ï¼‰
-- ALTER TABLE `credits` 
-- DROP COLUMN `corporateBalance`,
-- DROP COLUMN `corporateTotal`,
-- DROP COLUMN `corporateUsed`;
```

## ğŸ’» åç«¯å®ç°

### 1. å­¦åˆ†æ¶ˆè€—ï¼ˆä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼‰

```typescript
async consumeCredit(userId: string, courseId: string, courseName: string, amount: number) {
  const credit = await this.prisma.credit.findUnique({ where: { userId } });
  
  if (credit.balance < amount) {
    throw new BadRequestException(`å­¦åˆ†ä¸è¶³ï¼Œå½“å‰ä½™é¢: ${credit.balance}ï¼Œéœ€è¦: ${amount}`);
  }
  
  // è®¡ç®—æ‰£é™¤æ–¹æ¡ˆï¼šä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†
  const lockedUsed = Math.min(credit.lockedBalance, amount);
  const transferableUsed = amount - lockedUsed;
  
  await this.prisma.$transaction(async (tx) => {
    // æ›´æ–°å­¦åˆ†è´¦æˆ·
    await tx.credit.update({
      where: { id: credit.id },
      data: {
        balance: credit.balance - amount,
        used: credit.used + amount,
        lockedBalance: credit.lockedBalance - lockedUsed,
        transferableBalance: credit.transferableBalance - transferableUsed,
      },
    });
    
    // åˆ›å»ºæ¶ˆè€—è®°å½•
    await tx.creditRecord.create({
      data: {
        creditId: credit.id,
        type: 'CONSUME',
        amount: -amount,
        balance: credit.balance - amount,
        source: lockedUsed > 0 ? 'CORPORATE' : 'PERSONAL',
        courseId,
        courseName,
        remark: `æŠ¥åè¯¾ç¨‹ã€Š${courseName}ã€‹ï¼ˆé”å®š${lockedUsed}+å¯è½¬èµ ${transferableUsed}ï¼‰`,
      },
    });
  });
}
```

### 2. å¢åŠ å­¦åˆ†ï¼ˆåŒºåˆ†ç±»å‹ï¼‰

```typescript
async addCredit(
  userId: string, 
  amount: number, 
  remark: string,
  isLocked: boolean = false,  // æ˜¯å¦ä¸ºé”å®šå­¦åˆ†
  courseId?: string,
  courseName?: string
) {
  const credit = await this.prisma.credit.findUnique({ where: { userId } });
  
  await this.prisma.credit.update({
    where: { id: credit.id },
    data: {
      balance: credit.balance + amount,
      total: credit.total + amount,
      transferableBalance: isLocked ? credit.transferableBalance : credit.transferableBalance + amount,
      lockedBalance: isLocked ? credit.lockedBalance + amount : credit.lockedBalance,
    },
  });
  
  await this.prisma.creditRecord.create({
    data: {
      creditId: credit.id,
      type: isLocked ? 'CORPORATE_ALLOCATE' : (courseId ? 'EARN' : 'ADMIN_ADD'),
      amount,
      balance: credit.balance + amount,
      source: isLocked ? 'CORPORATE' : 'PERSONAL',
      courseId,
      courseName,
      remark,
    },
  });
}
```

### 3. ä¼ä¸šç®¡ç†å‘˜åˆ†é…å­¦åˆ†

```typescript
async allocateCredit(adminId: string, dto: AllocateCreditDto) {
  const { toUserId, amount } = dto;
  
  // éªŒè¯ä¼ä¸šç®¡ç†å‘˜èº«ä»½
  const organization = await this.validateCorpAdmin(adminId);
  await this.validateEmployeeBelongsToOrg(organization.id, toUserId);
  
  const adminCredit = await this.prisma.credit.findUnique({ where: { userId: adminId } });
  
  // åªèƒ½åˆ†é…ç®¡ç†å‘˜çš„å¯è½¬èµ å­¦åˆ†
  if (adminCredit.transferableBalance < amount) {
    throw new BadRequestException(`å¯è½¬èµ å­¦åˆ†ä¸è¶³ï¼Œå½“å‰: ${adminCredit.transferableBalance}ï¼Œéœ€è¦: ${amount}`);
  }
  
  await this.prisma.$transaction(async (tx) => {
    // æ‰£é™¤ç®¡ç†å‘˜çš„å¯è½¬èµ å­¦åˆ†
    await tx.credit.update({
      where: { userId: adminId },
      data: {
        balance: adminCredit.balance - amount,
        used: adminCredit.used + amount,
        transferableBalance: adminCredit.transferableBalance - amount,
      },
    });
    
    // å¢åŠ å‘˜å·¥çš„é”å®šå­¦åˆ†ï¼ˆä¸å¯è½¬èµ ï¼‰
    await tx.credit.update({
      where: { userId: toUserId },
      data: {
        balance: { increment: amount },
        total: { increment: amount },
        lockedBalance: { increment: amount },  // ä½œä¸ºé”å®šå­¦åˆ†
      },
    });
    
    // è®°å½•è½¬å‡ºå’Œè½¬å…¥
    await tx.creditRecord.createMany({
      data: [
        {
          creditId: adminCredit.id,
          type: 'TRANSFER_OUT',
          amount: -amount,
          balance: adminCredit.balance - amount,
          source: 'PERSONAL',
          fromUserId: adminId,
          toUserId,
          remark: `åˆ†é…${amount}å­¦åˆ†ç»™å‘˜å·¥ï¼ˆä¼ä¸šç®¡ç†å‘˜ï¼‰`,
        },
        {
          creditId: employeeCredit.id,
          type: 'CORPORATE_ALLOCATE',
          amount,
          balance: employeeCredit.balance + amount,
          source: 'CORPORATE',
          fromUserId: adminId,
          toUserId,
          remark: `æ”¶åˆ°ä¼ä¸šç®¡ç†å‘˜åˆ†é…çš„${amount}å­¦åˆ†ï¼ˆé”å®šï¼Œä¸å¯è½¬èµ ï¼‰`,
        },
      ],
    });
  });
}
```

### 4. è½¬èµ å­¦åˆ†ï¼ˆæ–°åŠŸèƒ½ï¼‰

```typescript
async transferCredit(fromUserId: string, toUserId: string, amount: number) {
  const fromCredit = await this.prisma.credit.findUnique({ where: { userId: fromUserId } });
  
  // åªèƒ½è½¬èµ å¯è½¬èµ å­¦åˆ†
  if (fromCredit.transferableBalance < amount) {
    throw new BadRequestException(`å¯è½¬èµ å­¦åˆ†ä¸è¶³ï¼Œå½“å‰: ${fromCredit.transferableBalance}ï¼Œéœ€è¦: ${amount}`);
  }
  
  await this.prisma.$transaction(async (tx) => {
    // æ‰£é™¤è½¬å‡ºæ–¹çš„å¯è½¬èµ å­¦åˆ†
    await tx.credit.update({
      where: { userId: fromUserId },
      data: {
        balance: fromCredit.balance - amount,
        transferableBalance: fromCredit.transferableBalance - amount,
      },
    });
    
    // å¢åŠ è½¬å…¥æ–¹çš„å¯è½¬èµ å­¦åˆ†
    await tx.credit.update({
      where: { userId: toUserId },
      data: {
        balance: { increment: amount },
        total: { increment: amount },
        transferableBalance: { increment: amount },  // è½¬èµ çš„å­¦åˆ†ä¹Ÿæ˜¯å¯è½¬èµ çš„
      },
    });
    
    // è®°å½•è½¬è´¦
    // ... åˆ›å»ºè½¬å‡ºå’Œè½¬å…¥è®°å½•
  });
}
```

## ğŸ¨ å‰ç«¯å±•ç¤º

### ä¸ªäººä¸­å¿ƒå­¦åˆ†æ˜¾ç¤º

```vue
<view class="credit-card">
  <!-- æ€»å­¦åˆ† -->
  <view class="credit-item">
    <Icon name="star" color="#FFD700" />
    <text class="label">æ€»å­¦åˆ†</text>
    <text class="value">{{ credit.balance }}</text>
  </view>
  
  <!-- å¯è½¬èµ å­¦åˆ† -->
  <view class="credit-item">
    <Icon name="user" color="#52C41A" />
    <text class="label">å¯è½¬èµ </text>
    <text class="value">{{ credit.transferableBalance }}</text>
  </view>
  
  <!-- é”å®šå­¦åˆ† -->
  <view class="credit-item">
    <Icon name="work" color="#FF6B6B" />
    <text class="label">é”å®šå­¦åˆ†</text>
    <text class="value">{{ credit.lockedBalance }}</text>
    <text class="tip">ä»…å¯è´­è¯¾</text>
  </view>
</view>
```

### æŠ¥åæ—¶çš„å­¦åˆ†æç¤º

```
æŠ¥åã€Šè¯¾ç¨‹åç§°ã€‹éœ€è¦ 5 å­¦åˆ†

æ‚¨çš„å­¦åˆ†ä½™é¢ï¼š10
- é”å®šå­¦åˆ†ï¼š3ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰
- å¯è½¬èµ å­¦åˆ†ï¼š7

å°†æ‰£é™¤ï¼š
- é”å®šå­¦åˆ†ï¼š3
- å¯è½¬èµ å­¦åˆ†ï¼š2
```

## ğŸ“ API æ¥å£å˜åŒ–

### è·å–å­¦åˆ†ä¿¡æ¯

**è¯·æ±‚**ï¼š`GET /api/credits/my`

**å“åº”**ï¼š
```json
{
  "id": "credit-id",
  "userId": "user-id",
  "balance": 444,              // æ€»ä½™é¢
  "total": 500,                // ç´¯è®¡è·å¾—
  "used": 56,                  // ç´¯è®¡æ¶ˆè€—
  "transferableBalance": 100,  // å¯è½¬èµ ä½™é¢
  "lockedBalance": 344,        // é”å®šä½™é¢ï¼ˆä¸å¯è½¬èµ ï¼‰
  "records": [...]
}
```

### è½¬èµ å­¦åˆ†ï¼ˆæ–°å¢ï¼‰

**è¯·æ±‚**ï¼š`POST /api/credits/transfer`

```json
{
  "toUserId": "user-id",
  "amount": 10
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "è½¬èµ æˆåŠŸ",
  "data": {
    "transferredAmount": 10,
    "remainingTransferable": 90
  }
}
```

## âœ… ä¼˜åŠ¿

1. **ç»Ÿä¸€ä½™é¢**ï¼šç”¨æˆ·åªçœ‹åˆ°ä¸€ä¸ªå­¦åˆ†æ•°å­—ï¼Œç®€å•ç›´è§‚
2. **çµæ´»æ§åˆ¶**ï¼šé€šè¿‡ `transferableBalance` å’Œ `lockedBalance` çµæ´»æ§åˆ¶å­¦åˆ†å±æ€§
3. **å…¼å®¹æ€§å¥½**ï¼šä¿ç•™åŸæœ‰å­—æ®µï¼Œå¯å¹³æ»‘è¿ç§»
4. **å®¡è®¡å®Œæ•´**ï¼šé€šè¿‡ `CreditRecord` è®°å½•æ¯ç¬”å­¦åˆ†çš„æ¥æºå’Œç”¨é€”
5. **æ‰©å±•æ€§å¼º**ï¼šæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ å…¶ä»–å­¦åˆ†ç±»å‹ï¼ˆå¦‚ç§¯åˆ†ã€åˆ¸ç­‰ï¼‰

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… æ›´æ–° Prisma Schema
2. âœ… åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
3. â³ æ›´æ–°åç«¯æœåŠ¡ä»£ç 
4. â³ æ›´æ–°å‰ç«¯æ˜¾ç¤º
5. â³ æµ‹è¯•éªŒè¯
6. â³ éƒ¨ç½²ä¸Šçº¿

ç”±äºç°åœ¨ç›´æ¥è¿è¡Œè¿ç§»æœ‰æƒé™é—®é¢˜ï¼Œå»ºè®®ï¼š
1. æ‰‹åŠ¨æ‰§è¡Œ SQL è¿ç§»è„šæœ¬
2. ç„¶åé‡æ–°ç”Ÿæˆ Prisma Client
3. æ›´æ–°åç«¯ä»£ç ä»¥é€‚é…æ–°ç»“æ„







