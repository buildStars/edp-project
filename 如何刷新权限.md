# 如何刷新用户权限

## 问题说明

当后端更新了权限配置后，已登录的用户仍然使用旧的 JWT Token，其中包含的权限信息是旧的，因此会出现 **403 Forbidden** 错误。

## 解决方案

### 方式1：退出重新登录（推荐）

1. 点击管理后台右上角头像
2. 选择"退出登录"
3. 使用相同账号重新登录
4. 系统会生成新的 Token，包含最新的权限配置

### 方式2：清除浏览器缓存（开发调试用）

在浏览器控制台（F12）执行：

```javascript
localStorage.clear();
location.reload();
```

### 方式3：后端使 Token 失效（生产环境）

如果需要强制所有用户刷新权限，可以：

1. 修改后端的 `JWT_SECRET` 环境变量
2. 重启后端服务
3. 所有旧 Token 将失效，用户需要重新登录

⚠️ **注意**：此方法会导致所有用户被强制登出！

## 本次更新内容

### 教师角色权限更新

✅ 已更新后端接口权限控制，教师现在可以：

| 功能 | 权限 |
|-----|------|
| **查看企业列表** | ✅ ADMIN, STAFF, TEACHER |
| **查看企业详情** | ✅ ADMIN, STAFF, TEACHER |
| **创建企业** | ✅ ADMIN, TEACHER |
| **编辑企业** | ✅ ADMIN, TEACHER |
| **删除企业** | ❌ 仅 ADMIN |
| **分配学分** | ✅ ADMIN, TEACHER |
| **查看企业员工** | ✅ ADMIN, STAFF, TEACHER |
| **添加企业员工** | ✅ ADMIN, TEACHER |
| **移除企业员工** | ✅ ADMIN, TEACHER |
| **查看企业统计** | ✅ ADMIN, STAFF, TEACHER |

### 更新的文件

1. **权限种子数据**
   - `backend/prisma/seeds/permissions.seed.ts`
   - 教师角色新增企业管理相关权限

2. **接口权限控制**
   - `backend/src/modules/organizations/organizations.controller.ts`
   - 各接口 `@Roles` 装饰器已添加 `TEACHER`

## 验证步骤

1. **退出登录** → 重新登录
2. 查看左侧菜单 → 应该显示"企业管理"
3. 进入企业管理页面 → 能正常加载列表
4. 点击"新增企业"按钮 → 应该可以创建企业

## 常见问题

### Q: 退出重新登录后还是 403？

A: 检查以下几点：
1. 确认后端服务已重启（如果修改了代码）
2. 确认权限种子数据已重新运行（`npm run prisma:seed`）
3. 查看浏览器控制台的 JWT Token 内容，确认包含新权限

### Q: 如何查看当前 Token 中的权限？

在浏览器控制台执行：

```javascript
const token = localStorage.getItem('token');
if (token) {
  const payload = JSON.parse(atob(token.split('.')[1]));
  console.log('当前角色:', payload.role);
  console.log('Token 过期时间:', new Date(payload.exp * 1000));
}
```

### Q: 多久需要重新登录一次？

默认 Token 有效期为 **7 天**，过期后会自动要求重新登录。

## 技术说明

### JWT Token 结构

```json
{
  "userId": "xxx",
  "role": "TEACHER",
  "permissions": ["courses:view", "organizations:view", ...],
  "iat": 1700000000,
  "exp": 1700604800
}
```

权限信息在用户登录时被编码到 Token 中，因此修改权限配置后，需要重新生成 Token（即重新登录）才能生效。

---

**最后更新：** 2025-11-16  
**相关文档：** [权限管理文档](./管理后台菜单权限表.md)











