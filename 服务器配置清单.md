 # 服务器配置清单说明文档

## 文档概述

本文档说明企业EDP（Executive Development Program）课程管理系统所需的服务器环境配置，包括测试服务器和生产服务器的详细规格、软件版本、部署架构等信息。

---

## 一、服务器清单总览

### 方案对比

| 环境类型 | 方案A（推荐-初期） | 方案B（高可用） | 说明 |
|---------|:------------------:|:--------------:|------|
| **测试环境** | 1台 | 1台 | 功能测试、压力测试 |
| **生产环境** | 1台（单机） | 2台（应用+数据库分离） | 根据业务规模选择 |

### 方案选择建议

| 业务阶段 | 推荐方案 | 用户规模 | 并发量 | 月成本 |
|---------|---------|---------|--------|--------|
| **初期上线** | 方案A（单服务器） | < 1000人 | < 100 | ¥600-1200 |
| **稳定运营** | 方案A（单服务器） | 1000-5000人 | 100-500 | ¥800-1500 |
| **快速增长** | 方案B（双服务器） | > 5000人 | > 500 | ¥2000-3600 |

**💡 建议：** 
- 初期上线建议使用**方案A（单服务器）**，成本低、维护简单
- 当用户量增长到 3000+ 或并发超过 300 时，再升级到方案B
- 单服务器方案完全能够满足大部分中小企业的需求

---

## 二、测试服务器配置方案

### 2.1 基础配置

| 配置项 | 规格 | 说明 |
|-------|------|------|
| **CPU** | 4核 (4 vCPU) | Intel Xeon 或同等性能 |
| **内存** | 8GB | DDR4 或以上 |
| **硬盘** | 100GB SSD | 系统盘 + 数据盘 |
| **带宽** | 5Mbps | 固定带宽或按量付费 |
| **操作系统** | Ubuntu 22.04 LTS 或 CentOS 7.9+ | 推荐 Ubuntu Server |
| **IP地址** | 1个公网IP | 固定IP或弹性IP |

### 2.2 软件环境

#### 2.2.1 运行时环境

| 软件 | 版本 | 说明 |
|------|------|------|
| **Node.js** | v18.x LTS 或 v20.x LTS | 推荐 v20.11.0+ |
| **npm** | v10.x+ | 随 Node.js 安装 |
| **PM2** | v5.x+ | 进程管理工具 |

#### 2.2.2 数据库

| 软件 | 版本 | 说明 |
|------|------|------|
| **PostgreSQL** | 15.x 或 16.x | 推荐 PostgreSQL 16 |
| **Redis** | 7.x | 用于缓存和Session |

#### 2.2.3 Web服务器

| 软件 | 版本 | 说明 |
|------|------|------|
| **Nginx** | 1.24.x+ | 反向代理 + 静态资源 |

#### 2.2.4 其他工具

| 软件 | 版本 | 说明 |
|------|------|------|
| **Git** | 2.x+ | 代码拉取 |
| **Docker** (可选) | 24.x+ | 容器化部署 |
| **Docker Compose** (可选) | 2.x+ | 容器编排 |

### 2.3 部署架构

```
┌─────────────────────────────────────────────────┐
│          测试服务器 (单机部署)                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌──────────────┐    ┌──────────────┐          │
│  │   Nginx      │───▶│  前端静态    │          │
│  │   (80/443)   │    │  资源        │          │
│  └──────┬───────┘    └──────────────┘          │
│         │                                       │
│         ├──▶ 后端API (Node.js + NestJS)        │
│         │    端口: 3000                         │
│         │                                       │
│         ├──▶ 管理后台前端                       │
│         │    端口: 3001 (开发) / Nginx (生产)   │
│         │                                       │
│         └──▶ 微信小程序后端 (同一后端)          │
│                                                 │
│  ┌──────────────────────────────────┐          │
│  │  PostgreSQL (5432)                │          │
│  │  - 主数据库                        │          │
│  └──────────────────────────────────┘          │
│                                                 │
│  ┌──────────────────────────────────┐          │
│  │  Redis (6379)                     │          │
│  │  - 缓存                            │          │
│  │  - Session                         │          │
│  └──────────────────────────────────┘          │
│                                                 │
│  ┌──────────────────────────────────┐          │
│  │  文件存储                          │          │
│  │  - /var/www/edp/uploads           │          │
│  │  - 用户头像、课程封面、课件等      │          │
│  └──────────────────────────────────┘          │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 2.4 目录结构

```
/var/www/edp/
├── backend/              # 后端应用
│   ├── dist/            # 编译后的代码
│   ├── node_modules/    # 依赖包
│   ├── uploads/         # 上传文件
│   ├── .env             # 环境配置
│   └── ecosystem.config.js  # PM2 配置
│
├── admin-frontend/      # 管理后台前端
│   └── dist/           # 构建后的静态文件
│
└── logs/               # 日志目录
    ├── nginx/
    ├── backend/
    └── pm2/
```

---

## 三、生产服务器配置方案

### 🌟 方案A：单服务器生产环境（推荐-初期上线）

#### 3.1 基础配置

| 配置项 | 规格 | 说明 |
|-------|------|------|
| **CPU** | 8核 (8 vCPU) | Intel Xeon 或同等性能 |
| **内存** | 16GB | DDR4 或以上 |
| **系统盘** | 100GB SSD | 高性能 SSD |
| **数据盘** | 500GB SSD | 存储数据库、上传文件、日志 |
| **带宽** | 10Mbps | 固定带宽 |
| **操作系统** | Ubuntu 22.04 LTS Server | 64位 |
| **IP地址** | 1个固定公网IP | 绑定域名 |

#### 3.2 软件环境

| 软件 | 版本 | 说明 |
|------|------|------|
| **Node.js** | v20.11.0+ LTS | 生产环境推荐 LTS 版本 |
| **npm** | v10.2.0+ | 包管理器 |
| **PM2** | v5.3.0+ | 进程守护（Cluster模式） |
| **Nginx** | 1.24.x+ | 反向代理 + SSL |
| **PostgreSQL** | 16.x | 主数据库 |
| **Redis** | 7.2.x | 缓存 + Session |
| **Git** | 2.x+ | 代码部署 |
| **Certbot** | latest | Let's Encrypt SSL证书 |

#### 3.3 单服务器部署架构

```
┌─────────────────────────────────────────────────────────┐
│        生产服务器（单机部署 - All-in-One）                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │  Nginx (80/443) + SSL                      │        │
│  │  - 反向代理                                 │        │
│  │  - 静态资源服务                             │        │
│  │  - HTTPS 加密                               │        │
│  │  - Gzip 压缩                                │        │
│  └──────┬─────────────────────────────────────┘        │
│         │                                               │
│         ├──▶ 后端 API (PM2 Cluster Mode)               │
│         │    └─ Node.js Instance 1 (3000)              │
│         │    └─ Node.js Instance 2 (3001)              │
│         │    └─ Node.js Instance 3 (3002)              │
│         │    └─ Node.js Instance 4 (3003)              │
│         │                                               │
│         ├──▶ 管理后台 (静态文件)                        │
│         │                                               │
│         └──▶ 小程序后端 (同一 API)                      │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │  PostgreSQL (5432)                         │        │
│  │  - 本地访问 (127.0.0.1)                    │        │
│  │  - 禁止外网访问                             │        │
│  │  - 自动备份                                 │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │  Redis (6379)                              │        │
│  │  - 本地访问 (127.0.0.1)                    │        │
│  │  - 持久化开启                               │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │  文件存储 (500GB 数据盘)                   │        │
│  │  /data/edp/                                │        │
│  │  ├── uploads/        (用户上传文件)         │        │
│  │  ├── database/       (数据库数据)           │        │
│  │  ├── logs/           (日志文件)             │        │
│  │  └── backups/        (数据库备份)           │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  定期备份到云端对象存储 (OSS) ───────────────▶ 云端    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3.4 目录结构

```
/data/edp/
├── app/                    # 应用程序
│   ├── backend/           # 后端应用
│   │   ├── dist/         # 编译后的代码
│   │   ├── .env          # 环境配置
│   │   └── ecosystem.config.js  # PM2配置
│   └── admin-frontend/    # 管理后台前端
│       └── dist/         # 构建后的静态文件
│
├── database/              # 数据库数据目录
│   └── postgresql/       # PostgreSQL 数据文件
│
├── uploads/              # 用户上传文件
│   ├── avatars/         # 用户头像
│   ├── covers/          # 课程封面
│   └── materials/       # 课件资料
│
├── backups/              # 备份文件
│   ├── db/              # 数据库备份
│   │   ├── daily/       # 每日备份
│   │   └── weekly/      # 每周备份
│   └── uploads/         # 文件备份
│
└── logs/                 # 日志文件
    ├── nginx/
    ├── backend/
    └── postgresql/
```

#### 3.5 单服务器优势

✅ **成本低**：只需一台服务器，月成本 ¥600-1200  
✅ **维护简单**：统一管理，减少运维复杂度  
✅ **部署快速**：无需配置服务器间通信  
✅ **性能充足**：8核16G完全满足中小规模业务  
✅ **易于升级**：后期可无缝升级到双服务器  

#### 3.6 性能指标（预估）

| 指标 | 数值 | 说明 |
|-----|------|------|
| **并发用户** | 500-1000 | 同时在线用户 |
| **API响应时间** | < 200ms | 95%请求 |
| **数据库查询** | < 50ms | 平均响应时间 |
| **文件上传** | 10MB/s | 上传速度 |
| **支持用户数** | 5000+ | 注册用户总数 |

#### 3.7 备份策略

| 备份类型 | 频率 | 保留时间 | 存储位置 |
|---------|------|---------|---------|
| **数据库完整备份** | 每天凌晨 3:00 | 30天 | 本地 + OSS |
| **数据库增量备份** | 每6小时 | 7天 | 本地 |
| **文件备份** | 每周 | 4周 | OSS |
| **配置文件备份** | 每次修改 | 永久 | Git仓库 |

#### 3.8 监控配置

```bash
# 推荐监控指标
- CPU 使用率 < 70%（告警阈值）
- 内存使用率 < 80%（告警阈值）
- 磁盘使用率 < 85%（告警阈值）
- 数据库连接数 < 150（最大200）
- API 响应时间 < 500ms（告警阈值）
```

---

### 🚀 方案B：双服务器生产环境（高可用方案）

### 3.1 主应用服务器（Server 1）

#### 3.1.1 基础配置

| 配置项 | 规格 | 说明 |
|-------|------|------|
| **CPU** | 8核 (8 vCPU) | Intel Xeon Gold 或同等性能 |
| **内存** | 16GB | DDR4 ECC 或以上 |
| **系统盘** | 100GB SSD | 高性能 SSD |
| **数据盘** | 200GB SSD | 存储上传文件、日志 |
| **带宽** | 10Mbps | 固定带宽（推荐按峰值购买） |
| **操作系统** | Ubuntu 22.04 LTS Server | 64位 |
| **IP地址** | 1个固定公网IP | 绑定域名 |

#### 3.1.2 软件环境

| 软件 | 版本 | 说明 |
|------|------|------|
| **Node.js** | v20.11.0+ LTS | 生产环境推荐 LTS 版本 |
| **npm** | v10.2.0+ | 包管理器 |
| **PM2** | v5.3.0+ | 进程守护 + 负载均衡 |
| **Nginx** | 1.24.x+ | 反向代理 + SSL |
| **Redis** | 7.2.x | 缓存 + Session + 队列 |
| **Git** | 2.x+ | 代码部署 |
| **Certbot** | latest | Let's Encrypt SSL证书 |

#### 3.1.3 部署架构

```
┌─────────────────────────────────────────────────────┐
│        生产服务器 1 - 应用服务器                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │  Nginx (80/443) + SSL                │          │
│  │  - 反向代理                            │          │
│  │  - 静态资源服务                        │          │
│  │  - HTTPS 加密                          │          │
│  │  - Gzip 压缩                           │          │
│  └──────┬───────────────────────────────┘          │
│         │                                           │
│         ├──▶ 后端 API (PM2 Cluster Mode)           │
│         │    └─ Node.js Instance 1 (3000)          │
│         │    └─ Node.js Instance 2 (3001)          │
│         │    └─ Node.js Instance 3 (3002)          │
│         │    └─ Node.js Instance 4 (3003)          │
│         │                                           │
│         ├──▶ 管理后台 (静态文件)                    │
│         │                                           │
│         └──▶ 小程序后端 (同一 API)                  │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │  Redis (6379)                         │          │
│  │  - 持久化开启                          │          │
│  │  - 定期备份                            │          │
│  └──────────────────────────────────────┘          │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │  文件存储 (200GB)                     │          │
│  │  - /data/edp/uploads                  │          │
│  │  - 定期备份到 OSS                     │          │
│  └──────────────────────────────────────┘          │
│                                                     │
│                      ▼                              │
│           连接数据库服务器 (Server 2)                │
│           PostgreSQL (内网 IP:5432)                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3.2 数据库服务器（Server 2）

#### 3.2.1 基础配置

| 配置项 | 规格 | 说明 |
|-------|------|------|
| **CPU** | 4核 (4 vCPU) | 高主频处理器 |
| **内存** | 16GB | DDR4 ECC（数据库推荐大内存） |
| **系统盘** | 50GB SSD | 操作系统 |
| **数据盘** | 500GB SSD | PostgreSQL 数据存储（高IOPS） |
| **备份盘** | 500GB HDD | 数据库备份 |
| **带宽** | 5Mbps | 内网互联 + 外网访问 |
| **操作系统** | Ubuntu 22.04 LTS Server | 64位 |
| **IP地址** | 1个固定公网IP + 内网IP | 内网连接应用服务器 |

#### 3.2.2 软件环境

| 软件 | 版本 | 说明 |
|------|------|------|
| **PostgreSQL** | 16.x | 主数据库 |
| **pgAdmin** (可选) | 4.x+ | Web管理界面 |
| **pg_dump** | 内置 | 数据库备份工具 |
| **Cron** | 系统自带 | 定时备份任务 |

#### 3.2.3 数据库配置优化

```yaml
# PostgreSQL 生产环境配置建议
shared_buffers = 4GB              # 内存的 25%
effective_cache_size = 12GB       # 内存的 75%
maintenance_work_mem = 1GB
work_mem = 64MB
max_connections = 200
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1            # SSD 优化
effective_io_concurrency = 200    # SSD 优化
```

#### 3.2.4 备份策略

| 备份类型 | 频率 | 保留时间 | 存储位置 |
|---------|------|---------|---------|
| **完整备份** | 每天凌晨 2:00 | 30天 | 本地 + 对象存储 |
| **增量备份** | 每6小时 | 7天 | 本地 |
| **WAL归档** | 实时 | 7天 | 本地 + 对象存储 |

---

## 四、域名与SSL证书

### 4.1 域名要求

| 环境 | 域名示例 | 说明 |
|-----|---------|------|
| **测试环境** | `test.edp-system.com` | 测试域名（可使用二级域名） |
| **生产环境** | `www.edp-system.com` 或 `edp.company.com` | 主域名 |
| **API接口** | `api.edp-system.com` | API 专用域名（推荐） |
| **管理后台** | `admin.edp-system.com` | 管理后台域名（推荐） |

### 4.2 SSL证书

| 项目 | 方案 | 说明 |
|-----|------|------|
| **测试环境** | Let's Encrypt 免费证书 | 3个月有效期，自动续期 |
| **生产环境** | 商业SSL证书 或 Let's Encrypt | 推荐购买 OV/EV 证书 |

---

## 五、网络与安全配置

### 5.1 防火墙规则

#### 测试服务器

| 端口 | 协议 | 来源 | 说明 |
|-----|------|------|------|
| 22 | TCP | 指定IP | SSH管理端口 |
| 80 | TCP | 0.0.0.0/0 | HTTP（重定向到HTTPS） |
| 443 | TCP | 0.0.0.0/0 | HTTPS |
| 3000 | TCP | 127.0.0.1 | Node.js（内部访问） |
| 5432 | TCP | 127.0.0.1 | PostgreSQL（内部访问） |
| 6379 | TCP | 127.0.0.1 | Redis（内部访问） |

#### 生产服务器 1（应用）

| 端口 | 协议 | 来源 | 说明 |
|-----|------|------|------|
| 22 | TCP | VPN/堡垒机 | SSH管理（限制来源） |
| 80 | TCP | 0.0.0.0/0 | HTTP |
| 443 | TCP | 0.0.0.0/0 | HTTPS |
| 3000-3003 | TCP | 127.0.0.1 | Node.js Cluster |
| 6379 | TCP | 127.0.0.1 | Redis |

#### 生产服务器 2（数据库）

| 端口 | 协议 | 来源 | 说明 |
|-----|------|------|------|
| 22 | TCP | VPN/堡垒机 | SSH管理（限制来源） |
| 5432 | TCP | 应用服务器内网IP | PostgreSQL |

### 5.2 安全加固建议

- ✅ 禁用 root 直接登录，使用普通用户 + sudo
- ✅ 修改 SSH 默认端口（22 → 自定义）
- ✅ 启用 SSH 密钥登录，禁用密码登录
- ✅ 安装 fail2ban 防止暴力破解
- ✅ 定期更新系统补丁
- ✅ 数据库设置强密码，禁止外网直接访问
- ✅ 启用 PostgreSQL SSL 连接
- ✅ 配置日志审计
- ✅ 定期检查异常登录

---

## 六、监控与运维

### 6.1 监控方案

| 监控项 | 工具 | 说明 |
|-------|------|------|
| **服务器资源** | Prometheus + Grafana | CPU、内存、磁盘、网络 |
| **应用性能** | PM2 Monitor 或 New Relic | Node.js 应用监控 |
| **数据库** | pg_stat_statements | SQL 性能分析 |
| **日志收集** | ELK Stack 或 Loki | 集中式日志管理 |
| **告警** | AlertManager 或 邮件/短信 | 异常告警 |

### 6.2 日志管理

```
/var/log/edp/
├── nginx/
│   ├── access.log         # Nginx 访问日志
│   └── error.log          # Nginx 错误日志
├── backend/
│   ├── application.log    # 应用日志
│   ├── error.log          # 错误日志
│   └── access.log         # API 访问日志
├── postgresql/
│   └── postgresql.log     # 数据库日志
└── cron/
    └── backup.log         # 备份日志
```

**日志轮转：**
- 日志文件按天切割
- 保留 30 天
- 压缩归档
- 定期清理

---

## 七、部署清单

### 7.1 测试服务器部署步骤

1. ✅ 采购服务器（4核8G）
2. ✅ 安装 Ubuntu 22.04 LTS
3. ✅ 配置防火墙和安全策略
4. ✅ 安装 Node.js、PostgreSQL、Redis、Nginx
5. ✅ 配置域名解析
6. ✅ 申请 SSL 证书
7. ✅ 部署后端应用
8. ✅ 部署前端应用
9. ✅ 配置 PM2 进程守护
10. ✅ 配置 Nginx 反向代理
11. ✅ 数据库初始化和数据迁移
12. ✅ 功能测试
13. ✅ 性能测试

### 7.2 生产服务器部署步骤

#### Server 1 - 应用服务器

1. ✅ 采购服务器（8核16G + 200GB数据盘）
2. ✅ 安装 Ubuntu 22.04 LTS
3. ✅ 配置防火墙（严格限制端口）
4. ✅ 安装 Node.js、Redis、Nginx
5. ✅ 配置域名解析（主域名 + API域名）
6. ✅ 申请商业SSL证书或配置 Let's Encrypt
7. ✅ 部署后端（PM2 Cluster 模式）
8. ✅ 部署管理后台前端
9. ✅ 配置 Nginx（负载均衡 + SSL + Gzip）
10. ✅ 配置 Redis 持久化
11. ✅ 配置文件上传目录和权限
12. ✅ 配置定时任务（如数据统计、缓存清理）
13. ✅ 配置监控和告警

#### Server 2 - 数据库服务器

1. ✅ 采购服务器（4核16G + 500GB数据盘 + 500GB备份盘）
2. ✅ 安装 Ubuntu 22.04 LTS
3. ✅ 配置防火墙（仅允许应用服务器访问）
4. ✅ 安装 PostgreSQL 16
5. ✅ 优化 PostgreSQL 配置
6. ✅ 启用 SSL 连接
7. ✅ 创建数据库和用户
8. ✅ 执行数据库迁移
9. ✅ 配置自动备份（完整备份 + 增量备份）
10. ✅ 配置 WAL 归档
11. ✅ 测试备份恢复流程
12. ✅ 配置监控和告警

---

## 八、成本预算（参考）

### 8.1 测试服务器（单台）

| 项目 | 规格 | 单价/月 | 说明 |
|-----|------|---------|------|
| 云服务器 | 4核8G | ¥300-500 | 按量或包年 |
| 数据盘 | 100GB SSD | ¥50-100 | 高性能云盘 |
| 带宽 | 5Mbps | ¥50-100 | 固定带宽 |
| **小计** | - | **¥400-700/月** | - |

### 8.2 生产服务器 - 方案A（单服务器，推荐）

| 项目 | 规格 | 单价/月 | 说明 |
|-----|------|---------|------|
| 云服务器 | 8核16G | ¥600-1000 | 按量或包年 |
| 数据盘 | 500GB SSD | ¥250-400 | 高性能云盘 |
| 带宽 | 10Mbps | ¥150-300 | 固定带宽 |
| 对象存储OSS | 100GB | ¥20-50 | 备份存储 |
| 数据库备份 | 100GB | ¥20-40 | 云端备份 |
| SSL证书 | Let's Encrypt | ¥0 | 免费证书 |
| **小计** | - | **¥1,040-1,790/月** | **约¥1,200-1,600/月** |

**💰 年度成本（包年优惠）：**
- 阿里云/腾讯云包年折扣约 6-7折
- 预估年度成本：**¥8,500-13,500**

### 8.3 生产服务器 - 方案B（双服务器，高可用）

| 项目 | 规格 | 单价/月 | 数量 | 小计/月 |
|-----|------|---------|:----:|--------|
| 应用服务器 | 8核16G | ¥800-1200 | 1 | ¥800-1200 |
| 数据盘 | 200GB SSD | ¥100-200 | 1 | ¥100-200 |
| 数据库服务器 | 4核16G | ¥600-900 | 1 | ¥600-900 |
| 数据盘 | 500GB SSD | ¥250-400 | 1 | ¥250-400 |
| 备份盘 | 500GB HDD | ¥50-100 | 1 | ¥50-100 |
| 带宽 | 10Mbps | ¥150-300 | 1 | ¥150-300 |
| 对象存储OSS | 100GB | ¥20-50 | 1 | ¥20-50 |
| 数据库备份 | 200GB | ¥40-80 | 1 | ¥40-80 |
| CDN流量 | 按需 | ¥100-300 | 1 | ¥100-300 |
| SSL证书 | 商业证书 | ¥200-1000/年 | 1 | ¥17-84 |
| **小计** | - | - | - | **¥2,127-3,614/月** |

### 8.4 其他成本

| 项目 | 费用 | 说明 |
|-----|------|------|
| 域名注册 | ¥50-100/年 | .com/.cn 等 |
| 短信服务 | 按量计费 | 验证码、通知 |
| OSS存储 | ¥0.12/GB/月 | 文件存储 |
| 监控服务 | ¥0-500/月 | 可选云监控服务 |

### 8.5 总成本对比

| 方案 | 测试环境 | 生产环境 | 月度总成本 | 年度总成本（含优惠） |
|-----|---------|---------|-----------|-------------------|
| **推荐方案** | 1台（4核8G） | 1台（8核16G） | ¥1,600-2,300 | **¥13,000-20,000** |
| **高可用方案** | 1台（4核8G） | 2台（8核+4核） | ¥2,500-4,300 | **¥21,000-38,000** |

**💡 建议：**
- 初期上线选择**推荐方案**，年度成本约 1.3-2万元
- 待业务增长后再升级到高可用方案
- 节省的成本可用于更多业务功能开发

---

## 九、云服务商推荐

### 9.1 国内云服务商

| 服务商 | 优势 | 适用场景 |
|-------|------|---------|
| **阿里云** | 产品线丰富、稳定性高、生态完善 | 推荐（综合性价比最高） |
| **腾讯云** | 微信小程序天然集成、价格优惠 | 推荐（小程序场景） |
| **华为云** | 技术实力强、安全性高 | 可选 |
| **百度云** | AI能力强 | 可选 |

### 9.2 配置建议

**测试环境推荐：**
- 阿里云 ECS 共享型 s6（4核8G）
- 腾讯云 标准型 S5（4核8G）

**生产环境推荐：**
- 阿里云 计算型 c7（8核16G）+ 通用型 g7（4核16G）
- 腾讯云 计算型 C4（8核16G）+ 标准型 S5（4核16G）

---

## 十、上线检查清单

### 10.1 测试环境上线前检查

- [ ] 服务器已采购并完成基础配置
- [ ] 域名已解析到服务器IP
- [ ] SSL证书已申请并配置
- [ ] 所有软件已安装并配置正确
- [ ] 数据库已初始化，测试数据已导入
- [ ] 后端服务正常运行（PM2状态正常）
- [ ] 前端页面可正常访问
- [ ] API接口测试通过
- [ ] 防火墙规则配置正确
- [ ] 日志记录正常
- [ ] 备份脚本测试通过

### 10.2 生产环境上线前检查

- [ ] 两台服务器已采购并完成基础配置
- [ ] 服务器之间内网互联测试通过
- [ ] 域名已备案（如需要）
- [ ] 域名已解析到服务器IP
- [ ] SSL证书已申请并配置（商业证书）
- [ ] 数据库服务器独立部署并优化
- [ ] 数据库连接池配置正确
- [ ] Redis持久化配置完成
- [ ] PM2 Cluster模式配置完成（4个实例）
- [ ] Nginx负载均衡配置完成
- [ ] 静态资源CDN配置（可选）
- [ ] 文件上传功能测试通过
- [ ] 微信小程序配置完成（服务器域名白名单）
- [ ] 防火墙规则严格配置
- [ ] 数据库自动备份配置并测试
- [ ] 监控和告警配置完成
- [ ] 压力测试通过（并发500+）
- [ ] 安全扫描通过
- [ ] 应急预案制定完成
- [ ] 回滚方案准备完成

---

## 十一、服务器升级路径

### 11.1 何时需要升级？

监控以下指标，当满足任一条件时考虑升级：

| 指标 | 单服务器告警阈值 | 升级建议 |
|-----|----------------|---------|
| **CPU使用率** | 持续 > 70% | 升级CPU或分离数据库 |
| **内存使用率** | 持续 > 80% | 增加内存或分离数据库 |
| **磁盘IO** | IOPS不足 | 升级磁盘或分离数据库 |
| **并发用户** | > 500 | 考虑分离数据库 |
| **注册用户** | > 5000 | 建议分离数据库 |
| **数据库大小** | > 50GB | 建议分离数据库 |
| **API响应时间** | > 500ms | 优化或升级配置 |

### 11.2 从单服务器升级到双服务器

#### 升级步骤（零停机方案）

```
第1步：准备数据库服务器
├─ 采购新服务器（4核16G）
├─ 安装 PostgreSQL
├─ 配置防火墙和安全策略
└─ 测试连接

第2步：数据迁移（凌晨业务低峰期）
├─ 在原服务器做完整数据库备份
├─ 将备份文件传输到新数据库服务器
├─ 在新服务器恢复数据
└─ 验证数据完整性

第3步：切换配置
├─ 修改后端 .env 配置（数据库地址）
├─ 配置新服务器防火墙（允许应用服务器访问）
├─ 重启后端服务
└─ 监控日志确认连接正常

第4步：清理与优化
├─ 停止原服务器上的 PostgreSQL
├─ 释放原服务器磁盘空间
├─ 优化新数据库服务器配置
└─ 配置数据库备份策略

预计停机时间：< 5分钟（重启后端服务）
```

### 11.3 纵向扩展（升级配置）

如果暂时不想分离服务器，可以升级单服务器配置：

| 阶段 | CPU | 内存 | 磁盘 | 适用规模 |
|-----|-----|------|------|---------|
| **初期** | 8核 | 16GB | 500GB | < 3000用户 |
| **成长期** | 16核 | 32GB | 1TB | 3000-8000用户 |
| **成熟期** | 分离部署 | - | - | > 8000用户 |

**升级方式：**
- 云服务器支持在线升级配置（可能需要短暂重启）
- 升级磁盘容量无需重启（在线扩容）
- 建议在业务低峰期操作

---

## 十二、联系人与支持

| 角色 | 职责 | 联系方式 |
|-----|------|---------|
| **运维负责人** | 服务器管理、部署 | - |
| **技术负责人** | 架构设计、技术支持 | - |
| **项目经理** | 整体协调 | - |

---

## 十二、附录

### 12.1 常用命令速查

```bash
# PM2 常用命令
pm2 start ecosystem.config.js       # 启动应用
pm2 status                          # 查看状态
pm2 logs                            # 查看日志
pm2 restart all                     # 重启所有
pm2 stop all                        # 停止所有
pm2 delete all                      # 删除所有

# Nginx 常用命令
sudo nginx -t                       # 测试配置
sudo systemctl restart nginx        # 重启 Nginx
sudo systemctl status nginx         # 查看状态

# PostgreSQL 常用命令
sudo systemctl status postgresql    # 查看状态
sudo -u postgres psql              # 进入数据库
pg_dump -U user -d dbname > backup.sql  # 备份

# 系统监控
htop                               # 资源监控
df -h                              # 磁盘使用
free -m                            # 内存使用
netstat -tunlp                     # 端口监听
```

### 12.2 参考文档

- [NestJS 生产环境部署指南](https://docs.nestjs.com/faq/serverless)
- [PostgreSQL 性能优化](https://wiki.postgresql.org/wiki/Performance_Optimization)
- [Nginx 配置最佳实践](https://www.nginx.com/resources/wiki/)
- [PM2 生产环境配置](https://pm2.keymetrics.io/docs/usage/deployment/)

---

**文档版本：** v1.0  
**创建日期：** 2025-11-14  
**最后更新：** 2025-11-14  
**维护人员：** 技术团队  
**审核人员：** 运维经理

---

**备注：**
1. 本文档中的价格仅供参考，实际价格以云服务商当时报价为准
2. 建议生产环境提前1-2周采购服务器，留出充足的配置和测试时间
3. 测试环境可按需暂停，生产环境建议购买包年服务享受折扣
4. 数据库服务器磁盘建议预留 50% 以上的空间用于数据增长
5. 建议每季度进行一次容灾演练，验证备份恢复流程

