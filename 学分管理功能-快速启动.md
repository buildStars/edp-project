# å­¦åˆ†ç®¡ç†åŠŸèƒ½ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. ç”¨æˆ·åˆ—è¡¨ - å­¦åˆ†ç®¡ç†æŒ‰é’®
**ä½ç½®**: ç”¨æˆ·ç®¡ç† â†’ ç”¨æˆ·åˆ—è¡¨ â†’ æ“ä½œåˆ—

**åŠŸèƒ½**:
- **ç®¡ç†å‘˜/æ•™åŠ¡**: ç‚¹å‡»"å­¦åˆ†ç®¡ç†"åï¼Œå¯ä»¥ç›´æ¥ä¸ºç”¨æˆ·åˆ†é…å­¦åˆ†ï¼Œæ— éœ€å®¡æ‰¹
- **æ•™å¸ˆ**: ç‚¹å‡»"å­¦åˆ†ç®¡ç†"åï¼Œéœ€è¦æäº¤å­¦åˆ†ç”³è¯·ï¼Œç­‰å¾…æ•™åŠ¡å®¡æ‰¹

### 2. æ•™å¸ˆç«¯ - å­¦åˆ†ç”³è¯·èœå•
**ä½ç½®**: æ•™å­¦ç®¡ç† â†’ å­¦åˆ†ç”³è¯·

**åŠŸèƒ½**:
- æŸ¥çœ‹è‡ªå·±æäº¤çš„æ‰€æœ‰å­¦åˆ†ç”³è¯·
- æŸ¥çœ‹ç”³è¯·çŠ¶æ€ï¼ˆå¾…å®¡æ‰¹/å·²é€šè¿‡/å·²æ‹’ç»/å·²å–æ¶ˆï¼‰
- å–æ¶ˆå¾…å®¡æ‰¹çš„ç”³è¯·
- æŸ¥çœ‹å®¡æ‰¹å¤‡æ³¨

### 3. åç«¯æƒé™é…ç½®
å·²æ·»åŠ ä»¥ä¸‹æƒé™ï¼š
- `credits:manage` - å­¦åˆ†ç®¡ç†ï¼ˆç›´æ¥åˆ†é…ï¼‰
- `credit-requests:create` - åˆ›å»ºå­¦åˆ†ç”³è¯·
- `credit-requests:view` - æŸ¥çœ‹å­¦åˆ†ç”³è¯·
- `credit-requests:review` - å®¡æ‰¹å­¦åˆ†ç”³è¯·
- `credit-requests:cancel` - å–æ¶ˆå­¦åˆ†ç”³è¯·

**è§’è‰²æƒé™åˆ†é…**:
- **ADMIN**: æ‰€æœ‰æƒé™
- **STAFF**: credits:manage, credit-requests:view, credit-requests:review
- **TEACHER**: credit-requests:create, credit-requests:view, credit-requests:cancel

## ğŸš€ å¯åŠ¨æ­¥éª¤

### 1. æ›´æ–°æ•°æ®åº“æƒé™
```bash
cd d:\edp-project\backend
npm run seed
```

### 2. é‡å¯åç«¯æœåŠ¡
å¦‚æœåç«¯æ­£åœ¨è¿è¡Œï¼Œè¯·é‡å¯ï¼š
```bash
# Ctrl+C åœæ­¢
npm run start:dev
```

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°ç™»å½•
- æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
- å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œé€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"
- æˆ–è€…ç›´æ¥é€€å‡ºç™»å½•åé‡æ–°ç™»å½•

## ğŸ“– ä½¿ç”¨è¯´æ˜

### æ•™å¸ˆå¦‚ä½•ç”³è¯·å­¦åˆ†

1. **æ–¹å¼ä¸€ï¼šä»ç”¨æˆ·åˆ—è¡¨ç”³è¯·**
   - è¿›å…¥"ç”¨æˆ·ç®¡ç†" â†’ "ç”¨æˆ·åˆ—è¡¨"
   - æ‰¾åˆ°è¦ç”³è¯·å­¦åˆ†çš„å­¦å‘˜
   - ç‚¹å‡»æ“ä½œåˆ—çš„"å­¦åˆ†ç®¡ç†"æŒ‰é’®
   - å¡«å†™å­¦åˆ†æ•°é‡å’Œç”³è¯·ç†ç”±
   - ç‚¹å‡»"æäº¤ç”³è¯·"

2. **æ–¹å¼äºŒï¼šæŸ¥çœ‹ç”³è¯·çŠ¶æ€**
   - è¿›å…¥"æ•™å­¦ç®¡ç†" â†’ "å­¦åˆ†ç”³è¯·"
   - æŸ¥çœ‹æ‰€æœ‰æäº¤çš„ç”³è¯·åŠå…¶çŠ¶æ€
   - å¯ä»¥å–æ¶ˆå¾…å®¡æ‰¹çš„ç”³è¯·

### ç®¡ç†å‘˜/æ•™åŠ¡å¦‚ä½•æ“ä½œ

1. **ç›´æ¥åˆ†é…å­¦åˆ†**
   - è¿›å…¥"ç”¨æˆ·ç®¡ç†" â†’ "ç”¨æˆ·åˆ—è¡¨"
   - æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·
   - ç‚¹å‡»"å­¦åˆ†ç®¡ç†"æŒ‰é’®
   - è¾“å…¥å­¦åˆ†æ•°é‡å’Œå¤‡æ³¨
   - ç‚¹å‡»"ç¡®å®šåˆ†é…"ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰

2. **å®¡æ‰¹æ•™å¸ˆç”³è¯·**ï¼ˆå¾…å®ç°ï¼‰
   - éœ€è¦åˆ›å»ºæ•™åŠ¡ç«¯å®¡æ‰¹é¡µé¢
   - è·¯å¾„ï¼š`/credit-requests`
   - èœå•åç§°ï¼šå­¦åˆ†ç”³è¯·å®¡æ‰¹

## ğŸ“‹ å¾…å®Œæˆå·¥ä½œ

### åˆ›å»ºæ•™åŠ¡ç«¯å®¡æ‰¹é¡µé¢
**æ–‡ä»¶**: `admin-frontend/src/views/CreditRequests/List.vue`

**å‚è€ƒä»£ç **ï¼ˆåŸºäºæ•™å¸ˆç«¯ä¿®æ”¹ï¼‰:
```vue
<template>
  <div class="credit-requests">
    <!-- ç±»ä¼¼ Teacher/CreditRequests.vue -->
    <!-- ä½†éœ€è¦æ·»åŠ å®¡æ‰¹æŒ‰é’®å’Œå®¡æ‰¹å¯¹è¯æ¡† -->
    
    <el-button 
      v-if="row.status === 'PENDING'"
      type="success" 
      @click="handleApprove(row)"
    >
      é€šè¿‡
    </el-button>
    <el-button 
      v-if="row.status === 'PENDING'"
      type="danger" 
      @click="handleReject(row)"
    >
      æ‹’ç»
    </el-button>
  </div>
</template>

<script setup>
import { reviewCreditRequest } from '@/api/credit-request'

const handleApprove = async (row) => {
  // å¼¹å‡ºå¯¹è¯æ¡†è®©ç”¨æˆ·å¡«å†™å®¡æ‰¹å¤‡æ³¨
  const reviewRemark = await ElMessageBox.prompt('å®¡æ‰¹å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰', 'é€šè¿‡ç”³è¯·', {
    inputType: 'textarea',
  })
  
  await reviewCreditRequest(row.id, {
    status: 'APPROVED',
    reviewRemark: reviewRemark.value,
  })
  
  ElMessage.success('å®¡æ‰¹æˆåŠŸ')
  handleSearch()
}

const handleReject = async (row) => {
  // æ‹’ç»å¿…é¡»å¡«å†™åŸå› 
  const reviewRemark = await ElMessageBox.prompt('è¯·è¾“å…¥æ‹’ç»åŸå› ', 'æ‹’ç»ç”³è¯·', {
    inputType: 'textarea',
    inputValidator: (value) => value?.trim() ? true : 'è¯·è¾“å…¥æ‹’ç»åŸå› ',
  })
  
  await reviewCreditRequest(row.id, {
    status: 'REJECTED',
    reviewRemark: reviewRemark.value,
  })
  
  ElMessage.success('å·²æ‹’ç»')
  handleSearch()
}
</script>
```

### æ·»åŠ è·¯ç”±é…ç½®
åœ¨ `admin-frontend/src/router/index.ts` ä¸­æ·»åŠ ï¼š
```typescript
{
  path: '/credit-requests',
  name: 'CreditRequests',
  component: () => import('@/views/CreditRequests/List.vue'),
  meta: {
    title: 'å­¦åˆ†ç”³è¯·å®¡æ‰¹',
    icon: 'Coin',
  },
}
```

### æ·»åŠ èœå•é…ç½®
åœ¨ `admin-frontend/src/config/permissions.ts` ä¸­æ·»åŠ ï¼ˆæ•™åŠ¡/ç®¡ç†å‘˜èœå•ï¼‰ï¼š
```typescript
{
  path: '/credit-requests',
  name: 'CreditRequests',
  title: 'å­¦åˆ†ç”³è¯·å®¡æ‰¹',
  icon: 'Coin',
  permission: 'credit-requests:review',
  hideForRoles: ['TEACHER'],
}
```

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æ•™å¸ˆç”³è¯·æµç¨‹
1. ä½¿ç”¨æ•™å¸ˆè´¦å·ç™»å½•
2. è¿›å…¥"ç”¨æˆ·ç®¡ç†" â†’ "ç”¨æˆ·åˆ—è¡¨"
3. ç‚¹å‡»æŸä¸ªå­¦å‘˜çš„"å­¦åˆ†ç®¡ç†"æŒ‰é’®
4. çœ‹åˆ°æç¤ºï¼š"æ•™å¸ˆéœ€è¦æäº¤å­¦åˆ†ç”³è¯·ï¼Œç»æ•™åŠ¡å®¡æ‰¹åæ‰èƒ½ç”Ÿæ•ˆ"
5. å¡«å†™å­¦åˆ†æ•°é‡å’Œç”³è¯·ç†ç”±
6. ç‚¹å‡»"æäº¤ç”³è¯·"
7. è¿›å…¥"æ•™å­¦ç®¡ç†" â†’ "å­¦åˆ†ç”³è¯·"ï¼ŒæŸ¥çœ‹ç”³è¯·çŠ¶æ€ä¸º"å¾…å®¡æ‰¹"

### åœºæ™¯ 2: ç®¡ç†å‘˜ç›´æ¥åˆ†é…
1. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è¿›å…¥"ç”¨æˆ·ç®¡ç†" â†’ "ç”¨æˆ·åˆ—è¡¨"
3. ç‚¹å‡»æŸä¸ªå­¦å‘˜çš„"å­¦åˆ†ç®¡ç†"æŒ‰é’®
4. çœ‹åˆ°æç¤ºï¼š"ç®¡ç†å‘˜/æ•™åŠ¡å¯ä»¥ç›´æ¥åˆ†é…å­¦åˆ†ï¼Œæ— éœ€å®¡æ‰¹"
5. å¡«å†™å­¦åˆ†æ•°é‡å’Œå¤‡æ³¨
6. ç‚¹å‡»"ç¡®å®šåˆ†é…"
7. å­¦åˆ†ç«‹å³åˆ°è´¦

### åœºæ™¯ 3: æ•™åŠ¡å®¡æ‰¹ï¼ˆå¾…å®ç°å®¡æ‰¹é¡µé¢åæµ‹è¯•ï¼‰
1. æ•™å¸ˆæäº¤å­¦åˆ†ç”³è¯·
2. ä½¿ç”¨æ•™åŠ¡è´¦å·ç™»å½•
3. è¿›å…¥"å­¦åˆ†ç”³è¯·å®¡æ‰¹"é¡µé¢
4. çœ‹åˆ°æ•™å¸ˆæäº¤çš„ç”³è¯·
5. ç‚¹å‡»"é€šè¿‡"æˆ–"æ‹’ç»"
6. å¡«å†™å®¡æ‰¹å¤‡æ³¨
7. æäº¤å®¡æ‰¹
8. éªŒè¯å­¦åˆ†æ˜¯å¦åˆ°è´¦ï¼ˆé€šè¿‡æ—¶ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»è¿è¡Œ seed è„šæœ¬æ›´æ–°æƒé™**
   ```bash
   cd d:\edp-project\backend
   npm run seed
   ```

2. **å·²ç™»å½•ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•** æ‰èƒ½è·å–æ–°æƒé™

3. **æƒé™éªŒè¯**:
   - æ•™å¸ˆæ— æ³•çœ‹åˆ°"ç¡®å®šåˆ†é…"ï¼Œåªèƒ½çœ‹åˆ°"æäº¤ç”³è¯·"
   - æ•™å¸ˆåœ¨ç”¨æˆ·åˆ—è¡¨çš„"å­¦åˆ†ç®¡ç†"æŒ‰é’®éœ€è¦æœ‰ `credits:manage` æˆ– `credit-requests:create` æƒé™

4. **èœå•æ˜¾ç¤º**:
   - æ•™å¸ˆç«¯ï¼š"æ•™å­¦ç®¡ç†" â†’ "å­¦åˆ†ç”³è¯·"
   - æ•™åŠ¡ç«¯ï¼šéœ€è¦æ·»åŠ ç‹¬ç«‹èœå•"å­¦åˆ†ç”³è¯·å®¡æ‰¹"

## ğŸ“ API æ–‡æ¡£

### åˆ›å»ºå­¦åˆ†ç”³è¯·ï¼ˆæ•™å¸ˆï¼‰
```
POST /api/credit-requests
Body: {
  userId: string,      // ç›®æ ‡ç”¨æˆ·ID
  amount: number,      // å­¦åˆ†æ•°é‡
  reason: string       // ç”³è¯·ç†ç”±
}
```

### ç›´æ¥åˆ†é…å­¦åˆ†ï¼ˆç®¡ç†å‘˜/æ•™åŠ¡ï¼‰
```
POST /api/credits/allocate
Body: {
  userId: string,      // ç›®æ ‡ç”¨æˆ·ID
  amount: number,      // å­¦åˆ†æ•°é‡
  remark?: string      // å¤‡æ³¨
}
```

### å®¡æ‰¹å­¦åˆ†ç”³è¯·
```
PATCH /api/credit-requests/:id/review
Body: {
  status: 'APPROVED' | 'REJECTED',
  reviewRemark?: string
}
```

### æŸ¥è¯¢å­¦åˆ†ç”³è¯·åˆ—è¡¨
```
GET /api/credit-requests?page=1&pageSize=20&status=PENDING
```

## ğŸ”— ç›¸å…³æ–‡ä»¶

### åç«¯
- `backend/prisma/schema.prisma` - æ•°æ®åº“æ¨¡å‹ï¼ˆCreditRequestï¼‰
- `backend/src/modules/credit-requests/` - å­¦åˆ†ç”³è¯·æ¨¡å—
- `backend/src/modules/credits/` - å­¦åˆ†ç®¡ç†æ¨¡å—
- `backend/prisma/seeds/permissions.seed.ts` - æƒé™é…ç½®

### å‰ç«¯
- `admin-frontend/src/api/credit-request.ts` - å­¦åˆ†ç”³è¯·API
- `admin-frontend/src/api/credit.ts` - å­¦åˆ†ç®¡ç†API
- `admin-frontend/src/views/Users/List.vue` - ç”¨æˆ·åˆ—è¡¨ï¼ˆå«å­¦åˆ†ç®¡ç†æŒ‰é’®ï¼‰
- `admin-frontend/src/views/Teacher/CreditRequests.vue` - æ•™å¸ˆç«¯ç”³è¯·åˆ—è¡¨
- `admin-frontend/src/config/permissions.ts` - èœå•é…ç½®
- `admin-frontend/src/router/index.ts` - è·¯ç”±é…ç½®

---

## ğŸ‰ å®Œæˆæƒ…å†µ

âœ… åç«¯ API å·²å®ç°  
âœ… æ•°æ®åº“æ¨¡å‹å·²å­˜åœ¨  
âœ… ç”¨æˆ·åˆ—è¡¨å­¦åˆ†ç®¡ç†æŒ‰é’®å·²æ·»åŠ   
âœ… æ•™å¸ˆç«¯ç”³è¯·åˆ—è¡¨é¡µé¢å·²åˆ›å»º  
âœ… æƒé™é…ç½®å·²æ›´æ–°  
âœ… èœå•å’Œè·¯ç”±å·²é…ç½®  
â³ æ•™åŠ¡ç«¯å®¡æ‰¹é¡µé¢å¾…åˆ›å»ºï¼ˆå¯å‚è€ƒæ•™å¸ˆç«¯ä»£ç ï¼‰

å¤§éƒ¨åˆ†åŠŸèƒ½å·²ç»å®Œæˆï¼Œåªéœ€åˆ›å»ºæ•™åŠ¡ç«¯çš„å®¡æ‰¹é¡µé¢å³å¯ï¼









