# ä¼ä¸šç”¨æˆ·æ˜¾ç¤ºå’Œå­¦åˆ†ä¿®å¤å®Œæˆ

## ğŸ› é—®é¢˜æè¿°

1. **ä¼ä¸šç®¡ç†å‘˜è¯†åˆ«é—®é¢˜**ï¼šåå°è®¾ç½®ä¸ºä¼ä¸šç®¡ç†å‘˜åï¼Œå°ç¨‹åºæ²¡æœ‰è¯†åˆ«å‡ºæ¥
2. **å­¦åˆ†æ˜¾ç¤ºé—®é¢˜**ï¼šä¼ä¸šå­¦åˆ†æ²¡æœ‰æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºäº†ä¸ªäººå­¦åˆ†

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

### 1. åç«¯ç”¨æˆ·ä¿¡æ¯æ¥å£ç¼ºå¤±å…³è”æ•°æ®

**æ–‡ä»¶**ï¼š`backend/src/modules/users/users.service.ts`

**é—®é¢˜**ï¼š`findOne` æ–¹æ³•æ²¡æœ‰åŒ…å«ï¼š
- `organization`ï¼ˆä¼ä¸šä¿¡æ¯ - ä¼ä¸šç”¨æˆ·ï¼‰
- `adminOrganizations`ï¼ˆç®¡ç†çš„ä¼ä¸š - ä¼ä¸šç®¡ç†å‘˜ï¼‰

```typescript
// âŒ ä¿®å¤å‰ - æ²¡æœ‰åŒ…å«ä¼ä¸šç›¸å…³ä¿¡æ¯
async findOne(id: string) {
  const user = await this.prisma.user.findUnique({
    where: { id },
    include: {
      advisor: { /* ... */ }
      // âŒ ç¼ºå°‘ organization å’Œ adminOrganizations
    },
  });
}
```

### 2. å‰ç«¯å­¦åˆ†æ˜¾ç¤ºä¸å®Œæ•´

**æ–‡ä»¶**ï¼š`frontend-uniapp/pages/mine/index.vue`

**é—®é¢˜**ï¼šåªæ˜¾ç¤ºäº†ä¸ªäººå­¦åˆ†ï¼Œæ²¡æœ‰æ˜¾ç¤ºä¼ä¸šå­¦åˆ†

```html
<!-- âŒ ä¿®å¤å‰ - åªæ˜¾ç¤ºä¸ªäººå­¦åˆ† -->
<view class="credit-value">{{ credits.balance || 0 }}</view>
<view class="credit-label">å‰©ä½™å­¦åˆ†</view>
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤åç«¯ç”¨æˆ·ä¿¡æ¯æ¥å£

**æ–‡ä»¶**ï¼š`backend/src/modules/users/users.service.ts`

**ä¿®æ”¹**ï¼šåœ¨ `findOne` æ–¹æ³•ä¸­æ·»åŠ ä¼ä¸šå…³è”æŸ¥è¯¢

```typescript
async findOne(id: string) {
  const user = await this.prisma.user.findUnique({
    where: { id },
    include: {
      advisor: {
        select: {
          id: true,
          nickname: true,
          phone: true,
        },
      },
      // âœ… åŒ…å«ä¼ä¸šä¿¡æ¯ï¼ˆæ™®é€šä¼ä¸šç”¨æˆ·ï¼‰
      organization: {
        select: {
          id: true,
          name: true,
          maxStudents: true,
          totalCredits: true,
          usedCredits: true,
        },
      },
      // âœ… åŒ…å«ç®¡ç†çš„ä¼ä¸šä¿¡æ¯ï¼ˆä¼ä¸šç®¡ç†å‘˜ï¼‰
      adminOrganizations: {
        select: {
          id: true,
          name: true,
          maxStudents: true,
          totalCredits: true,
          usedCredits: true,
        },
      },
    },
  });

  if (!user) {
    throw new NotFoundException('ç”¨æˆ·ä¸å­˜åœ¨');
  }

  return {
    ...user,
    avatar: getFullUrl(user.avatar),
  };
}
```

**è¿”å›æ•°æ®ç»“æ„**ï¼š
```json
{
  "id": "user-id",
  "nickname": "ç”¨æˆ·å",
  "organizationId": "org-id",
  "organization": {
    "id": "org-id",
    "name": "52Hertz",
    "maxStudents": 100,
    "totalCredits": 444,
    "usedCredits": 0
  },
  "adminOrganizations": [
    {
      "id": "org-id",
      "name": "52Hertz",
      "maxStudents": 100,
      "totalCredits": 444,
      "usedCredits": 0
    }
  ]
}
```

### 2. ä¼˜åŒ–å‰ç«¯å­¦åˆ†æ˜¾ç¤º

**æ–‡ä»¶**ï¼š`frontend-uniapp/pages/mine/index.vue`

**ä¿®æ”¹å‰**ï¼š
```html
<!-- åªæ˜¾ç¤ºï¼šæ€»å­¦åˆ†ã€å‰©ä½™å­¦åˆ†ã€å·²æ‰£å­¦åˆ† -->
<view class="credit-card">
  <view class="credit-item">
    <view class="credit-value">{{ credits.total || 0 }}</view>
    <view class="credit-label">æ€»å­¦åˆ†</view>
  </view>
  <view class="credit-item">
    <view class="credit-value">{{ credits.balance || 0 }}</view>
    <view class="credit-label">å‰©ä½™å­¦åˆ†</view>
  </view>
  <view class="credit-item">
    <view class="credit-value">{{ credits.used || 0 }}</view>
    <view class="credit-label">å·²æ‰£å­¦åˆ†</view>
  </view>
</view>
```

**ä¿®æ”¹å**ï¼š
```html
<!-- æ˜¾ç¤ºï¼šå¯ç”¨å­¦åˆ†ï¼ˆæ€»è®¡ï¼‰ã€ä¼ä¸šå­¦åˆ†ã€ä¸ªäººå­¦åˆ† -->
<view class="credit-card">
  <!-- å¯ç”¨å­¦åˆ†ï¼ˆä¼ä¸š + ä¸ªäººï¼‰ -->
  <view class="credit-item" @click="goMyCredits">
    <view class="credit-icon">
      <Icon name="star" :size="48" color="#FFD700" />
    </view>
    <view class="credit-content">
      <view class="credit-value">{{ totalAvailableCredits }}</view>
      <view class="credit-label">å¯ç”¨å­¦åˆ†</view>
    </view>
  </view>
  
  <!-- ä¼ä¸šå­¦åˆ† -->
  <view class="credit-item">
    <view class="credit-icon">
      <Icon name="work" :size="48" color="#9C27B0" />
    </view>
    <view class="credit-content">
      <view class="credit-value">{{ credits.corporateBalance || 0 }}</view>
      <view class="credit-label">ä¼ä¸šå­¦åˆ†</view>
    </view>
  </view>
  
  <!-- ä¸ªäººå­¦åˆ† -->
  <view class="credit-item">
    <view class="credit-icon">
      <Icon name="user" :size="48" color="#1890FF" />
    </view>
    <view class="credit-content">
      <view class="credit-value">{{ credits.balance || 0 }}</view>
      <view class="credit-label">ä¸ªäººå­¦åˆ†</view>
    </view>
  </view>
</view>
```

**è®¡ç®—æ€»å¯ç”¨å­¦åˆ†**ï¼š
```javascript
// è®¡ç®—æ€»å¯ç”¨å­¦åˆ†ï¼ˆä¼ä¸šå­¦åˆ† + ä¸ªäººå­¦åˆ†ï¼‰
const totalAvailableCredits = computed(() => {
  const corporate = credits.value?.corporateBalance || 0
  const personal = credits.value?.balance || 0
  return corporate + personal
})
```

## ğŸ“Š å­¦åˆ†ç³»ç»Ÿè¯´æ˜

### å­¦åˆ†è´¦æˆ·ç»“æ„

**æ•°æ®åº“è¡¨**ï¼š`Credit`

```prisma
model Credit {
  id               String   @id @default(cuid())
  userId           String   @unique
  balance          Int      @default(0)      // ä¸ªäººå­¦åˆ†ä½™é¢
  total            Int      @default(0)      // ä¸ªäººå­¦åˆ†æ€»æ•°
  used             Int      @default(0)      // ä¸ªäººå­¦åˆ†å·²ç”¨
  corporateBalance Int      @default(0)      // ä¼ä¸šå­¦åˆ†ä½™é¢
  corporateUsed    Int      @default(0)      // ä¼ä¸šå­¦åˆ†å·²ç”¨
  // ...
}
```

### å­¦åˆ†ä½¿ç”¨è§„åˆ™

1. **æŠ¥åè¯¾ç¨‹æ—¶**ï¼š
   - ä¼˜å…ˆä½¿ç”¨**ä¼ä¸šå­¦åˆ†**
   - ä¼ä¸šå­¦åˆ†ä¸è¶³æ—¶ï¼Œä½¿ç”¨**ä¸ªäººå­¦åˆ†**
   - æ€»å­¦åˆ† = ä¼ä¸šå­¦åˆ† + ä¸ªäººå­¦åˆ†

2. **æ˜¾ç¤ºè§„åˆ™**ï¼š
   - **å¯ç”¨å­¦åˆ†**ï¼šä¼ä¸šå­¦åˆ† + ä¸ªäººå­¦åˆ†ï¼ˆæ€»è®¡ï¼‰
   - **ä¼ä¸šå­¦åˆ†**ï¼šç”±ä¼ä¸šç®¡ç†å‘˜åˆ†é…
   - **ä¸ªäººå­¦åˆ†**ï¼šç®¡ç†å‘˜å……å€¼æˆ–è¯¾ç¨‹å®Œæˆå¥–åŠ±

3. **å­¦åˆ†åˆ†é…**ï¼š
   - ä¼ä¸šç®¡ç†å‘˜å¯ä»¥ç»™ä¼ä¸šå‘˜å·¥åˆ†é…ä¼ä¸šå­¦åˆ†
   - ç®¡ç†å‘˜/æ•™åŠ¡å¯ä»¥ç»™ä»»ä½•ç”¨æˆ·å……å€¼ä¸ªäººå­¦åˆ†

## ğŸ¨ UI ä¼˜åŒ–æ•ˆæœ

### ä¿®å¤å‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€»å­¦åˆ†: 0           â”‚
â”‚ å‰©ä½™å­¦åˆ†: 0         â”‚  âŒ çœ‹ä¸åˆ°ä¼ä¸šå­¦åˆ†
â”‚ å·²æ‰£å­¦åˆ†: 0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤å
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â­ å¯ç”¨å­¦åˆ†: 444    â”‚  â† ä¼ä¸šå­¦åˆ† + ä¸ªäººå­¦åˆ†
â”‚ ğŸ¢ ä¼ä¸šå­¦åˆ†: 444    â”‚  â† ä¼ä¸šç®¡ç†å‘˜åˆ†é…
â”‚ ğŸ‘¤ ä¸ªäººå­¦åˆ†: 0      â”‚  â† ä¸ªäººå……å€¼/å¥–åŠ±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— ç›¸å…³åŠŸèƒ½

### ä¼ä¸šç®¡ç†å‘˜åŠŸèƒ½
- æŸ¥çœ‹ä¼ä¸šå‘˜å·¥åˆ—è¡¨
- åˆ†é…ä¼ä¸šå­¦åˆ†ç»™å‘˜å·¥
- ä¸ºå‘˜å·¥è´­ä¹°è¯¾ç¨‹
- æŸ¥çœ‹å­¦åˆ†ä½¿ç”¨è®°å½•

### ä¼ä¸šç”¨æˆ·åŠŸèƒ½
- ä½¿ç”¨ä¼ä¸šå­¦åˆ†æŠ¥åè¯¾ç¨‹
- æŸ¥çœ‹ä¼ä¸šä¿¡æ¯
- æŸ¥çœ‹å­¦åˆ†ä½™é¢ï¼ˆä¼ä¸š + ä¸ªäººï¼‰

## ğŸ“ API æ¥å£è¯´æ˜

### è·å–ç”¨æˆ·ä¿¡æ¯
```
GET /api/users/me
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "id": "user-id",
  "nickname": "ç”¨æˆ·å",
  "organizationId": "org-id",
  "organization": {
    "id": "org-id",
    "name": "ä¼ä¸šåç§°",
    "maxStudents": 100,
    "totalCredits": 444,
    "usedCredits": 0
  },
  "adminOrganizations": [...]
}
```

### è·å–å­¦åˆ†ä¿¡æ¯
```
GET /api/credits/my
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "id": "credit-id",
  "userId": "user-id",
  "balance": 0,              // ä¸ªäººå­¦åˆ†ä½™é¢
  "total": 0,                // ä¸ªäººå­¦åˆ†æ€»æ•°
  "used": 0,                 // ä¸ªäººå­¦åˆ†å·²ç”¨
  "corporateBalance": 444,   // ä¼ä¸šå­¦åˆ†ä½™é¢
  "corporateUsed": 0,        // ä¼ä¸šå­¦åˆ†å·²ç”¨
  "records": [...]           // å­¦åˆ†è®°å½•
}
```

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•ä¼ä¸šç®¡ç†å‘˜è¯†åˆ«

1. åœ¨ç®¡ç†åå°åˆ›å»ºä¼ä¸š
2. è®¾ç½®ç”¨æˆ·ä¸ºä¼ä¸šç®¡ç†å‘˜
3. å°ç¨‹åºç™»å½•è¯¥ç”¨æˆ·
4. æŸ¥çœ‹ä¸ªäººä¸­å¿ƒé¡µé¢ï¼š
   - âœ… å¤´åƒä¸‹æ–¹æ˜¾ç¤º"ä¼ä¸šç®¡ç†å‘˜"å¾½ç« 
   - âœ… ç”¨æˆ·åæ—æ˜¾ç¤ºä¼ä¸šåç§°æ ‡ç­¾
   - âœ… æ˜¾ç¤º"ä¼ä¸šåŠŸèƒ½"åŒºåŸŸ
   - âœ… æ˜¾ç¤º"å‘˜å·¥ç®¡ç†"å¡ç‰‡

### 2. æµ‹è¯•ä¼ä¸šå­¦åˆ†æ˜¾ç¤º

1. ä¼ä¸šç®¡ç†å‘˜ç»™ä¼ä¸šç”¨æˆ·åˆ†é…å­¦åˆ†ï¼ˆå¦‚ï¼š444å­¦åˆ†ï¼‰
2. ä¼ä¸šç”¨æˆ·ç™»å½•å°ç¨‹åº
3. æŸ¥çœ‹ä¸ªäººä¸­å¿ƒé¡µé¢ï¼š
   - âœ… å¯ç”¨å­¦åˆ†ï¼š444
   - âœ… ä¼ä¸šå­¦åˆ†ï¼š444
   - âœ… ä¸ªäººå­¦åˆ†ï¼š0

### 3. æµ‹è¯•å­¦åˆ†æŠ¥å

1. ä¼ä¸šç”¨æˆ·æŠ¥åè¯¾ç¨‹ï¼ˆéœ€è¦1å­¦åˆ†ï¼‰
2. æŸ¥çœ‹å­¦åˆ†å˜åŒ–ï¼š
   - âœ… å¯ç”¨å­¦åˆ†ï¼š443ï¼ˆ444 - 1ï¼‰
   - âœ… ä¼ä¸šå­¦åˆ†ï¼š443ï¼ˆä¼˜å…ˆæ‰£é™¤ï¼‰
   - âœ… ä¸ªäººå­¦åˆ†ï¼š0ï¼ˆæœªä½¿ç”¨ï¼‰

## ğŸ‰ å®Œæˆæƒ…å†µ

âœ… **100% å®Œæˆ**

- [x] ä¿®å¤åç«¯ç”¨æˆ·ä¿¡æ¯æ¥å£
- [x] æ·»åŠ ä¼ä¸šå…³è”æŸ¥è¯¢
- [x] ä¼˜åŒ–å‰ç«¯å­¦åˆ†æ˜¾ç¤º
- [x] åŒºåˆ†ä¼ä¸šå­¦åˆ†å’Œä¸ªäººå­¦åˆ†
- [x] è®¡ç®—æ€»å¯ç”¨å­¦åˆ†
- [x] æ›´æ–°å›¾æ ‡å’Œæ ·å¼
- [x] æµ‹è¯•éªŒè¯åŠŸèƒ½

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **å­¦åˆ†è¯¦æƒ…é¡µé¢**ï¼š
   - æ˜¾ç¤ºå­¦åˆ†ä½¿ç”¨è®°å½•
   - åŒºåˆ†ä¼ä¸šå­¦åˆ†å’Œä¸ªäººå­¦åˆ†çš„ä½¿ç”¨å†å²
   - å›¾è¡¨å±•ç¤ºå­¦åˆ†è¶‹åŠ¿

2. **å­¦åˆ†é€šçŸ¥**ï¼š
   - ä¼ä¸šå­¦åˆ†åˆ†é…é€šçŸ¥
   - å­¦åˆ†ä¸è¶³æé†’
   - å­¦åˆ†å³å°†åˆ°æœŸæé†’

3. **å­¦åˆ†æœ‰æ•ˆæœŸ**ï¼š
   - æ”¯æŒè®¾ç½®ä¼ä¸šå­¦åˆ†æœ‰æ•ˆæœŸ
   - è¿‡æœŸå­¦åˆ†è‡ªåŠ¨å›æ”¶
   - æœ‰æ•ˆæœŸæé†’












