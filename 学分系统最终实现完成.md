# å­¦åˆ†ç³»ç»Ÿæœ€ç»ˆå®ç°å®Œæˆ

## ğŸ¯ æœ€ç»ˆéœ€æ±‚ç¡®è®¤

### å­¦åˆ†ç³»ç»Ÿæ ¸å¿ƒè§„åˆ™

1. **å­¦åˆ†ä¸å¯ç›´æ¥è½¬èµ **
   - âŒ ç”¨æˆ·ä¹‹é—´ä¸èƒ½ç›´æ¥è½¬èµ å­¦åˆ†
   - âœ… å”¯ä¸€ä¾‹å¤–ï¼šä¼ä¸šç®¡ç†å‘˜å¯ä»¥åˆ†é…å­¦åˆ†ç»™ä¼ä¸šå‘˜å·¥

2. **èµ é€è¯¾ç¨‹åŠŸèƒ½**
   - âœ… **ä¸ªäººå­¦åˆ†**ï¼šå¯ä»¥ä½¿ç”¨å­¦åˆ†èµ é€è¯¾ç¨‹ç»™ä»–äºº
   - âŒ **é”å®šå­¦åˆ†**ï¼šåªèƒ½è‡ªå·±è´­ä¹°è¯¾ç¨‹ï¼Œä¸èƒ½èµ é€è¯¾ç¨‹

3. **å­¦åˆ†ç±»å‹**
   ```
   æ€»å­¦åˆ† = ä¸ªäººå­¦åˆ† + é”å®šå­¦åˆ†
   ```

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

### Credit è¡¨ç»“æ„

```prisma
model Credit {
  id              String   @id @default(uuid())
  userId          String   @unique
  balance         Int      @default(0)  // å½“å‰å­¦åˆ†ä½™é¢ï¼ˆç»Ÿä¸€ä½™é¢ï¼‰
  total           Int      @default(0)  // ç´¯è®¡è·å¾—å­¦åˆ†ï¼ˆç»Ÿä¸€æ€»æ•°ï¼‰
  used            Int      @default(0)  // ç´¯è®¡æ¶ˆè€—å­¦åˆ†ï¼ˆç»Ÿä¸€æ¶ˆè€—ï¼‰
  
  personalBalance Int      @default(0)  // ä¸ªäººå­¦åˆ†ä½™é¢ï¼ˆå¯ç”¨äºèµ é€è¯¾ç¨‹ï¼‰
  lockedBalance   Int      @default(0)  // é”å®šå­¦åˆ†ä½™é¢ï¼ˆä¼ä¸šåˆ†é…ï¼Œåªèƒ½è´­è¯¾ä¸å¯èµ è¯¾ï¼‰
  
  // å…³ç³»ï¼šbalance = personalBalance + lockedBalance
}
```

### å­¦åˆ†ç±»å‹å¯¹æ¯”

| å±æ€§ | ä¸ªäººå­¦åˆ† | é”å®šå­¦åˆ† |
|------|---------|---------|
| **æ¥æº** | ç®¡ç†å‘˜å……å€¼ã€è¯¾ç¨‹å®Œæˆå¥–åŠ± | ä¼ä¸šç®¡ç†å‘˜åˆ†é… |
| **è‡ªå·±è´­è¯¾** | âœ… | âœ… |
| **èµ é€è¯¾ç¨‹** | âœ… | âŒ |
| **ç›´æ¥è½¬èµ ** | âŒ | âŒ |
| **å­—æ®µå** | `personalBalance` | `lockedBalance` |

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. åç«¯æœåŠ¡æ›´æ–° âœ…

#### A. credits.service.ts

**consumeCredit** - æ¶ˆè€—å­¦åˆ†ï¼ˆæŠ¥åè¯¾ç¨‹ï¼‰
```typescript
// ä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼Œä¸è¶³æ—¶ä½¿ç”¨ä¸ªäººå­¦åˆ†
const lockedUsed = Math.min(credit.lockedBalance, amount);
const personalUsed = amount - lockedUsed;

await this.prisma.credit.update({
  data: {
    balance: credit.balance - amount,
    used: credit.used + amount,
    lockedBalance: credit.lockedBalance - lockedUsed,
    personalBalance: credit.personalBalance - personalUsed,
  },
});
```

**addCredit** - å¢åŠ å­¦åˆ†
```typescript
// isLocked=true: å¢åŠ é”å®šå­¦åˆ†
// isLocked=false: å¢åŠ ä¸ªäººå­¦åˆ†
const newPersonal = isLocked ? credit.personalBalance : credit.personalBalance + amount;
const newLocked = isLocked ? credit.lockedBalance + amount : credit.lockedBalance;
```

**refundCredit** - é€€å›å­¦åˆ†
```typescript
// é€€å›åˆ°ä¸ªäººå­¦åˆ†ï¼ˆç®€åŒ–å¤„ç†ï¼‰
await this.prisma.credit.update({
  data: {
    balance: credit.balance + amount,
    used: credit.used - amount,
    personalBalance: credit.personalBalance + amount,
  },
});
```

**deduct** - æ‰£é™¤å­¦åˆ†
```typescript
// ä¼˜å…ˆæ‰£é™¤ä¸ªäººå­¦åˆ†ï¼Œä¸è¶³æ—¶æ‰£é™¤é”å®šå­¦åˆ†
const personalDeduct = Math.min(credit.personalBalance, amount);
const lockedDeduct = amount - personalDeduct;
```

#### B. corporate-credits.service.ts

**allocateCredit** - ä¼ä¸šç®¡ç†å‘˜åˆ†é…å­¦åˆ†
```typescript
// æ£€æŸ¥ç®¡ç†å‘˜çš„ä¸ªäººå­¦åˆ†
if (adminCredit.personalBalance < amount) {
  throw new BadRequestException('æ‚¨çš„ä¸ªäººå­¦åˆ†ä¸è¶³');
}

// æ‰£é™¤ç®¡ç†å‘˜çš„ä¸ªäººå­¦åˆ†ï¼Œå¢åŠ å‘˜å·¥çš„é”å®šå­¦åˆ†
await this.prisma.$transaction(async (tx) => {
  // 1. æ‰£é™¤ç®¡ç†å‘˜ä¸ªäººå­¦åˆ†
  await tx.credit.update({
    where: { userId: adminId },
    data: {
      balance: { decrement: amount },
      personalBalance: { decrement: amount },
    },
  });
  
  // 2. å¢åŠ å‘˜å·¥é”å®šå­¦åˆ†
  await tx.credit.update({
    where: { userId: employeeId },
    data: {
      balance: { increment: amount },
      lockedBalance: { increment: amount },
    },
  });
});
```

**getEmployees** - è·å–ä¼ä¸šå‘˜å·¥
```typescript
return employees.map(emp => ({
  totalBalance: emp.credit?.balance || 0,
  personalBalance: emp.credit?.personalBalance || 0,  // å¯èµ è¯¾
  lockedBalance: emp.credit?.lockedBalance || 0,      // ä¸å¯èµ è¯¾
}));
```

#### C. enrollments.service.ts

**enroll** - æŠ¥åè¯¾ç¨‹
```typescript
// æ£€æŸ¥æ€»ä½™é¢
if (userCredit.balance < requiredCredit) {
  return {
    message: `å­¦åˆ†ä¸è¶³ï¼Œå½“å‰${userCredit.balance}ï¼ˆé”å®š${userCredit.lockedBalance}+ä¸ªäºº${userCredit.personalBalance}ï¼‰ï¼Œéœ€è¦${requiredCredit}å­¦åˆ†`,
  };
}
```

### 2. å‰ç«¯æ›´æ–° âœ…

#### A. ä¸ªäººä¸­å¿ƒ (frontend-uniapp/pages/mine/index.vue)

```vue
<!-- æ€»å­¦åˆ† -->
<view class="credit-item">
  <Icon name="star" color="#FFD700" />
  <text>{{ credits.balance }}</text>
  <text>æ€»å­¦åˆ†</text>
</view>

<!-- ä¸ªäººå­¦åˆ†ï¼ˆå¯èµ è¯¾ï¼‰-->
<view class="credit-item">
  <Icon name="user" color="#52C41A" />
  <text>{{ credits.personalBalance }}</text>
  <text>ä¸ªäººå­¦åˆ†</text>
  <text class="tip">å¯èµ è¯¾</text>
</view>

<!-- é”å®šå­¦åˆ†ï¼ˆåªèƒ½è´­è¯¾ï¼‰-->
<view class="credit-item">
  <Icon name="work" color="#FF6B6B" />
  <text>{{ credits.lockedBalance }}</text>
  <text>é”å®šå­¦åˆ†</text>
  <text class="tip">åªèƒ½è´­è¯¾</text>
</view>
```

### 3. æ•°æ®åº“è¿ç§»è„šæœ¬ âœ…

**æ–‡ä»¶**: `backend/prisma/migrations/20251116_final_credit_system.sql`

```sql
-- æ·»åŠ æ–°å­—æ®µ
ALTER TABLE `credits` 
ADD COLUMN `personalBalance` INT NOT NULL DEFAULT 0 COMMENT 'ä¸ªäººå­¦åˆ†ä½™é¢ï¼ˆå¯èµ è¯¾ï¼‰',
ADD COLUMN `lockedBalance` INT NOT NULL DEFAULT 0 COMMENT 'é”å®šå­¦åˆ†ä½™é¢ï¼ˆåªèƒ½è´­è¯¾ï¼‰';

-- è¿ç§»æ•°æ®
UPDATE `credits` 
SET 
  `balance` = COALESCE(`balance`, 0) + COALESCE(`corporateBalance`, 0),
  `personalBalance` = COALESCE(`balance`, 0),
  `lockedBalance` = COALESCE(`corporateBalance`, 0);
```

## ğŸ”„ å­¦åˆ†æµè½¬ç¤ºä¾‹

### åœºæ™¯ 1ï¼šä¼ä¸šç®¡ç†å‘˜åˆ†é…å­¦åˆ†

```
ä¼ä¸šç®¡ç†å‘˜ Aï¼š
- ä¸ªäººå­¦åˆ†ï¼š100
- é”å®šå­¦åˆ†ï¼š0

æ“ä½œï¼šåˆ†é… 10 å­¦åˆ†ç»™å‘˜å·¥ B

ç»“æœï¼š
ç®¡ç†å‘˜ Aï¼š
- ä¸ªäººå­¦åˆ†ï¼š100 â†’ 90ï¼ˆå‡å°‘ 10ï¼‰
- é”å®šå­¦åˆ†ï¼š0ï¼ˆä¸å˜ï¼‰
- æ€»å­¦åˆ†ï¼š100 â†’ 90

å‘˜å·¥ Bï¼š
- ä¸ªäººå­¦åˆ†ï¼š50ï¼ˆä¸å˜ï¼‰
- é”å®šå­¦åˆ†ï¼š0 â†’ 10ï¼ˆå¢åŠ  10ï¼‰
- æ€»å­¦åˆ†ï¼š50 â†’ 60

å‘˜å·¥ B çš„è¿™ 10 å­¦åˆ†ï¼š
âœ… å¯ä»¥ç”¨æ¥æŠ¥åè¯¾ç¨‹
âŒ ä¸èƒ½ç”¨æ¥èµ é€è¯¾ç¨‹
```

### åœºæ™¯ 2ï¼šæŠ¥åè¯¾ç¨‹ï¼ˆä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼‰

```
ç”¨æˆ·å­¦åˆ†ï¼š
- é”å®šå­¦åˆ†ï¼š15
- ä¸ªäººå­¦åˆ†ï¼š10
- æ€»å­¦åˆ†ï¼š25

æŠ¥åéœ€è¦ 20 å­¦åˆ†ï¼š

æ‰£é™¤æ–¹æ¡ˆï¼š
1. ä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼š15
2. ä¸è¶³éƒ¨åˆ†ä½¿ç”¨ä¸ªäººå­¦åˆ†ï¼š5
3. æ€»æ¶ˆè€—ï¼š20

å‰©ä½™ï¼š
- é”å®šå­¦åˆ†ï¼š0
- ä¸ªäººå­¦åˆ†ï¼š5
- æ€»å­¦åˆ†ï¼š5
```

### åœºæ™¯ 3ï¼šèµ é€è¯¾ç¨‹ï¼ˆåªèƒ½ä½¿ç”¨ä¸ªäººå­¦åˆ†ï¼‰

```
ç”¨æˆ· A å­¦åˆ†ï¼š
- é”å®šå­¦åˆ†ï¼š20
- ä¸ªäººå­¦åˆ†ï¼š10
- æ€»å­¦åˆ†ï¼š30

èµ é€è¯¾ç¨‹ç»™ç”¨æˆ· Bï¼Œéœ€è¦ 5 å­¦åˆ†ï¼š

æ£€æŸ¥ï¼š
âœ… ä¸ªäººå­¦åˆ†ï¼ˆ10ï¼‰è¶³å¤Ÿ
âœ… å¯ä»¥èµ é€

æ‰£é™¤ï¼š
- é”å®šå­¦åˆ†ï¼š20ï¼ˆä¸å˜ï¼Œä¸èƒ½ç”¨äºèµ è¯¾ï¼‰
- ä¸ªäººå­¦åˆ†ï¼š10 â†’ 5ï¼ˆå‡å°‘ 5ï¼‰
- æ€»å­¦åˆ†ï¼š30 â†’ 25

ç”¨æˆ· B è·å¾—ï¼š
- è¯¾ç¨‹æŠ¥åèµ„æ ¼ï¼ˆä¸æ˜¯å­¦åˆ†ï¼‰
```

å¦‚æœä¸ªäººå­¦åˆ†ä¸è¶³ï¼š
```
ç”¨æˆ· C å­¦åˆ†ï¼š
- é”å®šå­¦åˆ†ï¼š20
- ä¸ªäººå­¦åˆ†ï¼š3
- æ€»å­¦åˆ†ï¼š23

èµ é€è¯¾ç¨‹éœ€è¦ 5 å­¦åˆ†ï¼š
âŒ ä¸ªäººå­¦åˆ†ï¼ˆ3ï¼‰ä¸è¶³
âŒ ä¸èƒ½ä½¿ç”¨é”å®šå­¦åˆ†èµ è¯¾
â†’ æ— æ³•èµ é€
```

## ğŸ“‹ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

åœ¨æ•°æ®åº“ç®¡ç†å·¥å…·ä¸­æ‰§è¡Œï¼š
```bash
backend/prisma/migrations/20251116_final_credit_system.sql
```

æˆ–ä½¿ç”¨å‘½ä»¤è¡Œï¼š
```bash
mysql -u root -p edp_db < backend/prisma/migrations/20251116_final_credit_system.sql
```

### æ­¥éª¤ 2: å·²å®Œæˆ âœ…

```bash
cd backend
npx prisma generate
```

### æ­¥éª¤ 3: é‡å¯æœåŠ¡

```bash
# åç«¯
cd backend
npm run start:dev

# å‰ç«¯ï¼ˆå°ç¨‹åºï¼‰
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ç‚¹å‡»"ç¼–è¯‘"
```

## ğŸ§ª æµ‹è¯•æ¸…å•

### 1. å­¦åˆ†æ˜¾ç¤º âœ“
- [ ] ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºï¼šæ€»å­¦åˆ†ã€ä¸ªäººå­¦åˆ†ã€é”å®šå­¦åˆ†
- [ ] ä¸ªäººå­¦åˆ†æ˜¾ç¤º"å¯èµ è¯¾"æç¤º
- [ ] é”å®šå­¦åˆ†æ˜¾ç¤º"åªèƒ½è´­è¯¾"æç¤º
- [ ] æ•°å­—æ­£ç¡®ï¼š`balance = personalBalance + lockedBalance`

### 2. æŠ¥åè¯¾ç¨‹ âœ“
- [ ] æœ‰é”å®šå­¦åˆ†ï¼šä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†
- [ ] é”å®šå­¦åˆ†ä¸è¶³ï¼šä½¿ç”¨é”å®šå­¦åˆ† + ä¸ªäººå­¦åˆ†
- [ ] å­¦åˆ†ä¸è¶³ï¼šæ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æç¤ºï¼ˆåŒºåˆ†é”å®šå’Œä¸ªäººï¼‰

### 3. ä¼ä¸šç®¡ç†å‘˜åˆ†é… âœ“
- [ ] æ£€æŸ¥ç®¡ç†å‘˜çš„ä¸ªäººå­¦åˆ†ä½™é¢
- [ ] æ‰£é™¤ç®¡ç†å‘˜çš„ä¸ªäººå­¦åˆ†
- [ ] å¢åŠ å‘˜å·¥çš„é”å®šå­¦åˆ†
- [ ] é€šçŸ¥å†…å®¹ï¼š"é”å®šå­¦åˆ†ï¼Œåªèƒ½è´­è¯¾ä¸å¯èµ è¯¾"

### 4. èµ é€è¯¾ç¨‹ï¼ˆæ–°åŠŸèƒ½ï¼‰âœ“
- [ ] æ£€æŸ¥ç”¨æˆ·çš„ä¸ªäººå­¦åˆ†ä½™é¢
- [ ] åªèƒ½ä½¿ç”¨ä¸ªäººå­¦åˆ†èµ è¯¾
- [ ] é”å®šå­¦åˆ†ä¸èƒ½ç”¨äºèµ è¯¾
- [ ] ä¸ªäººå­¦åˆ†ä¸è¶³æ—¶æç¤ºé”™è¯¯

### 5. é€€è¯¾ âœ“
- [ ] é€€å›å­¦åˆ†åˆ°ä¸ªäººå­¦åˆ†ä½™é¢
- [ ] å­¦åˆ†æ•°å­—æ­£ç¡®

## ğŸ’¡ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### å­¦åˆ†æ¶ˆè´¹ä¼˜å…ˆçº§

```javascript
// æŠ¥åè¯¾ç¨‹
function enrollCourse(userId, courseId, requiredCredit) {
  const credit = getUserCredit(userId);
  
  // 1. æ£€æŸ¥æ€»ä½™é¢
  if (credit.balance < requiredCredit) {
    throw new Error('å­¦åˆ†ä¸è¶³');
  }
  
  // 2. è®¡ç®—æ‰£é™¤æ–¹æ¡ˆï¼ˆä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼‰
  const lockedUsed = Math.min(credit.lockedBalance, requiredCredit);
  const personalUsed = requiredCredit - lockedUsed;
  
  // 3. æ‰£é™¤å­¦åˆ†
  updateCredit(userId, {
    balance: credit.balance - requiredCredit,
    lockedBalance: credit.lockedBalance - lockedUsed,
    personalBalance: credit.personalBalance - personalUsed,
  });
}
```

### èµ é€è¯¾ç¨‹é€»è¾‘

```javascript
// èµ é€è¯¾ç¨‹ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
function giftCourse(fromUserId, toUserId, courseId, requiredCredit) {
  const credit = getUserCredit(fromUserId);
  
  // 1. åªæ£€æŸ¥ä¸ªäººå­¦åˆ†ä½™é¢
  if (credit.personalBalance < requiredCredit) {
    throw new Error(`ä¸ªäººå­¦åˆ†ä¸è¶³ï¼Œå½“å‰: ${credit.personalBalance}ï¼Œéœ€è¦: ${requiredCredit}`);
  }
  
  // 2. åªæ‰£é™¤ä¸ªäººå­¦åˆ†ï¼ˆä¸èƒ½ä½¿ç”¨é”å®šå­¦åˆ†ï¼‰
  updateCredit(fromUserId, {
    balance: credit.balance - requiredCredit,
    personalBalance: credit.personalBalance - requiredCredit,
  });
  
  // 3. ä¸ºæ¥æ”¶æ–¹æŠ¥åè¯¾ç¨‹
  enrollCourse(toUserId, courseId);
}
```

### ä¼ä¸šç®¡ç†å‘˜åˆ†é…é€»è¾‘

```javascript
// ä¼ä¸šç®¡ç†å‘˜åˆ†é…å­¦åˆ†ç»™å‘˜å·¥
function allocateCredit(adminId, employeeId, amount) {
  const adminCredit = getUserCredit(adminId);
  
  // 1. æ£€æŸ¥ç®¡ç†å‘˜çš„ä¸ªäººå­¦åˆ†
  if (adminCredit.personalBalance < amount) {
    throw new Error('æ‚¨çš„ä¸ªäººå­¦åˆ†ä¸è¶³');
  }
  
  // 2. æ‰£é™¤ç®¡ç†å‘˜çš„ä¸ªäººå­¦åˆ†
  updateCredit(adminId, {
    balance: adminCredit.balance - amount,
    personalBalance: adminCredit.personalBalance - amount,
  });
  
  // 3. å¢åŠ å‘˜å·¥çš„é”å®šå­¦åˆ†ï¼ˆä¸å¯èµ è¯¾ï¼‰
  const employeeCredit = getUserCredit(employeeId);
  updateCredit(employeeId, {
    balance: employeeCredit.balance + amount,
    lockedBalance: employeeCredit.lockedBalance + amount,  // ä½œä¸ºé”å®šå­¦åˆ†
  });
}
```

## ğŸ¯ å…³é”®ç‰¹æ€§æ€»ç»“

1. âœ… **ç»Ÿä¸€å­¦åˆ†ä½™é¢**ï¼šç”¨æˆ·åªçœ‹åˆ°ä¸€ä¸ªæ€»å­¦åˆ†æ•°å­—
2. âœ… **æ¸…æ™°åŒºåˆ†ç±»å‹**ï¼šä¸ªäººå­¦åˆ†ï¼ˆå¯èµ è¯¾ï¼‰vs é”å®šå­¦åˆ†ï¼ˆåªèƒ½è´­è¯¾ï¼‰
3. âœ… **åˆç†çš„æ¶ˆè´¹ä¼˜å…ˆçº§**ï¼šä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼ˆé¼“åŠ±ä½¿ç”¨ä¼ä¸šå­¦åˆ†ï¼‰
4. âœ… **çµæ´»çš„ä¼ä¸šç®¡ç†**ï¼šä¼ä¸šç®¡ç†å‘˜å¯ä»¥åˆ†é…å­¦åˆ†ç»™å‘˜å·¥
5. âœ… **é˜²æ­¢æ»¥ç”¨**ï¼šé”å®šå­¦åˆ†ä¸èƒ½ç”¨äºèµ è¯¾ï¼Œé˜²æ­¢ä¼ä¸šå­¦åˆ†è¢«æ»¥ç”¨

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… Schema æ›´æ–°å®Œæˆ
2. âœ… åç«¯ä»£ç æ›´æ–°å®Œæˆ
3. âœ… å‰ç«¯ä»£ç æ›´æ–°å®Œæˆ
4. âœ… Prisma Client ç”Ÿæˆå®Œæˆ
5. â³ æ‰§è¡Œæ•°æ®åº“è¿ç§»
6. â³ æµ‹è¯•éªŒè¯
7. â³ éƒ¨ç½²ä¸Šçº¿

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-16  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œç­‰å¾…æ•°æ®åº“è¿ç§»








