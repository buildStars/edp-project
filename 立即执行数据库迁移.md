# ⚠️ 立即执行数据库迁移

## 🚨 当前问题

数据库中还没有 `personalBalance` 和 `lockedBalance` 字段，需要立即执行迁移！

## 🔧 快速执行步骤

### 方法 1：复制 SQL 直接执行（推荐）

**打开你的数据库管理工具（如 Navicat、phpMyAdmin、MySQL Workbench 等）**

执行以下 SQL：

```sql
-- 1. 添加新字段
ALTER TABLE `credits` 
ADD COLUMN `personalBalance` INT NOT NULL DEFAULT 0 COMMENT '个人学分余额（可赠课）',
ADD COLUMN `lockedBalance` INT NOT NULL DEFAULT 0 COMMENT '锁定学分余额（只能购课）';

-- 2. 迁移现有数据
UPDATE `credits` 
SET 
  `balance` = COALESCE(`balance`, 0) + COALESCE(`corporateBalance`, 0),
  `total` = COALESCE(`total`, 0) + COALESCE(`corporateTotal`, 0),
  `personalBalance` = COALESCE(`balance`, 0),
  `lockedBalance` = COALESCE(`corporateBalance`, 0)
WHERE TRUE;

-- 3. 验证数据（可选）
SELECT 
  COUNT(*) as total_users,
  SUM(balance) as total_balance,
  SUM(personalBalance) as total_personal,
  SUM(lockedBalance) as total_locked
FROM `credits`;
```

### 方法 2：使用 MySQL 命令行

```bash
# 进入 MySQL
mysql -u root -p

# 选择数据库
USE edp_db;

# 执行以下 SQL
ALTER TABLE `credits` 
ADD COLUMN `personalBalance` INT NOT NULL DEFAULT 0,
ADD COLUMN `lockedBalance` INT NOT NULL DEFAULT 0;

UPDATE `credits` 
SET 
  `balance` = COALESCE(`balance`, 0) + COALESCE(`corporateBalance`, 0),
  `total` = COALESCE(`total`, 0) + COALESCE(`corporateTotal`, 0),
  `personalBalance` = COALESCE(`balance`, 0),
  `lockedBalance` = COALESCE(`corporateBalance`, 0);

# 验证
SELECT * FROM `credits` LIMIT 5;

# 退出
EXIT;
```

### 方法 3：使用 Prisma 执行文件（如果有权限）

```bash
cd D:\edp-project\backend
mysql -u root -p edp_db < prisma/migrations/20251116_final_credit_system.sql
```

## ✅ 执行后验证

执行完毕后，在数据库中查看：

```sql
-- 查看字段是否添加成功
DESCRIBE credits;

-- 查看数据是否迁移成功
SELECT 
  userId,
  balance,
  personalBalance,
  lockedBalance,
  (personalBalance + lockedBalance) as should_equal_balance
FROM credits 
LIMIT 10;
```

**预期结果**：
- `personalBalance` 列存在 ✅
- `lockedBalance` 列存在 ✅
- `balance = personalBalance + lockedBalance` ✅

## 🚀 迁移完成后

1. **刷新浏览器**（前端）
2. **后端会自动重启**（如果使用 `npm run start:dev`）

## 📊 示例数据

迁移前：
```
userId: user-123
balance: 100
corporateBalance: 344
total: 100
corporateTotal: 344
```

迁移后：
```
userId: user-123
balance: 444              (100 + 344)
personalBalance: 100      (原 balance)
lockedBalance: 344        (原 corporateBalance)
total: 444                (100 + 344)
```

## ⚠️ 重要提示

1. **建议先备份数据库**（如果是生产环境）
2. 迁移脚本是**安全的**，只添加字段和迁移数据，不删除任何数据
3. 旧字段（`corporateBalance`、`corporateTotal`、`corporateUsed`）会保留，可以稍后手动删除
4. 如果迁移失败，旧字段中的数据依然存在，可以重新执行

## 🆘 遇到问题？

### 错误：字段已存在
```
Error: Duplicate column name 'personalBalance'
```
**解决**：说明字段已经添加过了，跳过 ALTER TABLE，直接执行 UPDATE 语句。

### 错误：没有权限
```
Error: Access denied
```
**解决**：
1. 使用 root 用户执行
2. 或者授予 `edp_user` 用户 ALTER 权限：
```sql
GRANT ALTER ON edp_db.* TO 'edp_user'@'localhost';
FLUSH PRIVILEGES;
```

### 数据不一致
```
balance != personalBalance + lockedBalance
```
**解决**：重新执行 UPDATE 语句。

---

**执行完毕后，系统就可以正常使用了！** 🎉











