# 教师角色权限流程梳理与优化

## 📋 当前教师权限现状

### 现有权限列表
```typescript
TEACHER: [
  'dashboard:view',              // ✅ 查看首页
  'my-courses:view',             // ✅ 查看我的课程
  'my-students:view',            // ✅ 查看我的学员
  'courses:view',                // ⚠️ 查看所有课程（需限制）
  'courses:create',              // ✅ 创建课程
  'courses:edit',                // ✅ 编辑课程
  'chapters:view',               // ✅ 查看章节
  'chapters:manage',             // ✅ 管理章节
  'users:view',                  // ⚠️ 查看所有用户（需限制）
  'enrollments:view',            // ⚠️ 查看所有报名（需限制）
  'enrollments:checkin',         // ✅ 签到管理
  'enrollments:evaluation',      // ✅ 评价管理
  'courseware:view',             // ✅ 查看课件
  'courseware:upload',           // ✅ 上传课件
  'statistics:view',             // ✅ 查看统计
]
```

## 🔍 问题分析

### 1. 权限范围过大的问题

#### ❌ 问题1: 可以查看所有课程
**现状**: `courses:view` 允许教师查看所有课程  
**问题**: 教师应该只能查看自己的课程  
**影响**: 可以看到其他教师的课程列表

#### ❌ 问题2: 可以查看所有用户
**现状**: `users:view` 允许教师查看所有用户  
**问题**: 教师应该只能查看自己课程的学员  
**影响**: 可以访问用户管理页面，查看所有用户信息

#### ❌ 问题3: 可以查看所有报名记录
**现状**: `enrollments:view` 允许教师查看所有报名  
**问题**: 教师应该只能查看自己课程的报名  
**影响**: 可以看到其他课程的报名情况

### 2. 缺失的必要权限

#### ❌ 缺失1: 无法删除课件
**现状**: 只有 `courseware:upload`，没有 `courseware:delete`  
**问题**: 教师上传错误的课件后无法删除  
**需要**: 添加 `courseware:delete` 权限

#### ❌ 缺失2: 无法管理自己课程的章节
**现状**: 虽然有 `chapters:manage`，但可能受到其他限制  
**问题**: 需要确保教师可以管理自己课程的章节  

## 🎯 合理的教师权限流程

### 教师应该能做什么？

#### 1. 课程管理（仅自己的课程）
```
✅ 创建课程（自动设为草稿）
✅ 编辑自己的草稿课程
✅ 提交审批
✅ 查看自己的课程列表
✅ 管理自己课程的章节
✅ 上传/删除自己课程的课件
❌ 查看其他教师的课程
❌ 编辑其他教师的课程
❌ 直接发布课程（需审批）
```

#### 2. 学员管理（仅自己课程的学员）
```
✅ 查看报名了自己课程的学员
✅ 查看学员的签到记录
✅ 查看学员的评价
✅ 开启/结束签到
✅ 给学员补签
❌ 查看所有用户列表
❌ 查看其他课程的学员
❌ 修改学员信息
```

#### 3. 报名管理（仅自己的课程）
```
✅ 查看自己课程的报名记录
✅ 查看报名学员的详细信息
❌ 查看所有课程的报名
❌ 审批报名申请（管理员权限）
❌ 处理退课申请（管理员权限）
```

#### 4. 签到管理（仅自己的课程）
```
✅ 开启签到
✅ 结束签到
✅ 查看签到统计
✅ 补签/批量补签
❌ 查看其他课程的签到
```

#### 5. 评价管理（仅自己的课程）
```
✅ 查看自己课程的评价
✅ 查看评价统计
✅ 查看评分分布
❌ 查看其他课程的评价
```

#### 6. 数据统计
```
✅ 查看首页看板（只显示自己的数据）
✅ 查看自己的课程统计
✅ 查看自己的学员统计
❌ 查看全局统计数据
```

## 💡 优化方案

### 方案A：细化权限（推荐）

创建更细粒度的权限：

```typescript
TEACHER: [
  // 首页
  'dashboard:view',              // 查看首页（只显示自己的数据）
  
  // 教师专属
  'my-courses:view',             // 我的课程列表
  'my-courses:create',           // 创建课程
  'my-courses:edit',             // 编辑自己的课程
  'my-courses:submit',           // 提交审批
  'my-students:view',            // 我的学员列表
  
  // 课程相关（限制为自己的课程）
  'courses:view',                // 查看课程（需后端过滤）
  'courses:create',              // 创建课程
  'courses:edit',                // 编辑课程（需后端验证所有权）
  'chapters:view',               // 查看章节
  'chapters:manage',             // 管理章节（需后端验证所有权）
  
  // 学员相关（限制为自己课程的学员）
  'my-course-students:view',     // 查看自己课程的学员（新增）
  
  // 报名相关（限制为自己的课程）
  'my-course-enrollments:view',  // 查看自己课程的报名（新增）
  
  // 签到相关
  'enrollments:checkin',         // 签到管理
  
  // 评价相关
  'enrollments:evaluation',      // 评价管理
  
  // 课件相关
  'courseware:view',             // 查看课件
  'courseware:upload',           // 上传课件
  'courseware:delete',           // 删除课件（新增）
  
  // 统计
  'statistics:view',             // 查看统计（后端过滤为自己的数据）
]
```

### 方案B：简化权限 + 后端过滤（当前方案）

保持现有权限，在后端逻辑中进行数据过滤：

```typescript
TEACHER: [
  'dashboard:view',              
  'my-courses:view',             
  'my-students:view',            
  'courses:view',                // 后端只返回自己的课程
  'courses:create',              
  'courses:edit',                // 后端验证所有权
  'chapters:view',               
  'chapters:manage',             // 后端验证所有权
  'users:view',                  // 后端只返回自己课程的学员
  'enrollments:view',            // 后端只返回自己课程的报名
  'enrollments:checkin',         
  'enrollments:evaluation',      
  'courseware:view',             
  'courseware:upload',           
  'courseware:delete',           // 新增
  'statistics:view',             // 后端只返回自己的数据
]
```

## 🔧 需要实施的修改

### 1. 权限配置修改

#### 添加课件删除权限
```typescript
// backend/prisma/seeds/permissions.seed.ts
TEACHER: [
  // ... 现有权限
  'courseware:delete',  // ✅ 新增
]
```

### 2. 后端数据过滤

#### 2.1 课程列表过滤
```typescript
// backend/src/modules/courses/courses.controller.ts
@Get()
async findAll(@Query() query: QueryCourseDto, @CurrentUser() user: any) {
  // 如果是教师，只返回自己的课程
  if (user.role === 'TEACHER') {
    query.teacherId = user.id;  // ✅ 添加教师过滤
  }
  return this.coursesService.findAll(query);
}
```

#### 2.2 用户列表过滤
```typescript
// backend/src/modules/users/users.controller.ts
@Get()
async findAll(@Query() query: any, @CurrentUser() user: any) {
  if (user.role === 'TEACHER') {
    // 教师只能查看自己课程的学员
    return this.usersService.findTeacherStudents(user.id, query);
  }
  return this.usersService.findAll(query);
}
```

#### 2.3 报名记录过滤
```typescript
// backend/src/modules/enrollments/enrollments.controller.ts
@Get()
async findAll(@Query() query: any, @CurrentUser() user: any) {
  if (user.role === 'TEACHER') {
    // 教师只能查看自己课程的报名
    return this.enrollmentsService.findTeacherEnrollments(user.id, query);
  }
  return this.enrollmentsService.findAll(query);
}
```

#### 2.4 统计数据过滤
```typescript
// backend/src/modules/statistics/statistics.service.ts
async getDashboardStatistics(userId?: string, userRole?: string) {
  if (userRole === 'TEACHER') {
    // 教师只显示自己的统计数据
    return this.getTeacherStatistics(userId);
  }
  return this.getGlobalStatistics();
}
```

### 3. 前端菜单配置

#### 隐藏不应该看到的菜单
```typescript
// admin-frontend/src/config/permissions.ts
{
  path: '/users/list',
  title: '用户列表',
  permission: 'users:view',
  hidden: (role) => role === 'TEACHER',  // ✅ 教师隐藏用户列表
},
{
  path: '/enrollments/list',
  title: '报名列表',
  permission: 'enrollments:view',
  hidden: (role) => role === 'TEACHER',  // ✅ 教师隐藏全局报名列表
},
```

## 📊 优化后的权限对比

| 功能 | 管理员 | 教务 | 教师（优化前） | 教师（优化后） |
|-----|--------|------|--------------|--------------|
| 查看所有课程 | ✅ | ✅ | ✅ ❌ | ❌ |
| 查看自己的课程 | ✅ | ✅ | ✅ | ✅ |
| 创建课程 | ✅ | ✅ | ✅ | ✅ |
| 直接发布课程 | ✅ | ✅ | ❌ | ❌ |
| 审批课程 | ✅ | ✅ | ❌ | ❌ |
| 查看所有用户 | ✅ | ✅ | ✅ ❌ | ❌ |
| 查看自己的学员 | ✅ | ✅ | ✅ | ✅ |
| 查看所有报名 | ✅ | ✅ | ✅ ❌ | ❌ |
| 查看自己课程报名 | ✅ | ✅ | ✅ | ✅ |
| 签到管理 | ✅ | ✅ | ✅ | ✅ |
| 评价管理 | ✅ | ✅ | ✅ | ✅ |
| 删除课件 | ✅ | ✅ | ❌ | ✅ |
| 全局统计 | ✅ | ✅ | ✅ ❌ | ❌ |
| 个人统计 | ✅ | ✅ | ✅ | ✅ |

## 🎯 推荐实施方案

### 采用方案B（简化 + 后端过滤）

**理由**：
1. 权限配置简单，易于维护
2. 后端统一过滤，安全性高
3. 前端无需复杂的权限判断
4. 扩展性好

### 实施步骤

#### 第一阶段：权限优化（立即实施）
1. ✅ 添加 `courseware:delete` 权限
2. ✅ 为教师角色所有接口添加 `TEACHER` 角色（已完成）

#### 第二阶段：数据过滤（重要）
1. ⚠️ 课程列表接口：添加教师过滤
2. ⚠️ 用户列表接口：教师只能看自己的学员
3. ⚠️ 报名列表接口：教师只能看自己课程的报名
4. ⚠️ 统计接口：教师只显示自己的数据
5. ⚠️ 签到接口：添加课程所有权验证
6. ⚠️ 评价接口：添加课程所有权验证
7. ⚠️ 课件接口：添加课程所有权验证

#### 第三阶段：前端优化（可选）
1. 隐藏教师不应该看到的菜单
2. 优化"我的课程"页面体验
3. 添加数据权限提示

## ✅ 立即需要修改的内容

### 1. 添加课件删除权限
```typescript
// backend/prisma/seeds/permissions.seed.ts
'courseware:delete',  // 添加到 TEACHER 权限列表
```

### 2. 课件删除接口添加 TEACHER 角色
```typescript
// backend/src/modules/materials/materials.controller.ts
@Roles('ADMIN', 'STAFF', 'TEACHER')  // 添加 TEACHER
```

### 3. 后端接口添加数据过滤
- 课程列表：只返回 teacherId = 当前用户ID 的课程
- 用户列表：只返回报名了自己课程的学员
- 报名列表：只返回自己课程的报名记录
- 统计数据：只计算自己的课程数据

### 4. 前端菜单优化
- 隐藏"用户管理"菜单（教师用"我的学员"代替）
- 隐藏"全局报名列表"（教师看自己课程的报名）
- 调整"课程列表"为"我的课程"

## 🔐 安全性增强

### 所有权验证（Critical）

所有涉及课程相关的操作都需要验证所有权：

```typescript
// 示例：编辑课程前验证
async update(id: string, updateDto: any, user: any) {
  // 如果是教师，验证课程所有权
  if (user.role === 'TEACHER') {
    const course = await this.prisma.course.findUnique({
      where: { id },
      select: { teacherId: true },
    });
    
    if (!course || course.teacherId !== user.id) {
      throw new ForbiddenException('无权编辑此课程');
    }
  }
  
  // 执行更新...
}
```

## 📝 总结

**现状**: 教师权限范围过大，可以访问不应该访问的数据  
**目标**: 教师只能管理自己的课程和学员  
**方案**: 保持权限配置 + 后端数据过滤 + 前端菜单优化  
**优先级**: 
1. 🔴 高优先级：后端数据过滤（安全性）
2. 🟡 中优先级：添加课件删除权限
3. 🟢 低优先级：前端菜单优化

---

**建议**: 立即实施第二阶段的数据过滤，这是安全性和用户体验的关键！














