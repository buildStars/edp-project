# è·¯ç”±å†²çªä¿®å¤è¯´æ˜ - å–æ¶ˆæ”¶è—å’Œå–æ¶ˆç‚¹èµ 403 é”™è¯¯

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨å¾®ä¿¡å°ç¨‹åºä¸­æ‰§è¡Œ"å–æ¶ˆæ”¶è—"å’Œ"å–æ¶ˆç‚¹èµ"æ“ä½œæ—¶ï¼Œé‡åˆ° **403 Forbidden** é”™è¯¯ï¼š

```json
{
  "code": 403,
  "msg": "Forbidden resource",
  "data": null,
  "timestamp": "2025-10-31T23:18:44.216Z"
}
```

**è¯·æ±‚è¯¦æƒ…ï¼š**
- `DELETE /api/news/collect` - å–æ¶ˆæ”¶è—ï¼ˆ403 Forbiddenï¼‰
- `DELETE /api/activities/like` - å–æ¶ˆç‚¹èµï¼ˆ403 Forbiddenï¼‰

## é—®é¢˜æ ¹æœ¬åŸå› 

### ğŸ¯ NestJS è·¯ç”±åŒ¹é…é¡ºåºé—®é¢˜

**å…³é”®å‘ç°ï¼š**
1. JWT Guard æ—¥å¿—æ˜¾ç¤ºç”¨æˆ·è®¤è¯é€šè¿‡ï¼ˆæœ‰ tokenï¼Œuser å­˜åœ¨ï¼‰
2. ä½† controller æ–¹æ³•ä¸­çš„ `console.log` **æ²¡æœ‰æ‰§è¡Œ**
3. è¿™è¯´æ˜è¯·æ±‚åœ¨åˆ°è¾¾ controller æ–¹æ³•ä¹‹å‰å°±è¢«æ‹¦æˆªäº†

**çœŸæ­£çš„åŸå› ï¼š**

NestJS æŒ‰ç…§**å®šä¹‰é¡ºåº**åŒ¹é…è·¯ç”±ã€‚å½“å…·ä½“è·¯å¾„ï¼ˆå¦‚ `collect`, `like`ï¼‰å®šä¹‰åœ¨é€šé…ç¬¦è·¯å¾„ï¼ˆå¦‚ `:id`ï¼‰**ä¹‹å**æ—¶ï¼Œé€šé…ç¬¦è·¯ç”±ä¼šå…ˆåŒ¹é…ã€‚

### é—®é¢˜åœºæ™¯ 1ï¼šèµ„è®¯å–æ¶ˆæ”¶è—

**åŸå§‹è·¯ç”±é¡ºåºï¼ˆé”™è¯¯ï¼‰ï¼š**
```typescript
@Controller('news')
export class NewsController {
  // ... å…¶ä»–è·¯ç”± ...
  
  @Delete(':id')           // â† ç¬¬ 68 è¡Œï¼šåŒ¹é… DELETE /api/news/:id
  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  async remove(@Param('id') id: string) { ... }
  
  // ...
  
  @Delete('collect')       // â† ç¬¬ 121 è¡Œï¼šæœŸæœ›åŒ¹é… DELETE /api/news/collect
  async uncollect(...) { ... }
}
```

**å‘ç”Ÿäº†ä»€ä¹ˆï¼š**
1. ç”¨æˆ·ï¼ˆSTUDENT è§’è‰²ï¼‰å‘é€ `DELETE /api/news/collect`
2. NestJS å…ˆåŒ¹é…åˆ° `@Delete(':id')`ï¼Œå°† `collect` å½“ä½œ `id` å‚æ•°
3. æ‰§è¡Œ `RolesGuard`ï¼Œæ£€æŸ¥ç”¨æˆ·è§’è‰²
4. å‘ç°ç”¨æˆ·æ˜¯ `STUDENT`ï¼Œä¸æ˜¯ `ADMIN` æˆ– `STAFF`
5. **è¿”å› 403 Forbidden** âŒ

### é—®é¢˜åœºæ™¯ 2ï¼šæ´»åŠ¨å–æ¶ˆç‚¹èµ

**åŸå§‹è·¯ç”±é¡ºåºï¼ˆé”™è¯¯ï¼‰ï¼š**
```typescript
@Controller('activities')
export class ActivitiesController {
  @Get(':id')              // ç¬¬ 24 è¡Œ
  async findOne(...) { ... }
  
  @Delete(':id')           // â† ç¬¬ 52 è¡Œï¼šåŒ¹é… DELETE /api/activities/:id
  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  async remove(@Param('id') id: string) { ... }
  
  @Delete('like')          // â† ç¬¬ 69 è¡Œï¼šæœŸæœ›åŒ¹é… DELETE /api/activities/like
  async unlike(...) { ... }
}
```

åŒæ ·çš„é—®é¢˜ï¼š`DELETE /api/activities/like` è¢« `@Delete(':id')` åŒ¹é…ï¼Œå¯¼è‡´æƒé™æ£€æŸ¥å¤±è´¥ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### âœ… è§£å†³æ–¹æ¡ˆï¼šè°ƒæ•´è·¯ç”±å®šä¹‰é¡ºåº

**åŸåˆ™ï¼šå…·ä½“è·¯å¾„å¿…é¡»å®šä¹‰åœ¨é€šé…ç¬¦è·¯å¾„ï¼ˆ`:id`ï¼‰ä¹‹å‰**

### ä¿®å¤ 1ï¼šNewsController

```typescript
@Controller('news')
@UseGuards(JwtAuthGuard)
export class NewsController {
  @Public()
  @Get()
  async findAll(...) { ... }

  @Get('my-collection')    // â† å…·ä½“è·¯å¾„ï¼šåœ¨ :id ä¹‹å‰
  async getMyCollection(...) { ... }

  @Public()
  @Get(':id')              // â† é€šé…ç¬¦è·¯å¾„
  async findOne(...) { ... }

  // ========== ç”¨æˆ·ç«¯æ¥å£ï¼ˆå¿…é¡»æ”¾åœ¨ç®¡ç†ç«¯çš„ :id è·¯ç”±ä¹‹å‰ï¼‰ ==========

  @Post('collect')         // â† å…·ä½“è·¯å¾„ï¼šåœ¨ :id ä¹‹å‰
  @HttpCode(200)
  async collect(...) { ... }

  @Delete('collect')       // â† å…·ä½“è·¯å¾„ï¼šåœ¨ :id ä¹‹å‰
  @HttpCode(200)
  async uncollect(...) { ... }

  // ========== ç®¡ç†åå°æ¥å£ ==========

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Post()
  async create(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Post('batch-delete')    // â† å…·ä½“è·¯å¾„ï¼šåœ¨ :id ä¹‹å‰
  async batchDelete(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Put(':id')              // â† é€šé…ç¬¦è·¯å¾„
  async update(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Put(':id/top')          // â† å­è·¯å¾„
  async toggleTop(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Put(':id/publish')      // â† å­è·¯å¾„
  async publish(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Put(':id/archive')      // â† å­è·¯å¾„
  async archive(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Delete(':id')           // â† é€šé…ç¬¦è·¯å¾„ï¼šæ”¾åœ¨æœ€å
  async remove(...) { ... }
}
```

### ä¿®å¤ 2ï¼šActivitiesController

```typescript
@Controller('activities')
@UseGuards(JwtAuthGuard)
export class ActivitiesController {
  @Public()
  @Get()
  async findAll(...) { ... }

  // ========== ç”¨æˆ·ç«¯æ¥å£ï¼ˆå¿…é¡»æ”¾åœ¨ç®¡ç†ç«¯çš„ :id è·¯ç”±ä¹‹å‰ï¼‰ ==========

  @Post('like')            // â† å…·ä½“è·¯å¾„ï¼šåœ¨ :id ä¹‹å‰
  @HttpCode(200)
  async like(...) { ... }

  @Delete('like')          // â† å…·ä½“è·¯å¾„ï¼šåœ¨ :id ä¹‹å‰
  @HttpCode(200)
  async unlike(...) { ... }

  @Public()
  @Get(':id')              // â† é€šé…ç¬¦è·¯å¾„
  async findOne(...) { ... }

  // ========== ç®¡ç†åå°æ¥å£ ==========

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Post()
  async create(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Put(':id')              // â† é€šé…ç¬¦è·¯å¾„
  async update(...) { ... }

  @UseGuards(RolesGuard)
  @Roles('ADMIN', 'STAFF')
  @Delete(':id')           // â† é€šé…ç¬¦è·¯å¾„ï¼šæ”¾åœ¨æœ€å
  async remove(...) { ... }
}
```

## ä¿®å¤åçš„è·¯ç”±åŒ¹é…æµç¨‹

### âœ… æ­£ç¡®çš„åŒ¹é…æµç¨‹

```
DELETE /api/news/collect
  â†“
  æ£€æŸ¥è·¯ç”±ï¼š
  1. @Delete('collect')       â† âœ… ç²¾ç¡®åŒ¹é…ï¼
  2. @Delete(':id')           â† ä¸ä¼šåˆ°è¿™é‡Œ
  â†“
  æ‰§è¡Œ uncollect() æ–¹æ³•
  â†“
  è¿”å› 200 OK
```

```
DELETE /api/activities/like
  â†“
  æ£€æŸ¥è·¯ç”±ï¼š
  1. @Delete('like')          â† âœ… ç²¾ç¡®åŒ¹é…ï¼
  2. @Delete(':id')           â† ä¸ä¼šåˆ°è¿™é‡Œ
  â†“
  æ‰§è¡Œ unlike() æ–¹æ³•
  â†“
  è¿”å› 200 OK
```

## è°ƒè¯•æ—¥å¿—å¢å¼º

ä¸ºäº†æ›´å¥½åœ°è¿½è¸ªé—®é¢˜ï¼Œåœ¨ controller æ–¹æ³•ä¸­æ·»åŠ äº†æ—¥å¿—ï¼š

```typescript
// NewsController
@Post('collect')
async collect(@CurrentUser() user: any, @Body('newsId') newsId: string) {
  console.log('ğŸ“¥ æ”¶è— - userId:', user?.id);
  console.log('ğŸ“¥ æ”¶è— - newsId:', newsId);
  return this.newsService.collect(user.id, newsId);
}

@Delete('collect')
async uncollect(@CurrentUser() user: any, @Body('newsId') newsId: string) {
  console.log('ğŸ“¤ å–æ¶ˆæ”¶è— - userId:', user?.id);
  console.log('ğŸ“¤ å–æ¶ˆæ”¶è— - newsId:', newsId);
  return this.newsService.uncollect(user.id, newsId);
}

// ActivitiesController
@Post('like')
async like(@CurrentUser() user: any, @Body('activityId') activityId: string) {
  console.log('ğŸ‘ ç‚¹èµ - userId:', user?.id);
  console.log('ğŸ‘ ç‚¹èµ - activityId:', activityId);
  return this.activitiesService.like(user.id, activityId);
}

@Delete('like')
async unlike(@CurrentUser() user: any, @Body('activityId') activityId: string) {
  console.log('ğŸ‘ å–æ¶ˆç‚¹èµ - userId:', user?.id);
  console.log('ğŸ‘ å–æ¶ˆç‚¹èµ - activityId:', activityId);
  return this.activitiesService.unlike(user.id, activityId);
}
```

## æµ‹è¯•éªŒè¯

ä¿®å¤åï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤éªŒè¯ï¼š

### 1. é‡å¯åç«¯æœåŠ¡
```bash
cd backend
npm run start:dev
```

### 2. æµ‹è¯•å–æ¶ˆæ”¶è—
1. ç™»å½•å°ç¨‹åº
2. è¿›å…¥èµ„è®¯è¯¦æƒ…é¡µ
3. ç‚¹å‡»"æ”¶è—"æŒ‰é’®
4. è§‚å¯Ÿåç«¯æ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° `ğŸ“¥ æ”¶è— - userId: xxx`
5. å†æ¬¡ç‚¹å‡»"å–æ¶ˆæ”¶è—"æŒ‰é’®
6. è§‚å¯Ÿåç«¯æ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° `ğŸ“¤ å–æ¶ˆæ”¶è— - userId: xxx`
7. ç¡®è®¤å‰ç«¯æ˜¾ç¤º"å–æ¶ˆæ”¶è—æˆåŠŸ"ä¸”æŒ‰é’®æ–‡å­—å˜å›"æ”¶è—"

### 3. æµ‹è¯•å–æ¶ˆç‚¹èµ
1. ç™»å½•å°ç¨‹åº
2. è¿›å…¥æ´»åŠ¨è¯¦æƒ…é¡µ
3. ç‚¹å‡»"ç‚¹èµ"æŒ‰é’®
4. è§‚å¯Ÿåç«¯æ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° `ğŸ‘ ç‚¹èµ - userId: xxx`
5. å†æ¬¡ç‚¹å‡»æŒ‰é’®å–æ¶ˆç‚¹èµ
6. è§‚å¯Ÿåç«¯æ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° `ğŸ‘ å–æ¶ˆç‚¹èµ - userId: xxx`
7. ç¡®è®¤å‰ç«¯ç‚¹èµæ•°å‡ 1 ä¸”æç¤º"å–æ¶ˆç‚¹èµæˆåŠŸ"

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. NestJS è·¯ç”±åŒ¹é…åŸåˆ™

âœ… **æ­£ç¡®é¡ºåºï¼š**
```typescript
@Get('specific')      // 1. å…·ä½“è·¯å¾„ä¼˜å…ˆ
@Get(':id/action')    // 2. å¸¦å‚æ•°çš„å­è·¯å¾„
@Get(':id')           // 3. é€šé…ç¬¦è·¯å¾„æœ€å
```

âŒ **é”™è¯¯é¡ºåºï¼ˆä¼šå¯¼è‡´è·¯ç”±å†²çªï¼‰ï¼š**
```typescript
@Get(':id')           // 1. é€šé…ç¬¦è·¯å¾„
@Get('specific')      // 2. å…·ä½“è·¯å¾„æ°¸è¿œåŒ¹é…ä¸åˆ°ï¼
```

### 2. HTTP æ–¹æ³•çš„è·¯ç”±ä¹Ÿéµå¾ªç›¸åŒåŸåˆ™

```typescript
// âœ… æ­£ç¡®
@Delete('collect')    // å…ˆå®šä¹‰
@Delete(':id')        // åå®šä¹‰

// âŒ é”™è¯¯
@Delete(':id')        // å…ˆå®šä¹‰ï¼šä¼šæ‹¦æˆªæ‰€æœ‰ DELETE è¯·æ±‚
@Delete('collect')    // åå®šä¹‰ï¼šæ°¸è¿œä¸ä¼šè¢«åŒ¹é…
```

### 3. Guard å’Œè§’è‰²æ£€æŸ¥

- `@UseGuards(RolesGuard)` + `@Roles('ADMIN', 'STAFF')` ä¼šé™åˆ¶åªæœ‰ç‰¹å®šè§’è‰²æ‰èƒ½è®¿é—®
- å¦‚æœè·¯ç”±é”™è¯¯åŒ¹é…åˆ°äº†éœ€è¦ç®¡ç†å‘˜æƒé™çš„æ–¹æ³•ï¼Œæ™®é€šç”¨æˆ·ä¼šæ”¶åˆ° 403 Forbidden
- **è¿™å°±æ˜¯æœ¬æ¬¡ bug çš„æ ¹æœ¬åŸå› ï¼**

## ç›¸å…³æ–‡ä»¶

### åç«¯
- `backend/src/modules/cms/news/news.controller.ts` - èµ„è®¯æ§åˆ¶å™¨
- `backend/src/modules/cms/activities/activities.controller.ts` - æ´»åŠ¨æ§åˆ¶å™¨
- `backend/src/common/guards/roles.guard.ts` - è§’è‰²æƒé™ Guard

### å‰ç«¯
- `frontend-uniapp/api/news.js` - èµ„è®¯ APIï¼ˆæœªä¿®æ”¹ï¼‰
- `frontend-uniapp/api/association.js` - åä¼šå’Œæ´»åŠ¨ APIï¼ˆæœªä¿®æ”¹ï¼‰

## ç»éªŒæ•™è®­

1. **è·¯ç”±å®šä¹‰é¡ºåºå¾ˆé‡è¦**ï¼šNestJS æŒ‰ç…§å®šä¹‰é¡ºåºåŒ¹é…è·¯ç”±ï¼Œä¸æ˜¯æŒ‰ç…§"ç²¾ç¡®åº¦"è‡ªåŠ¨æ’åº
2. **å…·ä½“è·¯å¾„ä¼˜å…ˆ**ï¼šæ‰€æœ‰å…·ä½“è·¯å¾„ï¼ˆå¦‚ `collect`, `like`, `my-collection`ï¼‰å¿…é¡»å®šä¹‰åœ¨é€šé…ç¬¦è·¯å¾„ï¼ˆ`:id`ï¼‰ä¹‹å‰
3. **403 ä¸ä¸€å®šæ˜¯æƒé™é—®é¢˜**ï¼šä¹Ÿå¯èƒ½æ˜¯è·¯ç”±åŒ¹é…é”™è¯¯ï¼Œå¯¼è‡´è¯·æ±‚è¢«é”™è¯¯çš„æ–¹æ³•å¤„ç†
4. **è°ƒè¯•æ—¶æŸ¥çœ‹æ—¥å¿—**ï¼šå¦‚æœ controller æ–¹æ³•çš„ `console.log` æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜è¯·æ±‚æ ¹æœ¬æ²¡åˆ°è¾¾ç›®æ ‡æ–¹æ³•
5. **JWT Guard é€šè¿‡ä¸ä»£è¡¨è·¯ç”±æ­£ç¡®**ï¼šGuard åªè´Ÿè´£è®¤è¯ï¼Œè·¯ç”±åŒ¹é…æ˜¯åœ¨ Guard ä¹‹åè¿›è¡Œçš„

## ä¿®å¤æ—¥æœŸ
2025-10-31


