# 数据库索引优化建议

## 当前索引状态

### ✅ 已有索引（良好）

#### 用户表（users）
- `openid` - 支持微信登录查询
- `phone` - 支持手机号登录和查找
- `email` - 支持邮箱登录和查找
- `advisorId` - 支持顾问关联查询
- `organizationId` - 外键自动索引

#### 课程表（courses）
- `category` - 支持按分类筛选
- `startTime` - 支持按时间排序和筛选

#### 报名表（enrollments）
- `userId` - 支持按用户查询
- `courseId` - 支持按课程查询
- `userId_courseId` - 唯一索引，防止重复报名

#### 学分表（credits）
- `userId` - 支持按用户查询
- `expireDate` - 支持过期学分清理

#### 资讯表（news）
- `category` - 支持按分类筛选
- `publishTime` - 支持按时间排序

#### 协会表（associations）
- `type` - 支持按类型筛选

#### 活动表（activities）
- `associationId` - 支持按协会查询
- `publishTime` - 支持按时间排序

## 🔍 建议添加的索引

### 高优先级

#### 1. User 表
```prisma
@@index([role]) // 支持按角色查询管理员/教师
@@index([status]) // 支持筛选激活/禁用用户
@@index([organizationId]) // 已有外键，建议显式添加
```

**理由**：
- 管理后台经常需要按角色筛选用户
- 需要筛选激活状态的用户
- 企业用户管理需要按组织查询

#### 2. Course 表
```prisma
@@index([status]) // 支持按发布状态筛选
@@index([enrollStatus]) // 支持按报名状态筛选
@@index([teacherId]) // 支持查询教师的课程
@@index([createdBy]) // 支持查询创建人的课程
```

**理由**：
- 课程列表需要按状态筛选（草稿/已发布/已归档）
- 报名管理需要筛选开放/关闭的课程
- 教师管理需要查看自己的课程

#### 3. Enrollment 表
```prisma
@@index([status]) // 支持按报名状态筛选
@@index([checkedIn]) // 支持查询签到/未签到学员
@@index([rated]) // 支持查询已评价/未评价学员
@@index([isTrial]) // 支持筛选试听申请
@@index([userId, status]) // 复合索引，优化用户课程状态查询
```

**理由**：
- 课程管理需要统计各状态的报名数量
- 签到管理需要快速查询签到状态
- 需要跟踪课程评价完成情况

#### 4. News 表
```prisma
@@index([status]) // 支持按发布状态筛选
@@index([isTop]) // 支持查询置顶资讯
@@index([createdBy]) // 支持按创建人筛选
@@index([category, status, publishTime]) // 复合索引，优化列表查询
```

**理由**：
- 资讯管理需要按状态筛选
- 置顶资讯需要快速查询
- 列表页面经常同时使用分类、状态、时间筛选

#### 5. Activity 表
```prisma
@@index([status]) // 支持按发布状态筛选
@@index([associationId, publishTime]) // 复合索引，优化协会活动查询
```

**理由**：
- 活动管理需要按状态筛选
- 协会详情页经常按时间倒序显示活动

#### 6. Credit 表
```prisma
@@index([type]) // 支持按学分类型筛选
@@index([status]) // 支持按有效状态筛选
@@index([userId, status]) // 复合索引，查询用户有效学分
```

**理由**：
- 需要区分个人/企业学分
- 需要快速查询有效学分
- 报名时需要查询用户的有效学分

### 中优先级

#### 7. CreditRecord 表
```prisma
@@index([type]) // 支持按记录类型筛选
@@index([createdAt]) // 支持按时间查询和统计
```

**理由**：
- 学分报表需要按类型统计
- 时间范围查询优化

#### 8. Collection 表
```prisma
@@index([createdAt]) // 支持按收藏时间排序
```

**理由**：
- 我的收藏列表按时间倒序显示

#### 9. ActivityLike 表
```prisma
@@index([createdAt]) // 支持按点赞时间排序
```

**理由**：
- 活动热度统计可能需要时间维度

## 📊 复合索引优化建议

复合索引遵循"最左前缀"原则，将选择性高的字段放在前面。

### 推荐的复合索引

1. **News - 列表查询优化**
   ```prisma
   @@index([category, status, publishTime])
   ```
   覆盖场景：按分类筛选已发布资讯，按时间倒序

2. **Enrollment - 用户课程查询优化**
   ```prisma
   @@index([userId, status])
   ```
   覆盖场景：查询用户的各状态课程（进行中/已完成/已取消）

3. **Credit - 有效学分查询**
   ```prisma
   @@index([userId, status, expireDate])
   ```
   覆盖场景：查询用户的有效学分（未过期、未用完）

4. **Activity - 协会活动列表**
   ```prisma
   @@index([associationId, status, publishTime])
   ```
   覆盖场景：查询协会的已发布活动，按时间倒序

## 🎯 性能优化建议

### 1. 避免查询优化器陷阱

❌ **不好的查询**：
```typescript
// 使用 OR 条件，可能导致索引失效
where: {
  OR: [
    { status: 'PUBLISHED' },
    { status: 'ARCHIVED' }
  ]
}
```

✅ **推荐的查询**：
```typescript
// 使用 IN 操作符，可以利用索引
where: {
  status: { in: ['PUBLISHED', 'ARCHIVED'] }
}
```

### 2. 合理使用分页

始终对大表使用分页查询：
```typescript
const [list, total] = await Promise.all([
  prisma.course.findMany({
    skip: (page - 1) * pageSize,
    take: pageSize,
    orderBy: { startTime: 'desc' },
  }),
  prisma.course.count({ where }),
]);
```

### 3. 使用 select 减少数据传输

```typescript
// 只查询需要的字段
prisma.user.findMany({
  select: {
    id: true,
    nickname: true,
    avatar: true,
  },
});
```

### 4. 批量查询优化

使用 `in` 操作符代替多次单独查询：
```typescript
// ✅ 好的方式
const courseIds = enrollments.map(e => e.courseId);
const courses = await prisma.course.findMany({
  where: { id: { in: courseIds } }
});

// ❌ 避免这样
for (const enrollment of enrollments) {
  const course = await prisma.course.findUnique({
    where: { id: enrollment.courseId }
  });
}
```

## 📈 监控建议

### 1. 慢查询日志

在开发环境启用 Prisma 日志：
```typescript
const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },
    { level: 'warn', emit: 'stdout' },
    { level: 'error', emit: 'stdout' },
  ],
});

prisma.$on('query', (e) => {
  if (e.duration > 100) { // 查询时间超过100ms
    console.log('慢查询:', e.query);
    console.log('参数:', e.params);
    console.log('耗时:', e.duration, 'ms');
  }
});
```

### 2. 数据库性能监控

定期检查：
- 表的行数
- 索引使用情况
- 查询执行计划
- 缓存命中率

### 3. 定期维护

- 清理过期数据（过期学分、历史日志等）
- 重建索引（MySQL: `OPTIMIZE TABLE`）
- 更新统计信息

## ✅ 实施计划

### 第一阶段（立即实施）
1. User 表添加 role、status 索引
2. Course 表添加 status、enrollStatus 索引
3. Enrollment 表添加 status 索引
4. News 表添加 status、isTop 索引

### 第二阶段（性能测试后）
1. 根据实际查询模式添加复合索引
2. 监控慢查询，针对性优化
3. 考虑使用 Redis 缓存热点数据

### 第三阶段（长期优化）
1. 分析查询日志，持续优化
2. 考虑读写分离
3. 考虑分表策略（如果数据量大）

## ⚠️ 注意事项

1. **索引不是越多越好**：每个索引都会占用存储空间，并降低写入性能
2. **定期review**：定期检查索引使用情况，删除未使用的索引
3. **测试验证**：添加索引后必须进行性能测试验证效果
4. **监控影响**：关注索引对写入性能的影响
5. **文档记录**：记录每个索引的用途和预期场景

## 📝 索引添加脚本

可以直接修改 `schema.prisma` 文件，然后运行：
```bash
npx prisma migrate dev --name add-performance-indexes
```

或者在生产环境：
```bash
npx prisma migrate deploy
```

---

**创建时间**: 2025-10-31  
**版本**: v1.0


