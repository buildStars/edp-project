# å¦‚ä½•ç»™ç”¨æˆ·æ·»åŠ å­¦åˆ†

## ğŸ“Š å­¦åˆ†è¡¨ç»“æ„

### ä¸»è¡¨ï¼š`credits`
- `total`: æ€»å­¦åˆ†æ•°
- `remaining`: å‰©ä½™å­¦åˆ†æ•°  
- `used`: å·²ä½¿ç”¨å­¦åˆ†æ•°
- `expireDate`: è¿‡æœŸæ—¶é—´
- `status`: çŠ¶æ€ï¼ˆACTIVE/EXPIRED/USED_UPï¼‰

---

## ğŸ”§ æ·»åŠ å­¦åˆ†çš„æ–¹æ³•

### æ–¹æ³•1ï¼šé€šè¿‡ç®¡ç†åå° APIï¼ˆæ¨èï¼‰

#### API æ¥å£
```
POST /api/credits/allocate
Authorization: Bearer <ç®¡ç†å‘˜token>
```

#### è¯·æ±‚å‚æ•°
```json
{
  "userId": "ç”¨æˆ·ID",
  "amount": 10,           // å­¦åˆ†æ•°é‡ï¼Œé»˜è®¤10
  "validDays": 365,       // æœ‰æ•ˆå¤©æ•°ï¼Œé»˜è®¤365å¤©
  "type": "PERSONAL"      // ç±»å‹ï¼šPERSONAL(ä¸ªäºº) æˆ– ENTERPRISE(ä¼ä¸š)
}
```

#### ç¤ºä¾‹
```bash
curl -X POST http://localhost:3000/api/credits/allocate \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "5fb1dc1f-b81a-4d11-8eb3-c4dc22cdc33d",
    "amount": 10,
    "validDays": 365,
    "type": "PERSONAL"
  }'
```

---

### æ–¹æ³•2ï¼šç›´æ¥æ“ä½œæ•°æ®åº“

#### ä½¿ç”¨ Prisma Studioï¼ˆå¯è§†åŒ–ï¼‰

```bash
cd backend
npx prisma studio
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­ï¼š
1. æ‰“å¼€ `credits` è¡¨
2. ç‚¹å‡» "Add record"
3. å¡«å†™å­—æ®µï¼š
   - `userId`: ç”¨æˆ·ID
   - `type`: PERSONAL
   - `total`: 10
   - `remaining`: 10
   - `used`: 0
   - `expireDate`: 2026-10-31 (ä¸€å¹´å)
   - `status`: ACTIVE

#### ä½¿ç”¨ SQL

```sql
-- ç»™ç”¨æˆ·æ·»åŠ 10å­¦åˆ†ï¼Œæœ‰æ•ˆæœŸ1å¹´
INSERT INTO credits (
  id, 
  userId, 
  type, 
  total, 
  remaining, 
  used, 
  expireDate, 
  status, 
  createdAt, 
  updatedAt
) VALUES (
  UUID(),
  'ç”¨æˆ·ID',
  'PERSONAL',
  10,
  10,
  0,
  DATE_ADD(NOW(), INTERVAL 1 YEAR),
  'ACTIVE',
  NOW(),
  NOW()
);
```

---

### æ–¹æ³•3ï¼šä½¿ç”¨ Seed è„šæœ¬

ç¼–è¾‘ `backend/prisma/seed.ts`ï¼Œæ·»åŠ æµ‹è¯•æ•°æ®ï¼š

```typescript
// ä¸ºæµ‹è¯•ç”¨æˆ·æ·»åŠ å­¦åˆ†
await prisma.credit.create({
  data: {
    userId: testUser.id,
    type: 'PERSONAL',
    total: 10,
    remaining: 10,
    used: 0,
    expireDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1å¹´å
    status: 'ACTIVE',
  },
});
```

ç„¶åè¿è¡Œï¼š
```bash
cd backend
npm run seed
```

---

## ğŸ“‹ å­¦åˆ†ä½¿ç”¨æµç¨‹

1. **ç”¨æˆ·æŠ¥åè¯¾ç¨‹** â†’ è°ƒç”¨ `/api/enrollments/enroll`
2. **ç³»ç»Ÿè‡ªåŠ¨æ‰£é™¤å­¦åˆ†** â†’ æ›´æ–° `credits` è¡¨çš„ `remaining` å’Œ `used`
3. **è®°å½•ä½¿ç”¨å†å²** â†’ åœ¨ `credit_records` è¡¨åˆ›å»ºè®°å½•

---

## ğŸ” æŸ¥è¯¢ç”¨æˆ·å­¦åˆ†

### API
```
GET /api/credits/my
Authorization: Bearer <ç”¨æˆ·token>
```

### å“åº”ç¤ºä¾‹
```json
{
  "id": "xxx",
  "total": 10,
  "remaining": 7,
  "used": 3,
  "expireDate": "2026-10-31",
  "status": "ACTIVE",
  "records": [...]
}
```

---

## ğŸ’¡ å¸¸è§æ“ä½œ

### ç»™æ‰€æœ‰æµ‹è¯•ç”¨æˆ·æ·»åŠ å­¦åˆ†
```typescript
// åœ¨ seed.ts ä¸­
const users = await prisma.user.findMany();
for (const user of users) {
  await prisma.credit.create({
    data: {
      userId: user.id,
      type: 'PERSONAL',
      total: 10,
      remaining: 10,
      used: 0,
      expireDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
      status: 'ACTIVE',
    },
  });
}
```

### æ‰¹é‡å……å€¼å­¦åˆ†
```sql
-- ç»™æ‰€æœ‰ç°æœ‰ç”¨æˆ·æ·»åŠ å­¦åˆ†
INSERT INTO credits (id, userId, type, total, remaining, used, expireDate, status, createdAt, updatedAt)
SELECT 
  UUID() as id,
  id as userId,
  'PERSONAL' as type,
  10 as total,
  10 as remaining,
  0 as used,
  DATE_ADD(NOW(), INTERVAL 1 YEAR) as expireDate,
  'ACTIVE' as status,
  NOW() as createdAt,
  NOW() as updatedAt
FROM users
WHERE NOT EXISTS (
  SELECT 1 FROM credits WHERE credits.userId = users.id
);
```

