# 教师权限优化完整方案 - 实施总结

## 📋 问题分析

### 原有问题
根据用户提供的图片，教师角色权限流程存在以下不合理之处：

1. **权限范围过大**: 教师可以查看所有课程、所有用户、所有报名记录
2. **数据权限缺失**: 没有数据级别的过滤，教师可以看到不属于自己的数据
3. **菜单混乱**: 教师看到了许多不应该访问的管理菜单
4. **权限缺失**: 教师无法删除自己上传错误的课件

### 应有的权限模型

教师应该：
- ✅ 只能查看和管理**自己的课程**
- ✅ 只能查看和管理**自己课程的学员**
- ✅ 只能查看**自己课程的报名记录**
- ✅ 只能看到**自己的统计数据**
- ✅ 能够删除**自己课程的课件**
- ❌ 不能查看其他教师的数据
- ❌ 不能访问全局管理功能

## 🔧 实施方案

### 方案选择：简化权限 + 后端数据过滤

**优点**:
1. 权限配置简单，易于维护
2. 后端统一过滤，安全性高
3. 前端无需复杂的权限判断
4. 扩展性好

## ✅ 已完成的修改

### 1. 后端权限配置 ✅

#### 文件：`backend/prisma/seeds/permissions.seed.ts`

添加了教师的课件删除权限：

```typescript
TEACHER: [
  'dashboard:view',
  'my-courses:view',
  'my-students:view',
  'courses:view', 'courses:create', 'courses:edit',
  'chapters:view', 'chapters:manage',
  'users:view',
  'enrollments:view', 'enrollments:checkin', 'enrollments:evaluation',
  'courseware:view', 'courseware:upload', 'courseware:delete', // ✅ 新增
  'statistics:view',
],
```

### 2. 后端数据过滤 ✅

#### 2.1 课程列表过滤

**文件**: `backend/src/modules/courses/courses.controller.ts`

```typescript
@Public()
@Get()
@ApiOperation({ summary: '获取课程列表' })
async findAll(@Query() query: QueryCourseDto, @CurrentUser() user: any) {
  // 如果是教师，只返回自己的课程
  if (user?.role === 'TEACHER') {
    query.teacherId = user.id;
  }
  return this.coursesService.findAll(query, user?.id);
}
```

**效果**: 教师访问课程列表接口时，只能看到自己的课程。

#### 2.2 用户列表过滤

**文件**: `backend/src/modules/users/users.controller.ts`

```typescript
@Get('list')
@UseGuards(RolesGuard)
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER 角色
@ApiOperation({ summary: '获取用户列表（管理）' })
async getUserList(@Query() query: any, @CurrentUser() user: any) {
  // 如果是教师，只返回自己课程的学员
  if (user.role === 'TEACHER') {
    return this.usersService.findTeacherStudents(user.id, query);
  }
  return this.usersService.findAll(query);
}
```

**文件**: `backend/src/modules/users/users.service.ts`

新增 `findTeacherStudents` 方法：

```typescript
/**
 * 获取教师的学员列表（只返回报名了该教师课程的学员）
 */
async findTeacherStudents(teacherId: string, query: any) {
  const where: any = {
    role: 'STUDENT',
    enrollments: {
      some: {
        course: {
          teacherId,
        },
      },
    },
  };
  // ... 查询逻辑
}
```

**效果**: 教师访问用户列表时，只能看到报名了自己课程的学员。

#### 2.3 报名列表过滤

**文件**: `backend/src/modules/enrollments/enrollments.controller.ts`

```typescript
@UseGuards(RolesGuard)
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER 角色
@Get()
@ApiOperation({ summary: '获取报名列表（管理端）' })
async findAll(@Query() query: any, @CurrentUser() user: any) {
  // 如果是教师，只返回自己课程的报名记录
  if (user.role === 'TEACHER') {
    return this.enrollmentsService.findTeacherEnrollments(user.id, query);
  }
  return this.enrollmentsService.findAll(query);
}
```

**文件**: `backend/src/modules/enrollments/enrollments.service.ts`

新增 `findTeacherEnrollments` 方法：

```typescript
/**
 * 获取教师的报名记录列表（只返回自己课程的报名）
 */
async findTeacherEnrollments(teacherId: string, query: any) {
  const where: any = {
    course: {
      teacherId,
    },
  };
  // ... 查询逻辑
}
```

**效果**: 教师访问报名记录时，只能看到自己课程的报名。

#### 2.4 统计数据过滤

**文件**: `backend/src/modules/statistics/statistics.controller.ts`

```typescript
@Get('dashboard')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER 角色
@ApiOperation({ summary: '获取仪表板统计数据' })
async getDashboardStatistics(@CurrentUser() user: any) {
  return this.statisticsService.getDashboardStatistics(user);
}
```

**文件**: `backend/src/modules/statistics/statistics.service.ts`

修改 `getDashboardStatistics` 方法并新增 `getTeacherStatistics` 方法：

```typescript
async getDashboardStatistics(user?: any) {
  // 如果是教师，返回教师专属统计
  if (user?.role === 'TEACHER') {
    return this.getTeacherStatistics(user.id);
  }
  // 管理员/教务的全局统计
  // ...
}

/**
 * 获取教师统计数据（只统计自己的课程）
 */
private async getTeacherStatistics(teacherId: string) {
  // 统计数据包括：
  // - 总课程数、进行中的课程、草稿课程
  // - 总学员数（去重）
  // - 总报名数、本月报名数
  // - 今日签到数
  // - 学员增长数据、报名趋势数据
  // ...
}
```

**效果**: 教师看到的首页统计数据只包含自己的课程和学员数据。

#### 2.5 签到管理权限

**文件**: `backend/src/modules/checkin/checkin.controller.ts`

为所有签到相关接口添加 `TEACHER` 角色：

```typescript
@Post('courses/:courseId/start')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER

@Delete('courses/:courseId/sessions/:sessionId')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER

@Get('courses/:courseId/sessions/:sessionId/statistics')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER

@Get('courses/:courseId/active-session-admin')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER

@Post('courses/:courseId/sessions/:sessionId/makeup')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER

@Post('courses/:courseId/sessions/:sessionId/batch-makeup')
@Roles('ADMIN', 'STAFF', 'TEACHER') // ✅ 添加 TEACHER
```

**效果**: 教师可以正常使用签到管理功能（开启签到、结束签到、查看统计、补签等）。

### 3. 前端菜单优化 ✅

#### 3.1 修改菜单配置

**文件**: `admin-frontend/src/config/permissions.ts`

**接口扩展**:

```typescript
export interface MenuItem {
  path: string
  name: string
  title: string
  icon?: string
  permission?: string
  children?: MenuItem[]
  hidden?: boolean
  hideForRoles?: string[] // ✅ 新增：对指定角色隐藏
}
```

**菜单配置更新**:

```typescript
export const menuConfig: MenuItem[] = [
  {
    path: '/news',
    name: 'News',
    title: '资讯管理',
    hideForRoles: ['TEACHER'], // ✅ 教师不显示
  },
  {
    path: '/associations',
    name: 'Associations',
    title: '校友生活',
    hideForRoles: ['TEACHER'], // ✅ 教师不显示
  },
  {
    path: '/courses',
    name: 'Courses',
    title: '课程管理',
    hideForRoles: ['TEACHER'], // ✅ 教师使用"我的课程"代替
  },
  {
    path: '/users',
    name: 'Users',
    title: '用户管理',
    hideForRoles: ['TEACHER'], // ✅ 教师使用"我的学员"代替
  },
  {
    path: '/organizations',
    name: 'Organizations',
    title: '企业管理',
    hideForRoles: ['TEACHER'], // ✅ 教师不显示
  },
  {
    path: '/courseware',
    name: 'Courseware',
    title: '课件管理',
    hideForRoles: ['TEACHER'], // ✅ 教师在自己课程中管理课件
  },
  {
    path: '/settings',
    name: 'Settings',
    title: '系统设置',
    hideForRoles: ['TEACHER'], // ✅ 教师不显示系统设置
  },
  // ... 其他菜单
]
```

#### 3.2 修改菜单过滤函数

**文件**: `admin-frontend/src/config/permissions.ts`

```typescript
export function filterMenusByPermissions(
  menus: MenuItem[],
  permissions: string[],
  userRole?: string // ✅ 新增参数
): MenuItem[] {
  const result: MenuItem[] = []

  for (const menu of menus) {
    // ✅ 检查是否需要对当前角色隐藏
    if (menu.hideForRoles && userRole && menu.hideForRoles.includes(userRole)) {
      continue
    }

    // 如果没有配置权限，则默认显示
    if (!menu.permission) {
      const filteredMenu = { ...menu }
      if (menu.children) {
        filteredMenu.children = filterMenusByPermissions(menu.children, permissions, userRole)
        if (filteredMenu.children.length === 0) {
          continue
        }
      }
      result.push(filteredMenu)
      continue
    }

    // 检查用户是否有权限
    if (permissions.includes(menu.permission)) {
      const filteredMenu = { ...menu }
      if (menu.children) {
        filteredMenu.children = filterMenusByPermissions(menu.children, permissions, userRole)
      }
      result.push(filteredMenu)
    }
  }

  return result
}
```

#### 3.3 修改布局组件

**文件**: `admin-frontend/src/layouts/AdminLayout.vue`

```typescript
// 菜单路由（基于权限过滤）
const menuRoutes = computed(() => {
  const permissions = authStore.permissions || []
  const userRole = authStore.userInfo?.role
  
  // ✅ 根据用户权限和角色过滤菜单
  return filterMenusByPermissions(menuConfig, permissions, userRole)
})
```

**效果**: 教师登录后，侧边栏只显示应该看到的菜单项。

## 📊 优化效果对比

### 菜单显示对比

| 菜单项 | 优化前（教师） | 优化后（教师） | 说明 |
|--------|--------------|--------------|------|
| 首页概览 | ✅ 显示 | ✅ 显示 | 只显示自己的数据 |
| 资讯管理 | ✅ 显示 ❌ | ❌ 隐藏 | 教师不需要 |
| 校友生活 | ✅ 显示 ❌ | ❌ 隐藏 | 教师不需要 |
| 课程管理 | ✅ 显示 ❌ | ❌ 隐藏 | 使用"我的课程"代替 |
| 用户管理 | ✅ 显示 ❌ | ❌ 隐藏 | 使用"我的学员"代替 |
| 企业管理 | ✅ 显示 ❌ | ❌ 隐藏 | 教师不需要 |
| 报名管理 | ✅ 显示 | ✅ 显示 | 只显示自己课程的报名 |
| 签到管理 | ✅ 显示 | ✅ 显示 | 只显示自己课程的签到 |
| 评价管理 | ✅ 显示 | ✅ 显示 | 只显示自己课程的评价 |
| 课件管理 | ✅ 显示 ❌ | ❌ 隐藏 | 在自己课程中管理 |
| 数据统计 | ✅ 显示 | ✅ 显示 | 只显示自己的数据 |
| 系统设置 | ✅ 显示 ❌ | ❌ 隐藏 | 教师不需要 |
| 教学管理 | ❌ 没有 | ✅ 显示 | 我的课程、我的学员 |

### 数据权限对比

| 功能 | 优化前 | 优化后 |
|-----|--------|--------|
| 查看课程 | 所有课程 ❌ | 只看自己的课程 ✅ |
| 查看用户 | 所有用户 ❌ | 只看自己的学员 ✅ |
| 查看报名 | 所有报名 ❌ | 只看自己课程的报名 ✅ |
| 查看统计 | 全局统计 ❌ | 只看自己的统计 ✅ |
| 签到管理 | 403错误 ❌ | 正常使用 ✅ |
| 评价管理 | 403错误 ❌ | 正常使用 ✅ |
| 删除课件 | 无权限 ❌ | 有权限（API待实现） ⚠️ |

## 🔐 安全性增强

### 数据隔离
- **后端过滤**: 所有数据查询都在后端进行过滤，前端无法绕过
- **所有权验证**: 涉及课程的操作都会验证 `teacherId === user.id`
- **角色检查**: 使用 NestJS 的 `@Roles` 装饰器进行角色验证

### 示例：编辑课程前验证

```typescript
async update(id: string, updateDto: any, user: any) {
  // 如果是教师，验证课程所有权
  if (user.role === 'TEACHER') {
    const course = await this.prisma.course.findUnique({
      where: { id },
      select: { teacherId: true },
    });
    
    if (!course || course.teacherId !== user.id) {
      throw new ForbiddenException('无权编辑此课程');
    }
  }
  
  // 执行更新...
}
```

## ⚠️ 待实现功能

### 课件删除接口

**状态**: 权限已配置，但 API 端点未实现

**需要做的**:

1. **后端**: 在 `CoursesController` 或 `MaterialsController` 中添加删除课件接口
2. **验证**: 确保教师只能删除自己课程的课件
3. **前端**: 添加删除按钮和调用逻辑

**示例实现**:

```typescript
// backend/src/modules/materials/materials.controller.ts
@Delete(':id')
@UseGuards(RolesGuard)
@Roles('ADMIN', 'STAFF', 'TEACHER')
@ApiOperation({ summary: '删除课件' })
async deleteMaterial(@Param('id') id: string, @CurrentUser() user: any) {
  return this.materialsService.deleteMaterial(id, user);
}

// backend/src/modules/materials/materials.service.ts
async deleteMaterial(materialId: string, user: any) {
  // 查询课件所属课程
  const material = await this.prisma.material.findUnique({
    where: { id: materialId },
    include: { course: true },
  });
  
  // 如果是教师，验证所有权
  if (user.role === 'TEACHER' && material.course.teacherId !== user.id) {
    throw new ForbiddenException('无权删除此课件');
  }
  
  // 删除课件...
}
```

## 🚀 使用指南

### 测试教师权限

1. **登录教师账号**:
   ```bash
   # 使用教师账号登录管理后台
   http://localhost:3001/login
   ```

2. **验证菜单显示**:
   - 检查侧边栏只显示应该看到的菜单
   - 确认"教学管理"菜单显示

3. **验证数据权限**:
   - 访问"课程列表" → 只显示自己的课程
   - 访问"用户列表" → 只显示自己的学员
   - 访问"报名记录" → 只显示自己课程的报名
   - 访问"首页概览" → 只显示自己的统计数据

4. **验证功能权限**:
   - 尝试签到管理 → 应该可以正常使用
   - 尝试评价管理 → 应该可以正常使用
   - 尝试编辑其他教师的课程 → 应该返回403错误

### 数据库更新

权限配置已通过种子脚本更新：

```bash
cd backend
npx ts-node prisma/seed.ts
```

**输出**:
```
✅ 已创建 51 个权限
为角色分配权限...
  - ADMIN: 49 个权限
  - STAFF: 37 个权限
  - TEACHER: 16 个权限  # ✅ 包含 courseware:delete
  - ADVISOR: 7 个权限
  - STUDENT: 3 个权限
✅ 已创建 112 个角色权限关联
```

## 📝 技术细节

### 后端技术栈
- **框架**: NestJS
- **ORM**: Prisma
- **认证**: JWT + Guards
- **权限**: RBAC (Role-Based Access Control)

### 前端技术栈
- **框架**: Vue 3 (Composition API)
- **路由**: Vue Router
- **状态**: Pinia
- **UI**: Element Plus

### 关键实现点

1. **权限层级**:
   ```
   路由权限 (Roles Guard)
   → 数据权限 (Service层过滤)
   → UI权限 (菜单过滤 + v-permission指令)
   ```

2. **数据过滤策略**:
   - 在 Controller 层判断用户角色
   - 根据角色调用不同的 Service 方法
   - Service 方法中使用 Prisma 的关系查询过滤数据

3. **菜单过滤策略**:
   - 使用 `hideForRoles` 配置隐藏菜单
   - 在 `filterMenusByPermissions` 函数中检查角色
   - 递归处理子菜单

## 🎯 总结

### 核心改进

1. ✅ **数据隔离**: 教师只能看到和操作自己的数据
2. ✅ **菜单优化**: 教师只看到相关的菜单项
3. ✅ **权限完善**: 添加了缺失的权限（如课件删除）
4. ✅ **安全增强**: 后端统一验证，防止绕过

### 遵循原则

- **最小权限原则**: 教师只有必需的权限
- **职责分离**: 教师专注于教学，不涉及管理
- **数据隔离**: 每个教师只能访问自己的数据
- **用户体验**: 简化界面，去除不相关功能

### 未来优化建议

1. **实现课件删除API**: 完成前后端完整功能
2. **添加操作日志**: 记录教师的重要操作
3. **优化性能**: 对频繁查询的数据添加缓存
4. **增强验证**: 添加更多边界情况的验证

---

**完成时间**: 2025-11-12  
**版本**: v1.0  
**状态**: ✅ 已完成（除课件删除API）














