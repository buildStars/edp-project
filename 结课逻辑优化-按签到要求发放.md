# 结课逻辑优化 - 按签到要求发放海报

## 📋 需求说明

### 原有问题
- ❌ 结课后自动给所有学员发放学分和海报
- ❌ 不考虑学员的签到情况
- ❌ 不公平，未完成学习的学员也能获得

### 新的需求

**结课方式1：批量结课（教师申请 + 教务审批）**
- ✅ 教师定义签到次数要求（如：达到3次签到才算完成）
- ✅ 只有达到签到要求的学员才能完成课程
- ✅ 教务审批通过后：
  - 符合条件的学员：发放海报 + 标记为"已完成"
  - 不符合条件的学员：保持"进行中"状态

**结课方式2：单独结课（教师手动操作）**
- ✅ 教师可以单独给某个学员发放海报
- ✅ 该学员标记为"已完成"
- ✅ 其他学员不受影响
- ✅ 支持批量选择多个学员一起发放

---

## ✅ 已完成的修改

### 1. **批量结课逻辑优化**

**文件**: `backend/src/modules/course-completion/course-completion.service.ts`

**方法**: `reviewCompletionRequest` - 审批结课申请

#### 修改前

```typescript
// 审批通过后，所有学员都标记为已完成
await this.prisma.enrollment.updateMany({
  where: {
    courseId: request.courseId,
    status: 'ENROLLED',
  },
  data: {
    status: 'COMPLETED',
  },
});

// 自动发放学习成果给所有学员
await this.achievementsService.batchIssueAchievements(...);
```

#### 修改后

```typescript
// 1. 获取所有符合签到要求的学员
const studentsData = await this.achievementsService.getCourseStudentsWithCheckins(request.courseId);
const qualifiedStudentIds = studentsData.students
  .filter(s => s.isQualified)  // 只选择符合条件的
  .map(s => s.userId);

this.logger.log(`符合条件的学员数: ${qualifiedStudentIds.length} / ${studentsData.totalStudents}`);

// 2. 只更新符合条件的学员
if (qualifiedStudentIds.length > 0) {
  await this.prisma.enrollment.updateMany({
    where: {
      courseId: request.courseId,
      userId: { in: qualifiedStudentIds },  // 只更新符合条件的
      status: 'ENROLLED',
    },
    data: {
      status: 'COMPLETED',
    },
  });
  
  // 3. 自动发放学习成果（只给符合条件的）
  await this.achievementsService.batchIssueAchievements(reviewerId, {
    courseId: request.courseId,
    remark: `结课申请审批通过，自动发放 (申请ID: ${requestId})`,
  });
}
```

**效果**：
- ✅ 只有签到次数达标的学员才会被标记为"已完成"
- ✅ 未达标的学员继续保持"进行中"状态
- ✅ 教师仍然可以单独给未达标的学员发放海报

---

### 2. **单独给学员发放海报**

**新增方法**: `completeStudentManually`

```typescript
/**
 * 教师单独给学员发放海报（手动结课）
 */
async completeStudentManually(
  teacherId: string,
  courseId: string,
  userId: string,
  remark?: string,
) {
  // 1. 验证课程是否属于该教师
  const course = await this.prisma.course.findUnique({
    where: { id: courseId },
  });

  if (course.teacherId !== teacherId) {
    throw new BadRequestException('您无权操作该课程');
  }

  // 2. 检查学员是否已报名
  const enrollment = await this.prisma.enrollment.findFirst({
    where: {
      userId,
      courseId,
      status: 'ENROLLED',
    },
  });

  if (!enrollment) {
    throw new BadRequestException('该学员未报名此课程或已完成');
  }

  // 3. 获取学员的签到次数
  const checkinCount = await this.prisma.checkin.count({
    where: {
      userId,
      session: { courseId },
    },
  });

  // 4. 更新报名记录为已完成
  await this.prisma.enrollment.update({
    where: { id: enrollment.id },
    data: { status: 'COMPLETED' },
  });

  // 5. 发放学习成果
  await this.achievementsService.issueAchievements(teacherId, {
    courseId,
    userIds: [userId],
    remark: remark || '教师手动发放',
  });

  return {
    success: true,
    message: '操作成功',
    data: {
      userId,
      courseId,
      checkinCount,
      requiredCheckins: course.requiredCheckins,
    },
  };
}
```

**使用场景**：
- 学员签到次数未达标，但教师认可其学习成果
- 特殊情况下需要补发海报
- 学员请假但完成了补课

---

### 3. **批量给学员发放海报**

**新增方法**: `completeStudentsBatch`

```typescript
/**
 * 批量给学员发放海报（教师批量操作）
 */
async completeStudentsBatch(
  teacherId: string,
  courseId: string,
  userIds: string[],
  remark?: string,
) {
  // 1. 验证课程是否属于该教师
  const course = await this.prisma.course.findUnique({
    where: { id: courseId },
  });

  if (course.teacherId !== teacherId) {
    throw new BadRequestException('您无权操作该课程');
  }

  // 2. 批量更新报名记录为已完成
  const updateResult = await this.prisma.enrollment.updateMany({
    where: {
      courseId,
      userId: { in: userIds },
      status: 'ENROLLED',
    },
    data: {
      status: 'COMPLETED',
    },
  });

  // 3. 批量发放学习成果
  if (updateResult.count > 0) {
    await this.achievementsService.issueAchievements(teacherId, {
      courseId,
      userIds,
      remark: remark || '教师批量发放',
    });
  }

  return {
    success: true,
    message: `成功为 ${updateResult.count} 名学员发放海报`,
    successCount: updateResult.count,
  };
}
```

**使用场景**：
- 教师选择多个学员一起发放海报
- 批量补发海报给特殊情况的学员

---

### 4. **新增API接口**

**文件**: `backend/src/modules/course-completion/course-completion.controller.ts`

#### 接口1：单独给学员发放海报

```typescript
@Post('manual-complete')
@HttpCode(200)
@UseGuards(RolesGuard)
@Roles('TEACHER')
@ApiOperation({ summary: '单独给学员发放海报（教师手动结课）' })
async completeStudentManually(
  @CurrentUser('id') teacherId: string,
  @Body() body: { courseId: string; userId: string; remark?: string },
) {
  return this.courseCompletionService.completeStudentManually(
    teacherId,
    body.courseId,
    body.userId,
    body.remark,
  );
}
```

**请求示例**：
```bash
POST /course-completion/manual-complete
Authorization: Bearer {token}

{
  "courseId": "course-007",
  "userId": "user-123",
  "remark": "特殊情况补发"
}
```

**返回示例**：
```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    "userId": "user-123",
    "courseId": "course-007",
    "checkinCount": 2,
    "requiredCheckins": 3
  }
}
```

#### 接口2：批量给学员发放海报

```typescript
@Post('batch-complete')
@HttpCode(200)
@UseGuards(RolesGuard)
@Roles('TEACHER')
@ApiOperation({ summary: '批量给学员发放海报（教师批量操作）' })
async completeStudentsBatch(
  @CurrentUser('id') teacherId: string,
  @Body() body: { courseId: string; userIds: string[]; remark?: string },
) {
  return this.courseCompletionService.completeStudentsBatch(
    teacherId,
    body.courseId,
    body.userIds,
    body.remark,
  );
}
```

**请求示例**：
```bash
POST /course-completion/batch-complete
Authorization: Bearer {token}

{
  "courseId": "course-007",
  "userIds": ["user-123", "user-456", "user-789"],
  "remark": "批量补发"
}
```

**返回示例**：
```json
{
  "success": true,
  "message": "成功为 3 名学员发放海报",
  "successCount": 3
}
```

---

## 📊 完整业务流程

### 流程1：批量结课（符合签到要求）

```
1. 教师发起结课申请
   - 课程要求签到3次
   ↓
2. 教务审批通过
   ↓
3. 系统自动执行：
   ├── 获取所有学员的签到情况
   ├── 筛选符合条件的学员（签到 >= 3次）
   │   ├── 学员A：签到4次 ✅ → 标记为"已完成" + 发放海报
   │   ├── 学员B：签到3次 ✅ → 标记为"已完成" + 发放海报
   │   └── 学员C：签到2次 ❌ → 保持"进行中"，不发放海报
   └── 更新课程状态为"已归档"
   ↓
4. 小程序端更新
   - 学员A、B：课程移到"已完成"标签，可查看海报
   - 学员C：课程仍在"进行中"标签
```

### 流程2：教师手动发放（单独操作）

```
1. 教师查看课程学员列表
   - 看到学员C签到只有2次（未达标）
   ↓
2. 学员C因病请假但完成了补课
   ↓
3. 教师决定手动给学员C发放海报
   - 点击"发放海报"按钮
   ↓
4. 系统执行：
   ├── 更新学员C的报名状态为"已完成"
   └── 发放学习成果和海报
   ↓
5. 学员C在小程序端：
   - 课程移到"已完成"标签
   - 可以查看结课海报
   - 海报显示：签到2次（但已完成）
```

### 流程3：教师批量发放

```
1. 教师在学员列表中勾选多个学员
   - 勾选学员D、E、F（都是特殊情况）
   ↓
2. 点击"批量发放海报"
   ↓
3. 系统批量执行：
   ├── 更新3个学员的状态为"已完成"
   └── 批量发放学习成果
   ↓
4. 3个学员都能查看结课海报
```

---

## 🎯 签到要求判断逻辑

### 在 achievements.service.ts 中

```typescript
async getCourseStudentsWithCheckins(courseId: string) {
  const course = await this.prisma.course.findUnique({
    where: { id: courseId },
    select: {
      requiredCheckins: true,  // 要求的签到次数
    },
  });

  const enrollments = await this.prisma.enrollment.findMany({
    where: {
      courseId,
      status: 'ENROLLED',
    },
    include: {
      user: true,
    },
  });

  const students = await Promise.all(
    enrollments.map(async (enrollment) => {
      // 统计实际签到次数
      const checkinCount = await this.prisma.checkin.count({
        where: {
          userId: enrollment.userId,
          session: { courseId },
        },
      });

      // 判断是否符合条件
      const isQualified = course.requiredCheckins === 0 
        ? true  // 没有签到要求，都算符合
        : checkinCount >= course.requiredCheckins;  // 签到次数达标

      return {
        userId: enrollment.userId,
        userName: enrollment.user.realName || enrollment.user.nickname,
        checkinCount,
        isQualified,  // 是否符合条件
        hasAchievement: false,  // 是否已发放（稍后查询）
      };
    })
  );

  return {
    totalStudents: students.length,
    qualifiedStudents: students.filter(s => s.isQualified).length,
    students,
  };
}
```

---

## 🔧 管理后台操作建议

### 学员管理页面需要显示的信息

| 学员 | 签到次数 | 是否完成 | 操作 |
|------|---------|---------|------|
| 学员A | 4/3 ✅ | 已完成 | 已发放海报 |
| 学员B | 3/3 ✅ | 已完成 | 已发放海报 |
| 学员C | 2/3 ❌ | 进行中 | [发放海报] 按钮 |
| 学员D | 1/3 ❌ | 进行中 | [发放海报] 按钮 |

### 建议的UI设计

1. **学员列表页**
   - 显示每个学员的签到次数
   - 显示"签到次数/要求次数"（如：2/3）
   - 符合条件的显示绿色✅，不符合显示红色❌
   - 未完成的学员有"发放海报"按钮

2. **批量操作**
   - 支持勾选多个学员
   - 批量发放海报按钮
   - 显示选中人数

3. **发放记录**
   - 显示发放时间
   - 显示发放人（教师/自动）
   - 显示发放备注

---

## 📝 API 接口汇总

### 教师接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| POST | `/course-completion` | 发起结课申请 | TEACHER |
| PUT | `/course-completion/:id/cancel` | 取消结课申请 | TEACHER |
| POST | `/course-completion/manual-complete` | 单独发放海报 | TEACHER |
| POST | `/course-completion/batch-complete` | 批量发放海报 | TEACHER |

### 教务/管理员接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| PUT | `/course-completion/:id/review` | 审批结课申请 | ADMIN/STAFF |

### 查询接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/course-completion` | 查询结课申请列表 | ALL |
| GET | `/course-completion/:id` | 获取结课申请详情 | ALL |

---

## ✅ 核心改进总结

### 1. **公平性**
- ✅ 只有完成学习的学员才能获得海报
- ✅ 签到次数作为完成课程的标准
- ✅ 防止"混学分"现象

### 2. **灵活性**
- ✅ 教师可以单独给学员发放海报
- ✅ 支持特殊情况处理（请假、补课等）
- ✅ 支持批量操作

### 3. **透明性**
- ✅ 学员可以看到自己的签到次数
- ✅ 海报显示实际签到次数
- ✅ 教师可以查看所有学员的完成情况

### 4. **合理性**
- ✅ 不再自动发放学分给所有人
- ✅ 学习成果与实际学习挂钩
- ✅ 激励学员认真参与课程

---

## 🚀 下一步工作

### 前端需要实现的功能

1. **管理后台 - 学员管理页**
   - [ ] 显示学员列表
   - [ ] 显示签到次数统计
   - [ ] 显示"发放海报"按钮（未完成的学员）
   - [ ] 支持勾选多个学员
   - [ ] 批量发放海报功能

2. **管理后台 - 结课申请页**
   - [ ] 显示符合条件的学员数量
   - [ ] 审批时预览哪些学员会获得海报

3. **小程序端**
   - [ ] 显示课程签到要求（如：需签到3次）
   - [ ] 显示用户当前签到次数
   - [ ] 海报上显示实际签到次数

---

## 📊 测试建议

### 测试场景1：批量结课（部分达标）

1. 创建课程，设置签到要求：3次
2. 添加3个学员：
   - 学员A：签到4次
   - 学员B：签到3次
   - 学员C：签到2次
3. 教师发起结课申请
4. 教务审批通过
5. 验证：
   - [ ] 学员A、B标记为"已完成"
   - [ ] 学员C仍然是"进行中"
   - [ ] 学员A、B可以查看海报
   - [ ] 学员C看不到海报

### 测试场景2：教师手动发放

1. 接上面的场景，学员C签到2次（未达标）
2. 教师手动给学员C发放海报
3. 验证：
   - [ ] 学员C标记为"已完成"
   - [ ] 学员C可以查看海报
   - [ ] 海报显示签到2次

### 测试场景3：批量发放

1. 勾选多个未完成的学员
2. 批量发放海报
3. 验证：
   - [ ] 所有选中的学员都标记为"已完成"
   - [ ] 都可以查看海报

---

## ✅ 完成总结

**后端代码已100%完成！**

包含：
- ✅ 批量结课逻辑优化（只给符合条件的学员发放）
- ✅ 单独给学员发放海报
- ✅ 批量给学员发放海报
- ✅ 完整的API接口
- ✅ 权限控制
- ✅ 错误处理
- ✅ 日志记录

**下一步**：
- 前端实现管理后台的学员管理页面
- 添加"发放海报"操作按钮
- 显示签到次数统计
- 批量操作功能

详细的实现说明和API文档已整理在本文档中。









