# å­¦åˆ†ç³»ç»Ÿç®€åŒ–å®æ–½å®Œæˆ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“ Schema æ›´æ–° âœ…

**æ–‡ä»¶**: `backend/prisma/schema.prisma`

**ä¿®æ”¹å†…å®¹**:
```prisma
model Credit {
  balance             Int  @default(0)  // ç»Ÿä¸€å­¦åˆ†ä½™é¢
  total               Int  @default(0)  // ç´¯è®¡è·å¾—æ€»æ•°
  used                Int  @default(0)  // ç´¯è®¡æ¶ˆè€—æ€»æ•°
  
  transferableBalance Int  @default(0)  // å¯è½¬èµ å­¦åˆ†ä½™é¢
  lockedBalance       Int  @default(0)  // é”å®šå­¦åˆ†ä½™é¢ï¼ˆä¸å¯è½¬èµ ï¼‰
}
```

**å…³ç³»**: `balance = transferableBalance + lockedBalance`

### 2. æ•°æ®åº“è¿ç§»è„šæœ¬ âœ…

**æ–‡ä»¶**: `backend/prisma/migrations/20251116_simplify_credit_system.sql`

**ä¸»è¦æ­¥éª¤**:
1. æ·»åŠ  `transferableBalance` å’Œ `lockedBalance` å­—æ®µ
2. è¿ç§»ç°æœ‰æ•°æ®ï¼š
   - `balance` = åŸ `balance` + åŸ `corporateBalance`
   - `transferableBalance` = åŸ `balance`
   - `lockedBalance` = åŸ `corporateBalance`
3. æ•°æ®éªŒè¯
4. ç»Ÿè®¡ä¿¡æ¯

### 3. åç«¯æœåŠ¡æ›´æ–° âœ…

#### A. Credits Service (`backend/src/modules/credits/credits.service.ts`)

**âœ… consumeCredit** - æ¶ˆè€—å­¦åˆ†
- ä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼ˆä¼ä¸šåˆ†é…çš„ï¼‰
- ä¸è¶³æ—¶ä½¿ç”¨å¯è½¬èµ å­¦åˆ†
- ç»Ÿä¸€è®°å½•æ¶ˆè€—

```typescript
const lockedUsed = Math.min(credit.lockedBalance, amount);
const transferableUsed = amount - lockedUsed;
```

**âœ… addCredit** - å¢åŠ å­¦åˆ†
- æ–°å¢ `isLocked` å‚æ•°
- `isLocked=true`: å¢åŠ é”å®šå­¦åˆ†ï¼ˆä¼ä¸šåˆ†é…ï¼‰
- `isLocked=false`: å¢åŠ å¯è½¬èµ å­¦åˆ†ï¼ˆç®¡ç†å‘˜å……å€¼ã€è¯¾ç¨‹å¥–åŠ±ï¼‰

**âœ… refundCredit** - é€€å›å­¦åˆ†
- é€€å›åˆ°å¯è½¬èµ å­¦åˆ†ï¼ˆç®€åŒ–å¤„ç†ï¼‰

**âœ… deduct** - æ‰£é™¤å­¦åˆ†
- ä¼˜å…ˆæ‰£é™¤å¯è½¬èµ å­¦åˆ†
- ä¸è¶³æ—¶æ‰£é™¤é”å®šå­¦åˆ†

#### B. Corporate Credits Service (`backend/src/modules/corporate-credits/corporate-credits.service.ts`)

**âœ… allocateCredit** - ä¼ä¸šç®¡ç†å‘˜åˆ†é…å­¦åˆ†
- æ£€æŸ¥ç®¡ç†å‘˜çš„å¯è½¬èµ å­¦åˆ†ä½™é¢
- æ‰£é™¤ç®¡ç†å‘˜çš„å¯è½¬èµ å­¦åˆ†
- å¢åŠ å‘˜å·¥çš„é”å®šå­¦åˆ†ï¼ˆä¸å¯è½¬èµ ï¼‰
- è®°å½•ç±»å‹ï¼š`TRANSFER_OUT` â†’ `CORPORATE_ALLOCATE`

**âœ… getEmployees** - è·å–ä¼ä¸šå‘˜å·¥åˆ—è¡¨
- è¿”å›ç»Ÿä¸€ä½™é¢
- è¿”å›å¯è½¬èµ ä½™é¢
- è¿”å›é”å®šä½™é¢

#### C. Enrollments Service (`backend/src/modules/enrollments/enrollments.service.ts`)

**âœ… enroll** - æŠ¥åè¯¾ç¨‹
- æ£€æŸ¥ç»Ÿä¸€ä½™é¢æ˜¯å¦è¶³å¤Ÿ
- é”™è¯¯æç¤ºåŒ…å«ï¼šæ€»å­¦åˆ†ã€é”å®šå­¦åˆ†ã€å¯è½¬èµ å­¦åˆ†

### 4. å‰ç«¯æ›´æ–° âœ…

#### A. ä¸ªäººä¸­å¿ƒ (`frontend-uniapp/pages/mine/index.vue`)

**å­¦åˆ†æ˜¾ç¤ºä¼˜åŒ–**:
```vue
<!-- æ€»å­¦åˆ† -->
<view class="credit-item">
  <Icon name="star" color="#FFD700" />
  <text>{{ credits.balance }}</text>
  <text>æ€»å­¦åˆ†</text>
</view>

<!-- å¯è½¬èµ å­¦åˆ† -->
<view class="credit-item">
  <Icon name="user" color="#52C41A" />
  <text>{{ credits.transferableBalance }}</text>
  <text>å¯è½¬èµ </text>
</view>

<!-- é”å®šå­¦åˆ† -->
<view class="credit-item">
  <Icon name="work" color="#FF6B6B" />
  <text>{{ credits.lockedBalance }}</text>
  <text>é”å®šå­¦åˆ†</text>
  <text class="tip">ä»…å¯è´­è¯¾</text>
</view>
```

**æ ·å¼æ›´æ–°**:
- æ·»åŠ  `credit-tip` æ ·å¼
- é¢œè‰²è°ƒæ•´ï¼šå¯è½¬èµ ï¼ˆç»¿è‰²ï¼‰ã€é”å®šï¼ˆçº¢è‰²ï¼‰

### 5. å­¦åˆ†è®°å½•ç±»å‹æ›´æ–° âœ…

**æ–°å¢è®°å½•ç±»å‹**:
```prisma
enum CreditRecordType {
  EARN             // è·å¾—å­¦åˆ†ï¼ˆè¯¾ç¨‹å®Œæˆå¥–åŠ±ï¼‰
  CONSUME          // æ¶ˆè€—å­¦åˆ†ï¼ˆæŠ¥åè¯¾ç¨‹ï¼‰
  REFUND           // é€€å›å­¦åˆ†ï¼ˆé€€è¯¾ï¼‰
  ADMIN_ADD        // ç®¡ç†å‘˜å¢åŠ 
  ADMIN_DEDUCT     // ç®¡ç†å‘˜æ‰£é™¤
  CORPORATE_ALLOCATE  // ä¼ä¸šåˆ†é…ï¼ˆé”å®šå­¦åˆ†ï¼‰
  TRANSFER_OUT     // è½¬å‡ºå­¦åˆ†ï¼ˆèµ é€ï¼‰
  TRANSFER_IN      // è½¬å…¥å­¦åˆ†ï¼ˆæ¥æ”¶ï¼‰
}
```

## ğŸ“Š æ•°æ®ç»“æ„å¯¹æ¯”

### ä¿®æ”¹å‰
```
ç”¨æˆ·å­¦åˆ†è´¦æˆ·:
- balance: 100 (ä¸ªäººå­¦åˆ†)
- corporateBalance: 344 (ä¼ä¸šå­¦åˆ†)
- total: 100
- corporateTotal: 344

æ˜¾ç¤ºï¼šä¼ä¸šå­¦åˆ† 344 | ä¸ªäººå­¦åˆ† 100
```

### ä¿®æ”¹å
```
ç”¨æˆ·å­¦åˆ†è´¦æˆ·:
- balance: 444 (æ€»å­¦åˆ†)
- transferableBalance: 100 (å¯è½¬èµ )
- lockedBalance: 344 (é”å®šï¼Œä¸å¯è½¬èµ )
- total: 444

æ˜¾ç¤ºï¼šæ€»å­¦åˆ† 444 | å¯è½¬èµ  100 | é”å®š 344
```

## ğŸ”„ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

**ä½¿ç”¨æ•°æ®åº“ç®¡ç†å·¥å…·æ‰§è¡Œ**:
```sql
-- æ–‡ä»¶ä½ç½®ï¼šbackend/prisma/migrations/20251116_simplify_credit_system.sql
```

**æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ**:
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨ MySQL å®¢æˆ·ç«¯
mysql -u root -p edp_db < backend/prisma/migrations/20251116_simplify_credit_system.sql

# æ–¹æ³•2ï¼šä½¿ç”¨ Prisma (éœ€è¦æƒé™)
cd backend
npx prisma db execute --file=./prisma/migrations/20251116_simplify_credit_system.sql --schema=./prisma/schema.prisma
```

### æ­¥éª¤ 2: é‡æ–°ç”Ÿæˆ Prisma Client

```bash
cd backend
npx prisma generate
```

### æ­¥éª¤ 3: é‡å¯åç«¯æœåŠ¡

```bash
npm run start:dev
```

### æ­¥éª¤ 4: åˆ·æ–°å‰ç«¯

- å°ç¨‹åºï¼šåœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ç‚¹å‡»"ç¼–è¯‘"
- ç®¡ç†åå°ï¼šåˆ·æ–°æµè§ˆå™¨

## ğŸ§ª æµ‹è¯•æ¸…å•

### 1. å­¦åˆ†æ˜¾ç¤ºæµ‹è¯• âœ“
- [ ] ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºï¼šæ€»å­¦åˆ†ã€å¯è½¬èµ ã€é”å®šå­¦åˆ†
- [ ] æ•°å­—æ­£ç¡®ï¼š`balance = transferableBalance + lockedBalance`

### 2. æŠ¥åè¯¾ç¨‹æµ‹è¯• âœ“
- [ ] æœ‰è¶³å¤Ÿé”å®šå­¦åˆ†ï¼šä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†
- [ ] é”å®šå­¦åˆ†ä¸è¶³ï¼šä½¿ç”¨é”å®šå­¦åˆ† + å¯è½¬èµ å­¦åˆ†
- [ ] å­¦åˆ†ä¸è¶³ï¼šæ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æç¤º

### 3. ä¼ä¸šç®¡ç†å‘˜åˆ†é…æµ‹è¯• âœ“
- [ ] æ£€æŸ¥ç®¡ç†å‘˜çš„å¯è½¬èµ å­¦åˆ†ä½™é¢
- [ ] æ‰£é™¤ç®¡ç†å‘˜çš„å¯è½¬èµ å­¦åˆ†
- [ ] å¢åŠ å‘˜å·¥çš„é”å®šå­¦åˆ†
- [ ] å‘˜å·¥æ— æ³•è½¬èµ é”å®šå­¦åˆ†

### 4. é€€è¯¾æµ‹è¯• âœ“
- [ ] é€€å›å­¦åˆ†åˆ°å¯è½¬èµ ä½™é¢
- [ ] å­¦åˆ†æ•°å­—æ­£ç¡®

### 5. ç®¡ç†å‘˜æ“ä½œæµ‹è¯• âœ“
- [ ] å……å€¼å­¦åˆ†ï¼ˆå¢åŠ å¯è½¬èµ å­¦åˆ†ï¼‰
- [ ] æ‰£é™¤å­¦åˆ†ï¼ˆä¼˜å…ˆæ‰£é™¤å¯è½¬èµ ï¼‰

## ğŸ’¡ æ ¸å¿ƒé€»è¾‘è¯´æ˜

### å­¦åˆ†æ¶ˆè´¹ä¼˜å…ˆçº§

```
æŠ¥åè¯¾ç¨‹éœ€è¦ 5 å­¦åˆ†

ç”¨æˆ·å­¦åˆ†ï¼š
- é”å®šå­¦åˆ†ï¼š3
- å¯è½¬èµ å­¦åˆ†ï¼š7
- æ€»å­¦åˆ†ï¼š10

æ‰£é™¤æ–¹æ¡ˆï¼š
1. ä¼˜å…ˆä½¿ç”¨é”å®šå­¦åˆ†ï¼š3
2. ä¸è¶³éƒ¨åˆ†ä½¿ç”¨å¯è½¬èµ å­¦åˆ†ï¼š2
3. æ€»æ¶ˆè€—ï¼š5

å‰©ä½™ï¼š
- é”å®šå­¦åˆ†ï¼š0
- å¯è½¬èµ å­¦åˆ†ï¼š5
- æ€»å­¦åˆ†ï¼š5
```

### ä¼ä¸šç®¡ç†å‘˜åˆ†é…

```
ç®¡ç†å‘˜åˆ†é… 10 å­¦åˆ†ç»™å‘˜å·¥ï¼š

ç®¡ç†å‘˜è´¦æˆ·å˜åŒ–ï¼š
- å¯è½¬èµ å­¦åˆ†ï¼š100 â†’ 90 (å‡å°‘ 10)
- æ€»å­¦åˆ†ï¼š100 â†’ 90

å‘˜å·¥è´¦æˆ·å˜åŒ–ï¼š
- é”å®šå­¦åˆ†ï¼š0 â†’ 10 (å¢åŠ  10)
- æ€»å­¦åˆ†ï¼š50 â†’ 60

ç‰¹æ€§ï¼š
âœ… å‘˜å·¥åªèƒ½ç”¨è¿™ 10 å­¦åˆ†è´­ä¹°è¯¾ç¨‹
âŒ å‘˜å·¥ä¸èƒ½è½¬èµ è¿™ 10 å­¦åˆ†ç»™ä»–äºº
```

### å­¦åˆ†è½¬èµ ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

```
ç”¨æˆ·Aè½¬èµ  5 å­¦åˆ†ç»™ç”¨æˆ·Bï¼š

ç”¨æˆ·Aï¼š
- å¯è½¬èµ å­¦åˆ†ï¼š20 â†’ 15
- é”å®šå­¦åˆ†ï¼š10 (ä¸å˜ï¼Œä¸èƒ½è½¬èµ )
- æ€»å­¦åˆ†ï¼š30 â†’ 25

ç”¨æˆ·Bï¼š
- å¯è½¬èµ å­¦åˆ†ï¼š5 â†’ 10 (æ¥æ”¶çš„å­¦åˆ†ä¹Ÿæ˜¯å¯è½¬èµ çš„)
- æ€»å­¦åˆ†ï¼š15 â†’ 20

é™åˆ¶ï¼š
âœ… åªèƒ½è½¬èµ å¯è½¬èµ å­¦åˆ†
âŒ ä¸èƒ½è½¬èµ é”å®šå­¦åˆ†
```

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

1. **ç”¨æˆ·ä½“éªŒç®€åŒ–** âœ…
   - åªçœ‹åˆ°ä¸€ä¸ªæ€»å­¦åˆ†æ•°å­—
   - æ¸…æ™°åŒºåˆ†å¯è½¬èµ å’Œé”å®šå­¦åˆ†

2. **çµæ´»çš„å­¦åˆ†æ§åˆ¶** âœ…
   - ä¼ä¸šåˆ†é…çš„å­¦åˆ†ä¸å¯è½¬èµ ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰
   - ä¸ªäººå­¦åˆ†å¯ä»¥è‡ªç”±ä½¿ç”¨

3. **æ¶ˆè´¹ä¼˜å…ˆçº§åˆç†** âœ…
   - ä¼˜å…ˆæ¶ˆè€—é”å®šå­¦åˆ†
   - é¼“åŠ±ä½¿ç”¨ä¼ä¸šåˆ†é…çš„å­¦åˆ†

4. **æ•°æ®è¿½æº¯å®Œæ•´** âœ…
   - é€šè¿‡ `CreditRecord` è®°å½•æ¯ç¬”å­¦åˆ†çš„æ¥æº
   - åŒºåˆ† `PERSONAL` å’Œ `CORPORATE` æ¥æº

5. **æ‰©å±•æ€§å¼º** âœ…
   - æœªæ¥å¯ä»¥è½»æ¾æ·»åŠ å…¶ä»–å­¦åˆ†ç±»å‹
   - å¦‚ï¼šç§¯åˆ†ã€åˆ¸ã€æ—¶é—´å­¦åˆ†ç­‰

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šæ‰§è¡Œè¿ç§»å‰ï¼Œå»ºè®®å¤‡ä»½ `credits` è¡¨
2. **åˆ†æ­¥æ‰§è¡Œ**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œå†åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ
3. **ä¿ç•™æ—§å­—æ®µ**ï¼šæš‚æ—¶ä¿ç•™ `corporateBalance` ç­‰å­—æ®µï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´åå†åˆ é™¤
4. **ä»£ç åŒæ­¥**ï¼šç¡®ä¿åç«¯å’Œå‰ç«¯ä»£ç åŒæ—¶æ›´æ–°
5. **ç”¨æˆ·é€šçŸ¥**ï¼šå»ºè®®å‘å¸ƒå…¬å‘Šï¼Œå‘ŠçŸ¥ç”¨æˆ·å­¦åˆ†ç³»ç»Ÿçš„å˜åŒ–

## ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… æ•°æ®åº“è¿ç§»
2. âœ… åç«¯ä»£ç æ›´æ–°
3. âœ… å‰ç«¯ä»£ç æ›´æ–°
4. â³ æµ‹è¯•éªŒè¯
5. â³ éƒ¨ç½²ä¸Šçº¿
6. â³ ç›‘æ§æ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `å­¦åˆ†ç³»ç»Ÿç®€åŒ–æ–¹æ¡ˆ.md` - å®Œæ•´çš„æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ
- `backend/prisma/migrations/20251116_simplify_credit_system.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
- `backend/prisma/schema.prisma` - æ•°æ®åº“ Schema

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-16  
**çŠ¶æ€**: âœ… ä»£ç å·²æ›´æ–°ï¼Œç­‰å¾…æ•°æ®åº“è¿ç§»å’Œæµ‹è¯•éªŒè¯


